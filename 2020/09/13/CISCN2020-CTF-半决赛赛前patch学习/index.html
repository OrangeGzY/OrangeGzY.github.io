<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CISCN2020 CTF 半决赛赛前patch学习. | ScUpax0s</title><meta name="description" content="CISCN2020 CTF 半决赛赛前patch学习关于.eh_frame section.eh_frame section在网上有一种说法是用来在runtime保存一些描述Call Frame（调用帧？）的信息的，这些信息在异常处理时很有用。 When using languages that support exceptions, such as C++, additional informa"><meta name="author" content="Paxos"><meta name="copyright" content="Paxos"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="CISCN2020 CTF 半决赛赛前patch学习."><meta name="twitter:description" content="CISCN2020 CTF 半决赛赛前patch学习关于.eh_frame section.eh_frame section在网上有一种说法是用来在runtime保存一些描述Call Frame（调用帧？）的信息的，这些信息在异常处理时很有用。 When using languages that support exceptions, such as C++, additional informa"><meta name="twitter:image" content="https://orangegzy.github.io/img/13weqw.jpg"><meta property="og:type" content="article"><meta property="og:title" content="CISCN2020 CTF 半决赛赛前patch学习."><meta property="og:url" content="http://yoursite.com/2020/09/13/CISCN2020-CTF-%E5%8D%8A%E5%86%B3%E8%B5%9B%E8%B5%9B%E5%89%8Dpatch%E5%AD%A6%E4%B9%A0/"><meta property="og:site_name" content="ScUpax0s"><meta property="og:description" content="CISCN2020 CTF 半决赛赛前patch学习关于.eh_frame section.eh_frame section在网上有一种说法是用来在runtime保存一些描述Call Frame（调用帧？）的信息的，这些信息在异常处理时很有用。 When using languages that support exceptions, such as C++, additional informa"><meta property="og:image" content="https://orangegzy.github.io/img/13weqw.jpg"><meta property="article:published_time" content="2020-09-13T14:41:47.000Z"><meta property="article:modified_time" content="2020-09-13T14:43:11.308Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/09/13/CISCN2020-CTF-%E5%8D%8A%E5%86%B3%E8%B5%9B%E8%B5%9B%E5%89%8Dpatch%E5%AD%A6%E4%B9%A0/"><link rel="prev" title="hitcon_ctf_2019_one_punch" href="http://yoursite.com/2020/09/17/hitcon-ctf-2019-one-punch/"><link rel="next" title="rctf2018_rnote4（no relro下劫持str tab执行任意函数）" href="http://yoursite.com/2020/09/13/rctf2018-rnote4%EF%BC%88no-relro%E4%B8%8B%E5%8A%AB%E6%8C%81str-tab%E6%89%A7%E8%A1%8C%E4%BB%BB%E6%84%8F%E5%87%BD%E6%95%B0%EF%BC%89/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://s1.ax1x.com/2020/06/15/N9ZTBV.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">63</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-diamond" aria-hidden="true"></i><span> Life</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> talk</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CISCN2020-CTF-半决赛赛前patch学习"><span class="toc-number">1.</span> <span class="toc-text">CISCN2020 CTF 半决赛赛前patch学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#关于-eh-frame-section"><span class="toc-number">1.1.</span> <span class="toc-text">关于.eh_frame section</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于lief（啊哈，最后我没用这个）"><span class="toc-number">1.2.</span> <span class="toc-text">关于lief（啊哈，最后我没用这个）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#patch过程与注意事项"><span class="toc-number">1.3.</span> <span class="toc-text">patch过程与注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#patch完之后按c键将数据转成代码（汇编显示），这个时候可能在patch的尾部发生一些代码混乱，手动调整即可。"><span class="toc-number">1.3.1.</span> <span class="toc-text">patch完之后按c键将数据转成代码（汇编显示），这个时候可能在patch的尾部发生一些代码混乱，手动调整即可。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#然后就可以正常反汇编了（大概是这么个感觉，我后面还微调了一下）"><span class="toc-number">1.3.2.</span> <span class="toc-text">然后就可以正常反汇编了（大概是这么个感觉，我后面还微调了一下）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#这是patch之后的效果，对比一下patch之前："><span class="toc-number">1.3.3.</span> <span class="toc-text">这是patch之后的效果，对比一下patch之前：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fix效果"><span class="toc-number">1.4.</span> <span class="toc-text">fix效果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#可以看到，通过我们的patch，UAF已经被打掉了，此时bss段中table里chunk-info的指针已经被清零了。"><span class="toc-number">1.4.1.</span> <span class="toc-text">可以看到，通过我们的patch，UAF已经被打掉了，此时bss段中table里chunk_info的指针已经被清零了。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#我们的fix已经成功了！！"><span class="toc-number">1.4.2.</span> <span class="toc-text">我们的fix已经成功了！！</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#最后微调了一下前两行大概是这个效果"><span class="toc-number">1.4.3.</span> <span class="toc-text">最后微调了一下前两行大概是这个效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#后记"><span class="toc-number">2.</span> <span class="toc-text">后记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">3.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://orangegzy.github.io/img/13weqw.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">ScUpax0s</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-diamond" aria-hidden="true"></i><span> Life</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> talk</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">CISCN2020 CTF 半决赛赛前patch学习.</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-09-13 22:41:47"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-09-13</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-09-13 22:43:11"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-09-13</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%F0%9F%93%92/">学习笔记📒</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>Comments:</span><span class="disqus-comment-count comment-count"><a href="http://yoursite.com/2020/09/13/CISCN2020-CTF-%E5%8D%8A%E5%86%B3%E8%B5%9B%E8%B5%9B%E5%89%8Dpatch%E5%AD%A6%E4%B9%A0/#disqus_thread"></a></span></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="CISCN2020-CTF-半决赛赛前patch学习"><a href="#CISCN2020-CTF-半决赛赛前patch学习" class="headerlink" title="CISCN2020 CTF 半决赛赛前patch学习"></a>CISCN2020 CTF 半决赛赛前patch学习</h1><h2 id="关于-eh-frame-section"><a href="#关于-eh-frame-section" class="headerlink" title="关于.eh_frame section"></a>关于.eh_frame section</h2><p>.eh_frame section在网上有一种说法是用来在runtime保存一些描述Call Frame（调用帧？）的信息的，这些信息在异常处理时很有用。</p>
<p><em>When using languages that support exceptions, such as C++, additional information must be provided to the runtime environment that describes the call frames that much be unwound during the processing of an exception. This information is contained in the special sections .eh_frame and .eh_framehdr.</em></p>
<p>但是实际上你会发现，即使是在c这种没有异常处理的语言中，编译出来的也会有.eh_frame section。</p>
<p>stack over flow上有一个比较好的解释：</p>
<p><em>x86-64 ABI mandates <code>.eh_frames</code> everywhere exact. This was added to allow unwinding of stack everywhere as this is needed system wide in some occasions, like in profiling tools. GCC thus on x86_64 defaults to EH frame generation and attempts to make it everywhere exact, while on most of other ABIs it defaults to EH frame generation only when EH frame is needed and it is precise only at the points of program that might trigger EH and thus unwinding</em></p>
<p>实际上就是x86的ABI要求的，<strong>用来做任意位置的堆栈展开</strong>，包括在一些分析工具中。举个例子，你在gdb里bt的时候我猜就用到了这玩意。。。</p>
<p><a href="https://stackoverflow.com/questions/26300819/why-gcc-compiled-c-program-needs-eh-frame-section#answer-26302715" target="_blank" rel="noopener">Something about .eh_frame</a></p>
<p>当然添加这玩意会让 <em><code>.text</code></em> 的大小增加%15-%30。</p>
<p>接下来我们在runtime看一下<em><code>.eh_frame</code></em></p>
<p><img src="https://s1.ax1x.com/2020/09/13/w0uLTK.png" alt></p>
<p><strong>可以看到在程序里，他自带可执行权限，那么如果我们把patch的放到这里，首先我们没有附加任何东西，所以对程序的大小影响不大，其次他自带可执行权限，非常方便</strong></p>
<h2 id="关于lief（啊哈，最后我没用这个）"><a href="#关于lief（啊哈，最后我没用这个）" class="headerlink" title="关于lief（啊哈，最后我没用这个）"></a>关于lief（啊哈，最后我没用这个）</h2><p>官方文档：<a href="https://lief.quarkslab.com/doc/latest/getting_started.html" target="_blank" rel="noopener">https://lief.quarkslab.com/doc/latest/getting_started.html</a></p>
<p><em>The purpose of this project is to provide a cross platform library which can parse, modify and abstract <code>ELF</code>, <code>PE</code>, <code>MachO</code> and Android formats.</em></p>
<p>用来解析，修改patch不同格式/平台的文件非常方便。</p>
<h2 id="patch过程与注意事项"><a href="#patch过程与注意事项" class="headerlink" title="patch过程与注意事项"></a>patch过程与注意事项</h2><p><strong>原始状态：</strong></p>
<p><img src="https://s1.ax1x.com/2020/09/13/w0xE9O.png" alt></p>
<p>我们先找到patch的位置，我选在.eh_frame上：</p>
<p><img src="https://s1.ax1x.com/2020/09/13/w0xNuj.png" alt></p>
<p>然后就是写patch的汇编：（<strong>其实这里不难，对着源程序往上怼着改就行</strong>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mov eax, offset notelist;</span><br><span class="line">mov     edx, [ebp-12];</span><br><span class="line">mov     eax, [eax+edx*4];</span><br><span class="line">test    eax, eax;			;这里是  if ( notelist[index] )</span><br><span class="line">jz      0x8048890;</span><br><span class="line">mov     eax, offset notelist;</span><br><span class="line">mov     edx, [ebp-12];</span><br><span class="line">mov     eax, [eax+edx*4];</span><br><span class="line">sub     esp, 0Ch;</span><br><span class="line">push    eax;</span><br><span class="line">call    0x8048470;			;free(*((void **)notelist[v2] + 1))</span><br><span class="line">;patch to fix UAF</span><br><span class="line">add     esp, 10h;</span><br><span class="line">mov    ecx, 0;</span><br><span class="line">mov    ds:notelist[4*edx], ecx;</span><br><span class="line">;patch to fix UAF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add     esp, 10h;</span><br><span class="line">mov     eax, offset notelist;</span><br><span class="line">mov     edx, [ebp-12];</span><br><span class="line">mov     eax, [eax+edx*4];</span><br><span class="line">sub     esp, 0Ch;</span><br><span class="line">push    eax;</span><br><span class="line">call    0x8048470;		;free((void *)notelist[index])</span><br><span class="line"></span><br><span class="line">;patch to fix UAF</span><br><span class="line">mov    ecx, 0;</span><br><span class="line">mov    ds:notelist[4*edx], ecx;		;notelist[v1] &#x3D; 0;</span><br><span class="line">;patch to fix UAF</span><br><span class="line"></span><br><span class="line">jmp     0x8048894;           ;最后jmp回原函数leave；ret的地方</span><br></pre></td></tr></table></figure>

<p>这里注意几点：</p>
<ul>
<li>每次key patch的时候可以先勾选一行，然后patch</li>
</ul>
<p><img src="https://s1.ax1x.com/2020/09/13/w0zFqs.png" alt></p>
<h3 id="patch完之后按c键将数据转成代码（汇编显示），这个时候可能在patch的尾部发生一些代码混乱，手动调整即可。"><a href="#patch完之后按c键将数据转成代码（汇编显示），这个时候可能在patch的尾部发生一些代码混乱，手动调整即可。" class="headerlink" title="patch完之后按c键将数据转成代码（汇编显示），这个时候可能在patch的尾部发生一些代码混乱，手动调整即可。"></a>patch完之后按c键将数据转成代码（汇编显示），这个时候可能在patch的尾部发生一些代码混乱，手动调整即可。</h3><ul>
<li><strong>修改从if开始整个的程序流：</strong></li>
</ul>
<p>原：</p>
<p><img src="https://s1.ax1x.com/2020/09/13/w0zcJf.png" alt></p>
<p>现：</p>
<p><img src="https://s1.ax1x.com/2020/09/13/w0zIwn.png" alt></p>
<p><em>*可以看到这里直接一个大跳转把执行流拉向</em>.eh_frame<em>上我们patch的内容 *</em></p>
<ul>
<li><strong>注意patch完之后，要把执行流拉回来</strong></li>
</ul>
<p><img src="https://s1.ax1x.com/2020/09/13/wBSklD.png" alt></p>
<p><strong>可以看到其实就是拉回leave；ret</strong></p>
<p><img src="https://s1.ax1x.com/2020/09/13/wBSEOH.png" alt></p>
<ul>
<li><strong>在扭转执行流的时候可能出现sp分析错误</strong></li>
</ul>
<p>我这里是当我在fix完uaf后，重新把执行流拉回原函数的时候出现了sp分析错误（leave；ret）的时候</p>
<p><img src="https://s1.ax1x.com/2020/09/13/wBSlp8.png" alt></p>
<p>那么这个时候 <strong>把鼠标放到他的上一条指令，就是leave那条指令上</strong></p>
<p>然后 <strong><code>alt+k</code></strong> </p>
<p><img src="https://s1.ax1x.com/2020/09/13/wBSdhV.png" alt></p>
<h3 id="然后就可以正常反汇编了（大概是这么个感觉，我后面还微调了一下）"><a href="#然后就可以正常反汇编了（大概是这么个感觉，我后面还微调了一下）" class="headerlink" title="然后就可以正常反汇编了（大概是这么个感觉，我后面还微调了一下）"></a>然后就可以正常反汇编了（大概是这么个感觉，我后面还微调了一下）</h3><p><img src="https://s1.ax1x.com/2020/09/13/wBiuz6.png" alt></p>
<h3 id="这是patch之后的效果，对比一下patch之前："><a href="#这是patch之后的效果，对比一下patch之前：" class="headerlink" title="这是patch之后的效果，对比一下patch之前："></a>这是patch之后的效果，对比一下patch之前：</h3><p><img src="https://s1.ax1x.com/2020/09/13/wBilLD.png" alt></p>
<h2 id="fix效果"><a href="#fix效果" class="headerlink" title="fix效果"></a>fix效果</h2><ol>
<li>free前的一瞬</li>
</ol>
<p><img src="https://s1.ax1x.com/2020/09/13/wBPgKO.png" alt></p>
<ol start="2">
<li>free之后</li>
</ol>
<p><img src="https://s1.ax1x.com/2020/09/13/wBP4IA.png" alt></p>
<p>可以看到chunk_info结构体确实被free出去了</p>
<ol start="3">
<li><strong>UAF patch</strong></li>
</ol>
<p><img src="https://s1.ax1x.com/2020/09/13/wBPTRP.png" alt></p>
<h3 id="可以看到，通过我们的patch，UAF已经被打掉了，此时bss段中table里chunk-info的指针已经被清零了。"><a href="#可以看到，通过我们的patch，UAF已经被打掉了，此时bss段中table里chunk-info的指针已经被清零了。" class="headerlink" title="可以看到，通过我们的patch，UAF已经被打掉了，此时bss段中table里chunk_info的指针已经被清零了。"></a>可以看到，通过我们的patch，UAF已经被打掉了，此时bss段中table里chunk_info的指针已经被清零了。</h3><h3 id="我们的fix已经成功了！！"><a href="#我们的fix已经成功了！！" class="headerlink" title="我们的fix已经成功了！！"></a>我们的fix已经成功了！！</h3><h3 id="最后微调了一下前两行大概是这个效果"><a href="#最后微调了一下前两行大概是这个效果" class="headerlink" title="最后微调了一下前两行大概是这个效果"></a>最后微调了一下前两行大概是这个效果</h3><p><img src="https://s1.ax1x.com/2020/09/13/wBkTR1.png" alt></p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>这个题是fix成功了，但是在运行的时候我发现我犯了个啥b错误。。</p>
<p>由于这个题我拉下来没细看，这个题实际上利用的存储方式是：bss_table –&gt; chunk_info –&gt; chunk</p>
<p>那么当我们把bss_table中的chunk_info指针的UAF给打掉了之后，那么当我们再次通过chunk_info去free他的真正的chunk的时候。。就free不掉了。。因为此时的UAF已经被打掉了。chunk_info地址已经被清空了，所以 free会崩掉。</p>
<p>不过这样看起来实际FIX起来更简单，就是说我们保留下他free的两条语句，然后，只需要在这之后patch掉bss_chunk_table的UAF就行了，根本不需要patch他chunk info里的UAF。。因为所有的chunk寻找都是基于bss_chunk_table的。。那么这样看来我patch复杂了。不过也就相当于练习了。并且确实是patch掉了。</p>
<p><strong>过几天再练一道orz</strong></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://refspecs.linuxfoundation.org/LSB_3.0.0/LSB-Core-generic/LSB-Core-generic/ehframechpt.html" target="_blank" rel="noopener">https://refspecs.linuxfoundation.org/LSB_3.0.0/LSB-Core-generic/LSB-Core-generic/ehframechpt.html</a></p>
<p><a href="https://www.cnblogs.com/echo579/p/6236277.html" target="_blank" rel="noopener">https://www.cnblogs.com/echo579/p/6236277.html</a></p>
<p><a href="https://blog.csdn.net/u012206617/article/details/87790857" target="_blank" rel="noopener">https://blog.csdn.net/u012206617/article/details/87790857</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Paxos</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/09/13/CISCN2020-CTF-%E5%8D%8A%E5%86%B3%E8%B5%9B%E8%B5%9B%E5%89%8Dpatch%E5%AD%A6%E4%B9%A0/">http://yoursite.com/2020/09/13/CISCN2020-CTF-%E5%8D%8A%E5%86%B3%E8%B5%9B%E8%B5%9B%E5%89%8Dpatch%E5%AD%A6%E4%B9%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://s1.ax1x.com/2020/08/14/di8hDO.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/09/17/hitcon-ctf-2019-one-punch/"><img class="prev_cover" src="https://orangegzy.github.io/img/IMG_7311.JPG" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">hitcon_ctf_2019_one_punch</div></div></a></div><div class="next-post pull_right"><a href="/2020/09/13/rctf2018-rnote4%EF%BC%88no-relro%E4%B8%8B%E5%8A%AB%E6%8C%81str-tab%E6%89%A7%E8%A1%8C%E4%BB%BB%E6%84%8F%E5%87%BD%E6%95%B0%EF%BC%89/"><img class="next_cover" src="https://orangegzy.github.io/img/IMG_7131.PNG" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">rctf2018_rnote4（no relro下劫持str tab执行任意函数）</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> Comment</span></div><div id="disqus_thread"></div><script>var disqus_config = function () {
  this.page.url = 'http://yoursite.com/2020/09/13/CISCN2020-CTF-%E5%8D%8A%E5%86%B3%E8%B5%9B%E8%B5%9B%E5%89%8Dpatch%E5%AD%A6%E4%B9%A0/';
  this.page.identifier = '2020/09/13/CISCN2020-CTF-半决赛赛前patch学习/';
  this.page.title = 'CISCN2020 CTF 半决赛赛前patch学习.';
};
(function() { 
  var d = document, s = d.createElement('script');
  s.src = 'https://ScUpax0s.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script><script>function getDisqusCount() {
  var d = document, s = d.createElement('script');
  s.src = 'https://ScUpax0s.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
}

window.addEventListener('load', getDisqusCount, false);</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Paxos</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="Scroll to comment"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>